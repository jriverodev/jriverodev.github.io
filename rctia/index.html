<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCT Tycoon: Voz y Nombres IA</title>
    <style>
        body { 
            display: flex; flex-direction: column; align-items: center; 
            background: #1a1a1a; color: white; font-family: 'Courier New', Courier, monospace; 
            margin: 0; padding: 10px; touch-action: none; 
        }
        #header {
            width: 95vw; max-width: 450px; background: #222; padding: 10px; 
            border-radius: 8px; margin-bottom: 5px; border-bottom: 3px solid #f1c40f;
        }
        .stats-row { display: flex; justify-content: space-between; font-size: 14px; }
        #aiStatus { 
            background: #333; padding: 5px; font-size: 10px; color: #0f0; margin-top: 5px; border-radius: 3px; 
            display: flex; align-items: center; justify-content: space-between;
        }
        #aiStatus span { flex-grow: 1; }
        #speakerBtn { background: none; border: none; font-size: 18px; cursor: pointer; color: #0f0; }
        canvas { 
            border: 4px solid #3d3d3d; background: #2d7d32; 
            width: 95vw; height: 95vw; max-width: 450px; max-height: 450px;
            image-rendering: pixelated; 
        }
        .ui { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; 
            width: 95vw; max-width: 450px; margin-top: 10px; 
        }
        button { 
            padding: 8px 2px; font-size: 9px; border: none; cursor: pointer;
            border-radius: 4px; color: white; font-weight: bold; text-transform: uppercase;
        }
        .btn-mode { background: #444; }
        .active { background: #f1c40f !important; color: #000; }
        .btn-blue { background: #3498db; }
        .btn-green { background: #2ecc71; grid-column: span 3; padding: 12px; }
    </style>
</head>
<body>

    <div id="header">
        <div class="stats-row">
            <div>üí∞ <span id="moneyTxt">$500</span></div>
            <div>üòä <span id="happyTxt">100%</span></div>
        </div>
        <div id="aiStatus">
            <span id="aiAdviceText">ANALIZANDO PARQUE...</span>
            <button id="speakerBtn" onclick="toggleSpeaker()">üîä</button>
        </div>
    </div>

    <canvas id="gameCanvas" width="400" height="400"></canvas>

    <div class="ui">
        <button id="btnCamino" class="active" onclick="setMode('camino')">V√≠a (-$10)</button>
        <button id="btnAtraccion" onclick="setMode('atraccion')">üé° Feria (-$150)</button>
        <button id="btnComida" onclick="setMode('comida')">üçî Comida (-$80)</button>
        <button id="btnPapelera" onclick="setMode('papelera')">üóëÔ∏è Papelera (-$20)</button>
        <button id="btnBanco" onclick="setMode('banco')">üí∫ Banco (-$30)</button>
        <button class="btn-blue" onclick="hireStaff()">Limpiador üßπ (-$50)</button>
        <button class="btn-green" onclick="spawnPeeps(1)">Nuevo Peep üë§</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const TILE_SIZE = 40;
        const COLS = 10, ROWS = 10;

        let grid = Array(COLS).fill().map(() => Array(ROWS).fill(0));
        let trash = [], buildings = [], peeps = [], staff = [], floatingTexts = [];
        let wallet = 500, felicidad = 100, currentMode = 'camino';
        let speakerEnabled = true; // El altavoz est√° activado por defecto

        const firstNames = ["Juan", "Mar√≠a", "Pedro", "Ana", "Luis", "Sof√≠a", "Carlos", "Laura"];
        const lastNames = ["Garc√≠a", "L√≥pez", "Mart√≠nez", "Rodr√≠guez", "Fern√°ndez", "P√©rez", "Gonz√°lez", "S√°nchez"];

        // Motor de voz
        const synth = window.speechSynthesis;
        let speechVoice = null;
        synth.onvoiceschanged = () => {
            const voices = synth.getVoices();
            // Intenta encontrar una voz en espa√±ol
            speechVoice = voices.find(voice => voice.lang.startsWith('es')) || voices[0];
        };

        function speak(text) {
            if (!speakerEnabled || !synth) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = speechVoice;
            utterance.rate = 1.2; // Velocidad del habla
            synth.speak(utterance);
        }

        function toggleSpeaker() {
            speakerEnabled = !speakerEnabled;
            document.getElementById('speakerBtn').innerText = speakerEnabled ? 'üîä' : 'üîá';
        }

        // Cargar datos guardados
        if(localStorage.getItem('rct_save')) {
            let data = JSON.parse(localStorage.getItem('rct_save'));
            grid = data.grid;
            wallet = data.wallet;
            buildings = data.buildings;
            felicidad = data.felicidad;
        }

        function saveGame() {
            localStorage.setItem('rct_save', JSON.stringify({grid, wallet, buildings, felicidad}));
        }

        function setMode(mode) {
            currentMode = mode;
            const buttons = document.querySelectorAll('.ui button');
            buttons.forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
        }

        class Agent {
            constructor(x, y, isStaff = false) {
                this.gridX = x; this.gridY = y;
                this.pixelX = x * TILE_SIZE + TILE_SIZE/2;
                this.pixelY = y * TILE_SIZE + TILE_SIZE/2;
                this.targetGridX = x; this.targetGridY = y;
                this.isMoving = false;
                this.timer = 0;
                this.isStaff = isStaff;
                this.energy = 100;
                this.money = Math.floor(Math.random() * 60) + 20; // Dinero inicial del peep
                this.name = isStaff ? "Limpiador" : `${firstNames[Math.floor(Math.random()*firstNames.length)]} ${lastNames[Math.floor(Math.random()*lastNames.length)]}`;
                this.color = isStaff ? "#3498db" : `hsl(${Math.random()*360}, 70%, 50%)`;
                this.balloonColor = "#3498db";
                this.thought = "";
            }

            update() {
                if (this.timer > 0) {
                    this.timer--;
                    this.thought = ""; // Limpiar pensamiento mientras est√° ocupado
                } else if (!this.isMoving) {
                    this.inteligencia();
                } else {
                    this.mover();
                }
                this.dibujar();
            }

            inteligencia() {
                if (this.isStaff) {
                    // IA de Limpiador
                    let cleaned = false;
                    trash = trash.filter(t => {
                        if (t.x === this.gridX && t.y === this.gridY) {
                            addText(this.pixelX, this.pixelY, "‚ú®", "#fff");
                            felicidad = Math.min(100, felicidad + 2); 
                            this.timer = 20; cleaned = true;
                            return false;
                        }
                        return true;
                    });
                    if (cleaned) { updateUI(); return; } // Si limpi√≥, no se mueve este turno
                } else {
                    // IA de Visitante
                    this.energy -= 0.1;
                    this.thought = "";
                    let acted = false;

                    // Prioridades del Peep
                    if (this.energy < 30) {
                        const bank = buildings.find(b => b.type === 'üí∫' && Math.abs(this.gridX - b.x) <= 1 && Math.abs(this.gridY - b.y) <= 1);
                        if (bank) { this.energy = Math.min(100, this.energy + 30); this.timer = 40; this.thought = "¬°Qu√© buen descanso!"; acted = true; }
                    }

                    buildings.forEach(b => {
                        if (Math.abs(this.gridX - b.x) <= 1 && Math.abs(this.gridY - b.y) <= 1) {
                            if (b.type === 'üé°' && this.money >= 10 && Math.random() > 0.95 && !acted) { 
                                this.timer = 80; this.money -= 10; wallet += 10; felicidad = Math.min(100, felicidad + 5);
                                this.balloonColor = "#2ecc71"; // Feliz
                                if(Math.random() > 0.6) trash.push({x:this.gridX, y:this.gridY, type:'ü§Æ'});
                                this.thought = "¬°Qu√© divertida!"; acted = true;
                            } else if (b.type === 'üçî' && this.money >= 5 && Math.random() > 0.9 && !acted) {
                                this.timer = 40; this.money -= 5; wallet += 5;
                                this.balloonColor = "#e67e22"; // Comiendo
                                if(Math.random() > 0.4) trash.push({x:this.gridX, y:this.gridY, type:'ü•§'});
                                this.thought = "¬°Rico!"; acted = true;
                            } else if (b.type === 'üóëÔ∏è' && !acted && trash.some(t => t.x === this.gridX && t.y === this.gridY)) {
                                // Peep tira basura en la papelera (se implementar√° cuando los peeps tiren basura)
                                acted = true;
                            }
                        }
                    });

                    // Si tiene poca energ√≠a y no hay bancos cerca, se queja
                    if(this.energy < 10 && !acted) this.thought = "¬°Estoy cansado!";

                    // Comportamiento de tirar basura (si no hay papelera cerca)
                    let hasTrashBinNear = buildings.some(b => b.type === 'üóëÔ∏è' && Math.abs(this.gridX - b.x) <= 1 && Math.abs(this.gridY - b.y) <= 1);
                    if(Math.random() > 0.99 && !hasTrashBinNear) { 
                        trash.push({x:this.gridX, y:this.gridY, type:'ü•§'}); 
                        this.thought = "¬°Qu√© sucio est√° esto!";
                    }

                }
                
                // Moverse
                const dirs = [{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].sort(()=>Math.random()-0.5);
                for (let d of dirs) {
                    let nX = this.gridX + d.x, nY = this.gridY + d.y;
                    if (nX >= 0 && nX < COLS && nY >= 0 && nY < ROWS && grid[nX][nY] === 1) {
                        this.targetGridX = nX; this.targetGridY = nY;
                        this.isMoving = true; break;
                    }
                }
            }

            mover() {
                const destX = this.targetGridX * TILE_SIZE + TILE_SIZE/2;
                const destY = this.targetGridY * TILE_SIZE + TILE_SIZE/2;
                this.pixelX += (destX - this.pixelX) * 0.1;
                this.pixelY += (destY - this.pixelY) * 0.1;
                if (Math.abs(destX - this.pixelX) < 1) {
                    this.gridX = this.targetGridX; this.gridY = this.targetGridY;
                    this.isMoving = false;
                }
            }

            dibujar() {
                ctx.save(); ctx.translate(this.pixelX, this.pixelY);
                
                // Dibujar globo y hilo
                ctx.strokeStyle = "white"; ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(0,-25); ctx.stroke();
                ctx.fillStyle = this.balloonColor; ctx.beginPath(); ctx.arc(0,-32,7,0,Math.PI*2); ctx.fill();

                // Dibujar Peep o Staff
                ctx.fillStyle = this.color; ctx.fillRect(-6,-4,12,10);
                ctx.fillStyle = "#ffdbac"; ctx.fillRect(-5,-12,10,8);
                
                // Barra de Energ√≠a (solo para peeps)
                if (!this.isStaff) {
                    ctx.fillStyle = "red"; ctx.fillRect(-5, -20, 10, 2);
                    ctx.fillStyle = "green"; ctx.fillRect(-5, -20, (this.energy/100) * 10, 2);
                }

                // Dibujar el pensamiento del Peep
                if (this.thought) {
                    ctx.fillStyle = "white"; ctx.font = "8px Arial";
                    ctx.fillText(this.thought, -20, -45);
                }

                ctx.restore();
            }
        }

        // --- Funciones del juego ---
        function getPaths() {
            let p = [];
            for(let x=0; x<COLS; x++) for(let y=0; y<ROWS; y++) if(grid[x][y] === 1) p.push({x,y});
            return p;
        }

        function addText(x, y, val, color) { floatingTexts.push({x, y, val, color, life: 60}); }

        function handleInput(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = Math.floor(((clientX - rect.left) * (400/rect.width)) / TILE_SIZE);
            const y = Math.floor(((clientY - rect.top) * (400/rect.height)) / TILE_SIZE);
            
            if (x < 0 || x >= COLS || y < 0 || y >= ROWS) return; // Fuera de l√≠mites

            let cost = 0;
            let type = '';
            
            if(currentMode === 'camino') { cost = 10; if(grid[x][y] === 1) return; grid[x][y] = 1; }
            else if(currentMode === 'atraccion') { cost = 150; type = 'üé°'; }
            else if(currentMode === 'comida') { cost = 80; type = 'üçî'; }
            else if(currentMode === 'papelera') { cost = 20; type = 'üóëÔ∏è'; }
            else if(currentMode === 'banco') { cost = 30; type = 'üí∫'; }

            if(wallet >= cost) { 
                if(type) buildings.push({x, y, type});
                wallet -= cost; 
            } else {
                speak("¬°No tienes suficiente dinero para eso!");
            }
            saveGame();
            updateUI();
        }

        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); });

        function updateUI() {
            document.getElementById('moneyTxt').innerText = `$${Math.floor(wallet)}`;
            document.getElementById('happyTxt').innerText = `${Math.floor(felicidad)}%`;
        }

        let aiLastAdvice = "";
        function updateAIAdvice() {
            let currentAdvice = "";
            let numTrash = trash.length;
            let numTiredPeeps = peeps.filter(p => p.energy < 30).length;
            let numHungryPeeps = 0; // Aqu√≠ ir√≠a si tuvi√©ramos un sistema de hambre expl√≠cito
            let numNoAttractions = buildings.filter(b => b.type === 'üé°').length === 0;

            if (numTrash > 5) { currentAdvice = "¬°Demasiada basura! Contrata limpiadores."; }
            else if (numTiredPeeps > 3) { currentAdvice = "Muchos visitantes est√°n cansados. Pon m√°s bancos."; }
            else if (numNoAttractions && peeps.length > 0) { currentAdvice = "¬°Construye atracciones para tus visitantes!"; }
            else { currentAdvice = "El parque funciona correctamente."; }

            document.getElementById('aiAdviceText').innerText = `IA: ${currentAdvice}`;
            if (currentAdvice !== aiLastAdvice) {
                speak(currentAdvice);
                aiLastAdvice = currentAdvice;
            }
        }

        setInterval(updateAIAdvice, 8000); // La IA da consejos cada 8 segundos

        function hireStaff() { 
            if(wallet >= 50) { wallet -= 50; staff.push(new Agent(0,0,true)); speak("Limpiador contratado."); }
            else { speak("No tienes dinero para contratar un limpiador."); }
            saveGame(); updateUI();
        }
        function spawnPeeps(amount) { 
            for(let i=0; i<amount; i++) peeps.push(new Agent(0,0,false)); 
            speak(`¬°Han llegado ${amount} nuevos visitantes!`);
            saveGame(); updateUI();
        }

        function loop() {
            felicidad = Math.max(0, 100 - (trash.length * 5)); // La basura baja la felicidad
            if (felicidad < 10 && wallet > 0) { wallet -= 0.1; } // Multa por baja felicidad
            
            ctx.clearRect(0, 0, 400, 400);
            ctx.fillStyle = "#2d7d32"; ctx.fillRect(0,0,400,400);
            for (let x = 0; x < COLS; x++) {
                for (let y = 0; y < ROWS; y++) {
                    if (grid[x][y] === 1) { ctx.fillStyle = "#7a7a7a"; ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE); }
                }
            }
            trash.forEach(t => { ctx.font = "16px Arial"; ctx.fillText(t.type, t.x * TILE_SIZE + 10, t.y * TILE_SIZE + 25); });
            buildings.forEach(b => { ctx.font = "20px Arial"; ctx.fillText(b.type, b.x * TILE_SIZE + 10, b.y * TILE_SIZE + 30); });
            peeps.forEach(p => p.update());
            staff.forEach(s => s.update());
            floatingTexts.forEach((t, i) => {
                ctx.fillStyle = t.color; ctx.globalAlpha = t.life/60;
                ctx.fillText(t.val, t.x, t.y - (60-t.life));
                t.life--; if(t.life <= 0) floatingTexts.splice(i, 1);
            });
            ctx.globalAlpha = 1;
            updateUI();
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>
