<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RCT Ultra Pro: High Density</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: sans-serif; }
        #hud { position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none; }
        .panel { background: rgba(0,0,0,0.8); padding: 8px 15px; border-radius: 5px; border-left: 4px solid #f1c40f; color: #0f0; margin-bottom: 5px; font-weight: bold; }
        canvas { image-rendering: pixelated; width: 100vw; height: 100vh; }
        .menu { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; background: #333; padding: 10px; border-radius: 12px; border: 2px solid #555; }
        .btn { width: 45px; height: 45px; background: #555; border: 2px solid #fff; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .btn.active { background: #f1c40f; border-color: #000; }
    </style>
</head>
<body>

<div id="hud">
    <div class="panel">Caja: $<span id="mText">1000</span></div>
    <div class="panel">Agentes: <span id="pText">0</span></div>
</div>

<canvas id="game"></canvas>

<div class="menu">
    <div id="b-road" class="btn active" onclick="setMode('road')">ğŸ›£ï¸</div>
    <div id="b-ride" class="btn" onclick="setMode('ride')">ğŸ¡</div>
    <div id="b-food" class="btn" onclick="setMode('food')">ğŸ”</div>
    <div id="b-tree" class="btn" onclick="setMode('tree')">ğŸŒ²</div>
    <div class="btn" style="background:#2ecc71" onclick="addPeep()">ğŸ‘¤</div>
</div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const T_W = 64, T_H = 32, SZ = 16; // Mapa de 16x16
let money = 1000, mode = 'road', cam = {x:0, y:0}, time = 0;
let grid = Array(SZ).fill().map(() => Array(SZ).fill(0));
let entities = [];

function resize() { 
    canvas.width = window.innerWidth; canvas.height = window.innerHeight; 
    cam.x = canvas.width/2; cam.y = canvas.height/6;
}
window.onresize = resize; resize();

function setMode(m) { 
    mode = m; document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
    document.getElementById('b-'+m)?.classList.add('active');
}

// LÃ³gica de dibujo isomÃ©trico avanzado
function drawIsoTile(x, y, color, height = 0) {
    const p = { x: cam.x + (x - y) * (T_W/2), y: cam.y + (x + y) * (T_H/2) };
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(p.x, p.y - height);
    ctx.lineTo(p.x + T_W/2, p.y + T_H/2 - height);
    ctx.lineTo(p.x, p.y + T_H - height);
    ctx.lineTo(p.x - T_W/2, p.y + T_H/2 - height);
    ctx.fill();
    return p;
}

class Agent {
    constructor() { this.x = 0; this.y = 0; this.tx = 0; this.ty = 0; this.mv = false; this.c = `hsl(${Math.random()*360},70%,50%)`; }
    update() {
        if(!this.mv) {
            let d = [{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}][Math.floor(Math.random()*4)];
            if(this.x+d.x>=0 && this.x+d.x<SZ && this.y+d.y>=0 && this.y+d.y<SZ && grid[this.x+d.x][this.y+d.y]===1) {
                this.tx = this.x+d.x; this.ty = this.y+d.y; this.mv = true;
            }
        } else {
            this.x += (this.tx - this.x) * 0.1; this.y += (this.ty - this.y) * 0.1;
            if(Math.abs(this.x-this.tx)<0.01) { this.x=this.tx; this.y=this.ty; this.mv=false; }
        }
    }
}

function render() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    time++;
    
    // Suelo
    for(let x=0; x<SZ; x++) {
        for(let y=0; y<SZ; y++) {
            let col = grid[x][y] === 1 ? "#7f8c8d" : "#27ae60";
            if(grid[x][y] === 1) { // Bordes de camino
                drawIsoTile(x,y,"#34495e");
                drawIsoTile(x,y,col, 2);
            } else {
                drawIsoTile(x,y,col);
            }
        }
    }

    // Entidades (Ordenadas por profundidad)
    let sorted = [...entities].sort((a,b) => (a.x+a.y) - (b.x+b.y));
    sorted.forEach(e => {
        const p = { x: cam.x + (e.x - e.y) * (T_W/2), y: cam.y + (e.x + e.y) * (T_H/2) };
        if(e instanceof Agent) {
            e.update();
            // Sombras de agentes
            ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.beginPath(); ctx.ellipse(p.x, p.y+12, 6, 3, 0, 0, 7); ctx.fill();
            // Cuerpo
            ctx.fillStyle = "#000"; ctx.fillRect(p.x-5, p.y-15, 10, 15);
            ctx.fillStyle = e.c; ctx.fillRect(p.x-4, p.y-14, 8, 13);
            // Cabeza
            ctx.fillStyle = "#000"; ctx.fillRect(p.x-7, p.y-25, 14, 12);
            ctx.fillStyle = "#ffdbac"; ctx.fillRect(p.x-6, p.y-24, 12, 10);
        } else {
            // Edificios y Ãrboles
            if(e.type === 'tree') {
                ctx.fillStyle = "#795548"; ctx.fillRect(p.x-2, p.y-10, 4, 10);
                ctx.fillStyle = "#1b5e20"; ctx.beginPath(); ctx.arc(p.x, p.y-15, 8, 0, 7); ctx.fill();
            } else if(e.type === 'ride') {
                ctx.fillStyle = "#c0392b"; ctx.fillRect(p.x-15, p.y-40, 30, 40);
                // AnimaciÃ³n de rotaciÃ³n
                ctx.strokeStyle = "#f1c40f"; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(p.x, p.y-25, 12 + Math.sin(time*0.1)*2, 0, 7); ctx.stroke();
            } else if(e.type === 'food') {
                ctx.fillStyle = "#d35400"; ctx.fillRect(p.x-12, p.y-25, 24, 25);
                ctx.fillStyle = "#f39c12"; ctx.fillRect(p.x-12, p.y-30, 24, 5);
            }
        }
    });

    requestAnimationFrame(render);
}

canvas.onclick = (e) => {
    const mx = e.clientX - cam.x, my = e.clientY - cam.y;
    const gx = Math.floor((my / (T_H/2) + mx / (T_W/2)) / 2);
    const gy = Math.floor((my / (T_H/2) - mx / (T_W/2)) / 2);
    if(gx>=0 && gx<SZ && gy>=0 && gy<SZ) {
        if(mode === 'road') { grid[gx][gy] = 1; money -= 10; }
        else { entities.push({x:gx, y:gy, type: mode}); money -= 50; }
        document.getElementById('mText').innerText = money;
    }
};

function addPeep() { entities.push(new Agent()); document.getElementById('pText').innerText = entities.filter(e => e instanceof Agent).length; }

for(let i=0; i<SZ; i++) grid[i][0] = 1; // Camino inicial
render();
</script>
</body>
</html>
