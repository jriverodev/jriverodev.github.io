<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inventario de Equipos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { transition: background-color 0.3s; }
    .dark-mode { background-color: #121212; color: #ffffff; }
    .table-responsive { max-height: 70vh; overflow-y: auto; }
    .status-operativo { background-color: #d4edda; }
    .status-inoperativo { background-color: #f8d7da; }
    .status-roba { background-color: #ffeaa7; }
  </style>
</head>
<body class="container mt-4">
  <h1 class="text-center mb-4">Inventario de Equipos</h1>
  
  <!-- Controles -->
  <div class="d-flex justify-content-between mb-3">
    <div>
      <button id="loadBtn" class="btn btn-primary">Cargar Datos</button>
      <button id="saveBtn" class="btn btn-success">Guardar Cambios</button>
      <button id="exportBtn" class="btn btn-info">Exportar CSV</button>
      <button id="addRowBtn" class="btn btn-secondary">Agregar Fila</button>
    </div>
    <div>
      <input type="text" id="searchInput" class="form-control" placeholder="Buscar...">
      <button id="themeBtn" class="btn btn-outline-secondary ms-2">Tema Oscuro</button>
    </div>
  </div>
  
  <!-- Filtros -->
  <div class="row mb-3">
    <div class="col-md-3">
      <select id="filterSector" class="form-select">
        <option value="">Filtrar por Sector</option>
      </select>
    </div>
    <div class="col-md-3">
      <select id="filterStatus" class="form-select">
        <option value="">Filtrar por Status</option>
        <option value="OPERATIVO">OPERATIVO</option>
        <option value="INOPERATIVO">INOPERATIVO</option>
        <option value="ROBADO">ROBADO</option>
        <option value="MIXTO">MIXTO</option>
      </select>
    </div>
  </div>
  
  <!-- Tabla -->
  <div class="table-responsive">
    <table class="table table-striped table-hover" id="inventoryTable">
      <thead class="table-dark">
        <tr>
          <th>Responsable</th>
          <th>Cédula</th>
          <th>Cargo</th>
          <th>Sector</th>
          <th>Status General</th>
          <th>Laptop</th>
          <th>Escritorio</th>
          <th>Obs Generales</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  
  <!-- Gráfico -->
  <canvas id="statsChart" class="mt-4"></canvas>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
      storageBucket: "TU_PROYECTO.appspot.com",
      messagingSenderId: "TU_ID",
      appId: "TU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables globales
    let data = [];
    let filteredData = [];
    let isDarkMode = false;

    const tableBody = document.getElementById('tableBody');
    const searchInput = document.getElementById('searchInput');
    const filterSector = document.getElementById('filterSector');
    const filterStatus = document.getElementById('filterStatus');
    const themeBtn = document.getElementById('themeBtn');

    document.getElementById('loadBtn').addEventListener('click', loadData);
    document.getElementById('saveBtn').addEventListener('click', saveData);
    document.getElementById('exportBtn').addEventListener('click', exportToCSV);
    document.getElementById('addRowBtn').addEventListener('click', createRow);
    searchInput.addEventListener('input', applyFilters);
    filterSector.addEventListener('change', applyFilters);
    filterStatus.addEventListener('change', applyFilters);
    themeBtn.addEventListener('click', toggleTheme);

    async function loadData() {
      try {
        const querySnapshot = await getDocs(collection(db, "inventario"));
        data = [];
        querySnapshot.forEach((doc) => {
          data.push({ id: doc.id, ...doc.data() });
        });
        filteredData = [...data];
        populateFilters();
        renderTable();
        renderChart();
      } catch (error) {
        console.error('Error cargando datos:', error);
        alert('Error al cargar datos de Firestore.');
      }
    }

    function populateFilters() {
      const sectors = [...new Set(data.map(item => item.sector))];
      filterSector.innerHTML = '<option value="">Filtrar por Sector</option>';
      sectors.forEach(sector => {
        const option = document.createElement('option');
        option.value = sector;
        option.textContent = sector;
        filterSector.appendChild(option);
      });
    }

    function applyFilters() {
      const searchTerm = searchInput.value.toLowerCase();
      const sectorFilter = filterSector.value;
      const statusFilter = filterStatus.value;

      filteredData = data.filter(item => {
        const matchesSearch = Object.values(item).some(val => 
          typeof val === 'string' && val.toLowerCase().includes(searchTerm)
        );
        const matchesSector = !sectorFilter || item.sector === sectorFilter;
        const matchesStatus = !statusFilter || item.statusGeneral === statusFilter;
        return matchesSearch && matchesSector && matchesStatus;
      });
      renderTable();
    }

    function renderTable() {
      tableBody.innerHTML = '';
      filteredData.forEach((item, index) => {
        const row = document.createElement('tr');
        row.classList.add(getStatusClass(item.statusGeneral));
        row.innerHTML = `
          <td contenteditable="true">${item.responsable}</td>
          <td contenteditable="true">${item.cedula}</td>
          <td contenteditable="true">${item.cargo}</td>
          <td contenteditable="true">${item.sector}</td>
          <td contenteditable="true">${item.statusGeneral}</td>
          <td contenteditable="true">${formatEquipo(item.equipo1?.laptop || {})}</td>
          <td contenteditable="true">${formatEquipo(item.equipo2?.escritorio || {})}</td>
          <td contenteditable="true">${item.obsGenerales}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="updateRow(${index})">Actualizar</button>
            <button class="btn btn-danger btn-sm" onclick="deleteRow(${index})">Eliminar</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function getStatusClass(status) {
      if (status === 'OPERATIVO') return 'status-operativo';
      if (status === 'INOPERATIVO' || status === 'ROBADO') return 'status-inoperativo';
      return 'status-roba';
    }

    function formatEquipo(equipo) {
      return `${equipo.marca || 'N/A'}/${equipo.modelo || 'N/A'}/${equipo.serial || 'N/A'}/${equipo.etiqueta || 'N/A'}/${equipo.status || 'N/A'}/${equipo.obs || '-'}`;
    }

    async function createRow() {
      const newItem = {
        responsable: 'Nuevo Responsable',
        cedula: 'SIN INFORMACION',
        cargo: 'SIN INFORMACION',
        sector: 'SIN INFORMACION',
        statusGeneral: 'OPERATIVO',
        equipo1: { laptop: {} },
        equipo2: { escritorio: {} },
        obsGenerales: '-'
      };
      try {
        await addDoc(collection(db, "inventario"), newItem);
        loadData();
        alert('Nueva fila creada.');
      } catch (error) {
        console.error('Error creando fila:', error);
      }
    }

    async function updateRow(index) {
      const item = filteredData[index];
      const row = tableBody.rows[index];
      const cells = row.querySelectorAll('td[contenteditable]');
      const updatedItem = {
        responsable: cells[0].textContent,
        cedula: cells[1].textContent,
        cargo: cells[2].textContent,
        sector: cells[3].textContent,
        statusGeneral: cells[4].textContent,
        equipo1: { laptop: parseEquipo(cells[5].textContent) },
        equipo2: { escritorio: parseEquipo(cells[6].textContent) },
        obsGenerales: cells[7].textContent
      };
      try {
        await updateDoc(doc(db, "inventario", item.id), updatedItem);
        loadData();
        alert('Fila actualizada.');
      } catch (error) {
        console.error('Error actualizando:', error);
      }
    }

    async function deleteRow(index) {
      const item = filteredData[index];
      if (confirm('¿Eliminar esta fila?')) {
        try {
          await deleteDoc(doc(db, "inventario", item.id));
          loadData();
          alert('Fila eliminada.');
        } catch (error) {
          console.error('Error eliminando:', error);
        }
      }
    }

    function parseEquipo(str) {
      const parts = str.split('/');
      return {
        marca: parts[0] || 'N/A',
        modelo: parts[1] || 'N/A',
        serial: parts[2] || 'N/A',
        etiqueta: parts[3] || 'N/A',
        status: parts[4] || 'N/A',
        obs: parts[5] || '-'
      };
    }

    function saveData() {
      alert('Datos guardados en Firestore.');
    }

    function exportToCSV() {
      let csv = 'Responsable,Cédula,Cargo,Sector,Status General,Laptop,Escritorio,Obs Generales\n';
      data.forEach(item => {
        csv += `${item.responsable},${item.cedula},${item.cargo},${item.sector},${item.statusGeneral},${formatEquipo(item.equipo1?.laptop || {})},${formatEquipo(item.equipo2?.escritorio || {})},${item.obsGenerales}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'inventario.csv';
      a.click();
    }

    function renderChart() {
      const ctx = document.getElementById('statsChart').getContext('2d');
      const statusCounts = data.reduce((acc, item) => {
        acc[item.statusGeneral] = (acc[item.statusGeneral] || 0) + 1;
        return acc;
      }, {});
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: Object.keys(statusCounts),
          datasets: [{
            data: Object.values(statusCounts),
            backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#6c757d']
          }]
        }
      });
    }

    function toggleTheme() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode');
      themeBtn.textContent = isDarkMode ? 'Tema Claro' : 'Tema Oscuro';
    }

    window.onload = loadData;
  </script>
</body>
</html>
