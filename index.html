<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Inventario</title>

  <meta name="theme-color" content="#2c3e50"/>
  <meta name="description" content="Sistema de GestiÃ³n de Inventario - PWA">

  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIC8+"/>
  <meta name="apple-mobile-web-app-status-bar" content="#2c3e50">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* (Se conservan los estilos principales del proyecto) */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh; padding:20px;
    }
    .container { max-width:1200px; margin:0 auto; background:white; border-radius:15px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden; }
    .header { background:linear-gradient(135deg,#2c3e50,#34495e); color:white; padding:20px; text-align:center; }
    .header-actions{ display:flex; gap:10px; justify-content:center; margin-top:15px; flex-wrap:wrap; }
    .nav{ display:flex; background:#34495e; border-bottom:1px solid #ddd; flex-wrap:wrap; }
    .nav button{ flex:1; padding:15px; border:none; background:#34495e; color:white; cursor:pointer; font-size:14px; min-width:120px; }
    .nav button.active{ background:#3498db; font-weight:bold; }
    .content{ padding:20px; min-height:400px; }
    .table-container{ overflow-x:auto; margin-top:20px; }
    table{ width:100%; border-collapse:collapse; background:white; }
    th, td{ padding:12px; text-align:left; border-bottom:1px solid #e9ecef; }
    th{ background:#34495e; color:white; position:sticky; top:0; }
    .btn{ padding:8px 15px; border:none; border-radius:5px; cursor:pointer; margin:2px; font-size:12px; }
    .btn-add{ background:#27ae60; color:white; padding:10px 20px; }
    .btn-export{ background:#9b59b6; color:white; }
    .btn-import{ background:#e67e22; color:white; }
    .footer{ text-align:center; padding:20px; background:#f8f9fa; color:#666; border-top:1px solid #e9ecef; }
    .modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
    .modal-content{ background:white; margin:5% auto; padding:20px; border-radius:10px; width:90%; max-width:600px; max-height:80vh; overflow-y:auto; }
    @media (max-width:768px){ .nav{ flex-direction:column; } .btn{ font-size:11px; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸ“± Sistema de Inventario</h1>
      <p>GestiÃ³n completa de inventario</p>
      <div class="header-actions">
        <button class="btn btn-export" id="exportExcelBtn">ðŸ“Š Exportar a Excel</button>
        <label class="file-label btn-import" for="fileInput">ðŸ“¥ Importar Excel</label>
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv" style="display:none">
      </div>
    </div>

    <div class="nav">
      <button id="tabDashboard" class="active">ðŸ“Š Dashboard</button>
      <button id="tabUsuarios">ðŸ‘¥ Usuarios</button>
      <button id="tabEquipos">ðŸ’» Equipos</button>
      <button id="tabAsignaciones">ðŸ”— Asignaciones</button>
    </div>

    <div class="content">
      <div id="dashboard" class="tab-content active">
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:20px;">
          <div style="background:white;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);">
            <div style="font-size:1.6rem;font-weight:bold;color:#3498db" id="totalUsuarios">0</div>
            <div>Total Usuarios</div>
          </div>
          <div style="background:white;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);">
            <div style="font-size:1.6rem;font-weight:bold;color:#3498db" id="totalEquipos">0</div>
            <div>Total Equipos</div>
          </div>
          <div style="background:white;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);">
            <div style="font-size:1.6rem;font-weight:bold;color:#3498db" id="equiposOperativos">0</div>
            <div>Equipos Operativos</div>
          </div>
          <div style="background:white;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);">
            <div style="font-size:1.6rem;font-weight:bold;color:#3498db" id="equiposAsignados">0</div>
            <div>Equipos Asignados</div>
          </div>
        </div>

        <div class="search-box" style="margin-bottom:20px;">
          <input type="text" id="globalSearch" placeholder="ðŸ” Buscar en todo el inventario..." style="width:100%; padding:12px; border-radius:8px; border:2px solid #e9ecef;">
        </div>

        <h3>Ãšltimas Asignaciones</h3>
        <div id="ultimasAsignaciones" class="table-container"></div>
      </div>

      <div id="usuarios" class="tab-content" style="display:none">
        <button class="btn btn-add" id="addUsuarioBtn">âž• Agregar Usuario</button>
        <div class="search-box" style="margin:12px 0;">
          <input type="text" id="searchUsuarios" placeholder="ðŸ” Buscar usuarios..." style="width:100%; padding:12px; border-radius:8px; border:2px solid #e9ecef;">
        </div>
        <div class="table-container">
          <table id="tablaUsuarios"><thead><tr><th>ID</th><th>Responsable</th><th>CÃ©dula</th><th>Cargo</th><th>Sector</th><th>Equipos Asignados</th><th>Acciones</th></tr></thead><tbody id="tbodyUsuarios"></tbody></table>
        </div>
      </div>

      <div id="equipos" class="tab-content" style="display:none">
        <button class="btn btn-add" id="addEquipoBtn">âž• Agregar Equipo</button>
        <div class="search-box" style="margin:12px 0;">
          <input type="text" id="searchEquipos" placeholder="ðŸ” Buscar equipos..." style="width:100%; padding:12px; border-radius:8px; border:2px solid #e9ecef;">
        </div>
        <div class="table-container">
          <table id="tablaEquipos">
            <thead>
              <tr><th>ID</th><th>DescripciÃ³n</th><th>Marca</th><th>Modelo</th><th>Serial</th><th>Status</th><th>Asignado a</th><th>Acciones</th></tr>
            </thead>
            <tbody id="tbodyEquipos"></tbody>
          </table>
        </div>
      </div>

      <div id="asignaciones" class="tab-content" style="display:none">
        <button class="btn btn-add" id="addAsignacionBtn">âž• Nueva AsignaciÃ³n</button>
        <div class="search-box" style="margin:12px 0;">
          <input type="text" id="searchAsignaciones" placeholder="ðŸ” Buscar asignaciones..." style="width:100%; padding:12px; border-radius:8px; border:2px solid #e9ecef;">
        </div>
        <div class="table-container">
          <table id="tablaAsignaciones">
            <thead><tr><th>ID</th><th>Usuario</th><th>Equipo</th><th>Serial Equipo</th><th>Fecha</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="tbodyAsignaciones"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer"><p>Sistema de Inventario - RIVEROJDU</p></div>
  </div>

  <!-- Modals (usuarios / equipos / asignaciones) -->
  <div id="equipmentModal" class="modal"><div class="modal-content">
    <h3 id="equipmentModalTitle">Agregar / editar equipo</h3>
    <form id="equipmentForm">
      <input type="hidden" id="equipmentId">
      <div style="margin-bottom:10px;"><label>DescripciÃ³n</label><input id="descripcion" required style="width:100%;padding:8px"></div>
      <div style="margin-bottom:10px;"><label>Marca</label><input id="marca" required style="width:100%;padding:8px"></div>
      <div style="margin-bottom:10px;"><label>Modelo</label><input id="modelo" required style="width:100%;padding:8px"></div>
      <div style="margin-bottom:10px;"><label>Serial</label><input id="serial" required style="width:100%;padding:8px"></div>
      <div style="margin-bottom:10px;"><label>Etiqueta</label><input id="etiqueta" style="width:100%;padding:8px"></div>
      <div style="margin-bottom:10px;"><label>Status</label>
        <select id="status" required style="width:100%;padding:8px">
          <option value="OPERATIVO">OPERATIVO</option>
          <option value="INOPERATIVO">INOPERATIVO</option>
        </select>
      </div>
      <div style="margin-top:10px;text-align:right;">
        <button type="button" class="btn btn-cancel" id="closeEquipmentModal">Cancelar</button>
        <button type="submit" class="btn btn-save">Guardar</button>
      </div>
    </form>
  </div></div>

  <!-- File input already present near header -->
  <input type="hidden" id="lastExportTimestamp" value="">

  <script type="module">
  // -------------------------
  // Supabase init (user-provided credentials)
  // -------------------------
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  const SUPABASE_URL = 'https://memavgxdebiaoanzhysx.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1lbWF2Z3hkZWJpYW9hbnpoeXN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5Njk4ODgsImV4cCI6MjA3NzU0NTg4OH0._2dfAY4z7ZsWdbXPMIIoqNIIkMoO6kRvZBa6Mg_DWnA';
  window.supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // -------------------------
  // Utilities: DOM helpers
  // -------------------------
  const $ = sel => document.querySelector(sel);
  const $all = sel => Array.from(document.querySelectorAll(sel));

  // -------------------------
  // Tab handling
  // -------------------------
  function showTab(id){
    $all('.tab-content').forEach(el => el.style.display = 'none');
    $all('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById(id).style.display = 'block';
    document.querySelector(`.nav button[onclick="showTab('${id}')"]`)?.classList.add('active');
  }
  $all('.nav button').forEach(btn => {
    btn.addEventListener('click', () => {
      const onclick = btn.getAttribute('onclick');
      const id = onclick?.match(/'([^']+)'/)[1];
      if (id) showTab(id);
    });
  });

  // -------------------------
  // CRUD equipos: Supabase
  // -------------------------
  async function addEquipment(equipment){
    const { data, error } = await supabase.from('equipos').insert([equipment]).select();
    if(error) throw error;
    return data;
  }
  async function updateEquipment(equipment){
    const { data, error } = await supabase.from('equipos').update(equipment).eq('id_equipo', equipment.id_equipo).select();
    if(error) throw error;
    return data;
  }
  async function deleteEquipment(id){
    const { error } = await supabase.from('equipos').delete().eq('id_equipo', id);
    if(error) throw error;
  }
  async function getAllEquipments(){
    const { data, error } = await supabase.from('equipos').select('*').order('id_equipo',{ascending:true});
    if(error) throw error;
    return data || [];
  }

  // -------------------------
  // Render equipos table and handlers
  // -------------------------
  const tbodyEquipos = document.getElementById('tbodyEquipos');
  async function refreshEquipos(){
    try {
      const equipos = await getAllEquipments();
      document.getElementById('totalEquipos').textContent = equipos.length;
      tbodyEquipos.innerHTML = '';
      equipos.forEach(eq => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${eq.id_equipo ?? ''}</td>
          <td>${eq.descripcion ?? ''}</td>
          <td>${eq.marca ?? ''}</td>
          <td>${eq.modelo ?? ''}</td>
          <td>${eq.serial ?? ''}</td>
          <td>${eq.status ?? ''}</td>
          <td>${eq.asignado_a ?? ''}</td>
          <td>
            <button class="btn btn-edit" data-id="${eq.id_equipo}" data-action="edit">Editar</button>
            <button class="btn btn-delete" data-id="${eq.id_equipo}" data-action="delete">Eliminar</button>
          </td>
        `;
        tbodyEquipos.appendChild(tr);
      });
    } catch (err){
      console.error('Error refreshing equipos', err);
      alert('Error al cargar equipos. Revisa consola.');
    }
  }

  tbodyEquipos.addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const action = btn.getAttribute('data-action');
    if(action === 'edit'){
      // load data into modal
      const { data, error } = await supabase.from('equipos').select('*').eq('id_equipo', id).single();
      if(error){ console.error(error); alert('Error al obtener equipo'); return; }
      $('#equipmentId').value = data.id_equipo || '';
      $('#descripcion').value = data.descripcion || '';
      $('#marca').value = data.marca || '';
      $('#modelo').value = data.modelo || '';
      $('#serial').value = data.serial || '';
      $('#etiqueta').value = data.etiqueta || '';
      $('#status').value = data.status || 'OPERATIVO';
      $('#equipmentModal').style.display = 'block';
    } else if(action === 'delete'){
      if(!confirm('Eliminar equipo?')) return;
      try {
        await deleteEquipment(id);
        await refreshEquipos();
      } catch(err){ console.error(err); alert('Error eliminando equipo'); }
    }
  });

  // Equipment modal handlers
  $('#addEquipoBtn').addEventListener('click', () => {
    $('#equipmentForm').reset();
    $('#equipmentId').value = '';
    $('#equipmentModal').style.display = 'block';
  });
  $('#closeEquipmentModal').addEventListener('click', () => { $('#equipmentModal').style.display = 'none'; });

  $('#equipmentForm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const payload = {
      descripcion: $('#descripcion').value.trim(),
      marca: $('#marca').value.trim(),
      modelo: $('#modelo').value.trim(),
      serial: $('#serial').value.trim(),
      etiqueta: $('#etiqueta').value.trim(),
      status: $('#status').value
    };
    const id = $('#equipmentId').value;
    try {
      if(id){
        payload.id_equipo = id;
        await updateEquipment(payload);
      } else {
        await addEquipment(payload);
      }
      $('#equipmentModal').style.display = 'none';
      await refreshEquipos();
    } catch(err){
      console.error(err);
      alert('Error guardando equipo');
    }
  });

  // -------------------------
  // Export a Excel (XLSX)
  // -------------------------
  function exportToExcel(){
    try {
      const headers = ['ID','DescripciÃ³n','Marca','Modelo','Serial','Status','Asignado a'];
      const rows = Array.from(tbodyEquipos.rows).map(r => Array.from(r.cells).slice(0,7).map(c => c.textContent.trim()));
      const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Equipos');
      XLSX.writeFile(workbook, `equipos_export_${Date.now()}.xlsx`);
      document.getElementById('lastExportTimestamp').value = Date.now();
    } catch (err){
      console.error('Export error', err);
      alert('Error exportando Excel');
    }
  }
  $('#exportExcelBtn').addEventListener('click', exportToExcel);

  // -------------------------
  // Import Excel: parse and bulk insert/update
  // -------------------------
  $('#fileInput').addEventListener('change', async (ev) => {
    const file = ev.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        // rows is array of objects keyed by header names
        // Expect headers: ID, DescripciÃ³n, Marca, Modelo, Serial, Status, Asignado a
        for(const row of rows){
          const payload = {
            descripcion: row['DescripciÃ³n'] ?? row['Descripcion'] ?? '',
            marca: row['Marca'] ?? '',
            modelo: row['Modelo'] ?? '',
            serial: row['Serial'] ?? '',
            etiqueta: row['Etiqueta'] ?? '',
            status: row['Status'] ?? row['Estado'] ?? 'OPERATIVO',
            asignado_a: row['Asignado a'] ?? row['Asignado'] ?? ''
          };
          const id = row['ID'] || row['Id'] || row['id_equipo'];
          if(id){
            payload.id_equipo = id;
            // try update or upsert
            try { await updateEquipment(payload); } catch(e){ console.warn('update failed, trying insert', e); await addEquipment(payload); }
          } else {
            await addEquipment(payload);
          }
        }
        alert('ImportaciÃ³n finalizada');
        await refreshEquipos();
      } catch(err){
        console.error('Import error', err);
        alert('Error importando archivo. Revisa consola.');
      }
    };
    reader.readAsArrayBuffer(file);
  });

  // -------------------------
  // Initial load and small UI wiring
  // -------------------------
  document.addEventListener('DOMContentLoaded', async () => {
    await refreshEquipos();
    // Wire other minimal interactions (search on equipos)
    $('#searchEquipos').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      Array.from(tbodyEquipos.rows).forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(q) ? '' : 'none';
      });
    });
    // globalSearch: simple multi-table search that filters visible rows in each table
    $('#globalSearch').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      // Equipos
      Array.from(tbodyEquipos.rows).forEach(row => row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none');
      // Usuarios, Asignaciones can be wired similarly when their data is implemented
    });
  });

  // Close modal when clicking outside modal-content
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (ev) => {
      if(ev.target === modal) modal.style.display = 'none';
    });
  });

  // Minimal placeholder functions for users/asignaciones (to avoid breaking UI)
  async function refreshUsuarios(){ /* implement when migrating usuarios */ }
  async function refreshAsignaciones(){ /* implement when migrating asignaciones */ }

  </script>
</body>
</html>
