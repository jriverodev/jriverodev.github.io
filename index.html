<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario</title>

    <meta name="theme-color" content="#2c3e50"/>
    <meta name="description" content="Sistema de Gesti√≥n de Inventario - PWA">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIGZpbGw9IiMyYzNlNTAiLz4KPHRleHQgeD0iOTYiIHk9IjEwMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SU5WPC90ZXh0Pgo8L3N2Zz4=">
    <meta name="apple-mobile-web-app-status-bar" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos CSS para la interfaz del sistema */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav {
            display: flex;
            background: #34495e;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .nav button {
            flex: 1;
            padding: 15px;
            border: none;
            background: #34495e;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
            min-width: 120px;
        }

        .nav button:hover {
            background: #2c3e50;
        }

        .nav button.active {
            background: #3498db;
            font-weight: bold;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #34495e;
            color: white;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-add {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            margin-bottom: 15px;
        }

        .btn-export {
            background: #9b59b6;
            color: white;
        }

        .btn-import {
            background: #e67e22;
            color: white;
        }

        .btn-download-template {
            background: #34495e;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-actions {
            text-align: right;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .btn-save {
            background: #3498db;
            color: white;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #e67e22;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .import-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .equipment-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
            }
            
            .nav button {
                padding: 12px;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 8px;
                font-size: 14px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .header-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
            border-top: 1px solid #e9ecef;
        }

        .status-operativo {
            color: #27ae60;
            font-weight: bold;
        }

        .status-inoperativo {
            color: #e74c3c;
            font-weight: bold;
        }

        .assigned-badge {
            background: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .unassigned-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* ... (TODOS TUS ESTILOS ACTUALES SE MANTIENEN) ... */

        /* === ESTILOS PWA ADICIONALES === */
        .pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 14px;
        }

        .pwa-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }

        .offline-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #e74c3c;
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 1001;
            display: none;
        }

        @media (max-width: 768px) {
            .pwa-install-btn {
                bottom: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="offline-warning" id="offlineWarning">
        ‚ö†Ô∏è Est√°s trabajando sin conexi√≥n
    </div>
    
    <div class="pwa-status" id="pwaStatus">
        üì± PWA Lista
    </div>
    
    <button class="pwa-install-btn" id="pwaInstallBtn">
        üì≤ Instalar App
    </button>
    
    <div class="container">
        <div class="header">
            <h1>üì± Sistema de Inventario</h1>
            <p>Gesti√≥n completa de inventario</p>
            <div class="header-actions">
                <button class="btn btn-export" onclick="exportToExcel()">üìä Exportar a Excel</button>
                </div>
        </div>

        <div class="nav">
            <button onclick="showTab('dashboard')" class="active">üìä Dashboard</button>
            <button onclick="showTab('usuarios')">üë• Usuarios</button>
            <button onclick="showTab('equipos')">üíª Equipos</button>
            <button onclick="showTab('asignaciones')">üîó Asignaciones</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsuarios">0</div>
                        <div class="stat-label">Total Usuarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEquipos">0</div>
                        <div class="stat-label">Total Equipos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="equiposOperativos">0</div>
                        <div class="stat-label">Equipos Operativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="equiposAsignados">0</div>
                        <div class="stat-label">Equipos Asignados</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="globalSearch" placeholder="üîç Buscar en todo el inventario..." onkeyup="globalSearch()">
                </div>

                <h3>√öltimas Asignaciones</h3>
                <div id="ultimasAsignaciones" class="table-container">
                    </div>
            </div>

            <div id="usuarios" class="tab-content">
                <button class="btn btn-add" onclick="openUserModal()">‚ûï Agregar Usuario</button>
                <div class="search-box">
                    <input type="text" id="searchUsuarios" placeholder="üîç Buscar usuarios..." onkeyup="filterTable('usuarios')">
                </div>
                <div class="table-container">
                    <table id="tablaUsuarios">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Responsable</th>
                                <th>C√©dula</th>
                                <th>Cargo</th>
                                <th>Sector</th>
                                <th>Equipos Asignados</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyUsuarios">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="equipos" class="tab-content">
                <button class="btn btn-add" onclick="openEquipmentModal()">‚ûï Agregar Equipo</button>
                <div class="search-box">
                    <input type="text" id="searchEquipos" placeholder="üîç Buscar equipos..." onkeyup="filterTable('equipos')">
                </div>
                <div class="table-container">
                    <table id="tablaEquipos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descripci√≥n</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Serial</th>
                                <th>Status</th>
                                <th>Asignado a</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyEquipos">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="asignaciones" class="tab-content">
                <button class="btn btn-add" onclick="openAssignmentModal()">‚ûï Nueva Asignaci√≥n</button>
                <div class="search-box">
                    <input type="text" id="searchAsignaciones" placeholder="üîç Buscar asignaciones..." onkeyup="filterTable('asignaciones')">
                </div>
                <div class="table-container">
                    <table id="tablaAsignaciones">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Equipo</th>
                                <th>Serial Equipo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyAsignaciones">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Sistema de Inventario - RIVEROJDU</p>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3 id="userModalTitle">Agregar Usuario</h3>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Responsable:</label>
                    <input type="text" id="responsable" required>
                </div>
                <div class="form-group">
                    <label>C√©dula:</label>
                    <input type="text" id="cedula">
                </div>
                <div class="form-group">
                    <label>Cargo:</label>
                    <input type="text" id="cargo">
                </div>
                <div class="form-group">
                    <label>Sector:</label>
                    <input type="text" id="sector" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeUserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="equipmentModal" class="modal">
        <div class="modal-content">
            <h3 id="equipmentModalTitle">Agregar Equipo</h3>
            <form id="equipmentForm">
                <input type="hidden" id="equipmentId">
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <input type="text" id="descripcion" required>
                </div>
                <div class="form-group">
                    <label>Marca:</label>
                    <input type="text" id="marca" required>
                </div>
                <div class="form-group">
                    <label>Modelo:</label>
                    <input type="text" id="modelo" required>
                </div>
                <div class="form-group">
                    <label>Serial: <small>(√önico, identifica el equipo)</small></label>
                    <input type="text" id="serial" required>
                </div>
                <div class="form-group">
                    <label>Etiqueta:</label>
                    <input type="text" id="etiqueta">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="status" required>
                        <option value="OPERATIVO">OPERATIVO</option>
                        <option value="INOPERATIVO">INOPERATIVO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="observaciones" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeEquipmentModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <h3 id="assignmentModalTitle">Nueva Asignaci√≥n</h3>
            <form id="assignmentForm">
                <input type="hidden" id="assignmentId">
                <div class="form-group">
                    <label>Usuario:</label>
                    <select id="assignmentUsuario" required onchange="updateAvailableEquipments()">
                        <option value="">Seleccionar usuario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Equipo:</label>
                    <select id="assignmentEquipo" required onchange="updateEquipmentDetails()">
                        <option value="">Seleccionar equipo</option>
                    </select>
                    <div id="equipmentDetails" class="equipment-info" style="display: none;">
                        </div>
                </div>
                <div class="form-group">
                    <label>Estado:</label>
                    <select id="assignmentEstado" required>
                        <option value="Asignado">Asignado</option>
                        <option value="Retirado">Retirado</option>
                        <option value="En Reparaci√≥n">En Reparaci√≥n</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeAssignmentModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
  // =============================================
// CONFIGURACI√ìN PWA PARA GITHUB PAGES
// =============================================

// Manifest din√°mico para PWA
// =============================================
// CONFIGURACI√ìN PWA CON TUS ICONOS PNG
// =============================================

const manifest = {
    "name": "Sistema de Inventario",
    "short_name": "InventarioPWA", 
    "description": "Sistema de gesti√≥n de inventario completo con usuarios, equipos y asignaciones",
    "start_url": ".",
    "scope": "/",
    "display": "standalone",
    "background_color": "#ffffff",
    "theme_color": "#2c3e50",
    "orientation": "any",
    "categories": ["business", "productivity", "utilities"],
    "icons": [
        {
            "src": "content/icons/android/android-launchericon-192-192.png",
            "sizes": "192x192",
            "type": "image/png",
            "purpose": "any"
        },
        {
            "src": "content/icons/android/android-launchericon-512-512.png",
            "sizes": "512x512",
            "type": "image/png",
            "purpose": "any"
        }
    ],
    "screenshots": [
        {
            "src": "content/icons/windows11/Wide310x150Logo.scale-400.png",
            "sizes": "1240x600",
            "type": "image/png",
            "form_factor": "wide",
            "label": "Dashboard del Sistema de Inventario"
        }
    ]
};

// Crear y agregar manifest din√°mico
function setupPWA() {
    // Crear link del manifest
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(manifestBlob);
    
    const manifestLink = document.createElement('link');
    manifestLink.rel = 'manifest';
    manifestLink.href = manifestURL;
    document.head.appendChild(manifestLink);

    console.log('‚úÖ Manifest PWA configurado');

    // En GitHub Pages usamos un enfoque simplificado sin Service Worker
    setupPWAInstall();
    setupConnectionDetection();
    
    // Marcar como PWA b√°sica (sin Service Worker)
    updatePWAStatus('‚úÖ PWA B√°sica');
}

// Service Worker ALTERNATIVO - Solo para HTTPS tradicional
function tryRegisterServiceWorker() {
    // Solo intentar en entornos que soporten Service Workers correctamente
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
        try {
            // Intentar registrar un Service Worker muy b√°sico
            const swContent = `
                self.addEventListener('install', (event) => {
                    console.log('üì¶ PWA Installado');
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', (event) => {
                    console.log('‚úÖ PWA Activado');
                    event.waitUntil(self.clients.claim());
                });
                
                // Cache b√°sico para recursos cr√≠ticos
                self.addEventListener('fetch', (event) => {
                    // Estrategia de cache b√°sica
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => response || fetch(event.request))
                    );
                });
            `;
            
            const swBlob = new Blob([swContent], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);
            
            navigator.serviceWorker.register(swURL, { scope: './' })
                .then(registration => {
                    console.log('‚úÖ Service Worker registrado (b√°sico)');
                    updatePWAStatus('‚úÖ PWA Completa');
                })
                .catch(error => {
                    console.log('‚ö†Ô∏è Service Worker no disponible en este entorno');
                    // No es cr√≠tico - continuar sin SW
                });
                
        } catch (error) {
            console.log('‚ö†Ô∏è Entorno no compatible con Service Worker');
        }
    } else {
        console.log('üåê Modo PWA B√°sica (sin Service Worker)');
    }
}

// Instalaci√≥n de PWA MEJORADA
function setupPWAInstall() {
    let deferredPrompt;
    const installBtn = document.getElementById('pwaInstallBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
        updatePWAStatus('üì± Lista para instalar');
        console.log('üì± App lista para instalaci√≥n');
        
        // Mostrar por 30 segundos
        setTimeout(() => {
            if (installBtn.style.display !== 'none') {
                installBtn.style.display = 'none';
                console.log('‚è∞ Bot√≥n de instalaci√≥n ocultado');
            }
        }, 30000);
    });

    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            installBtn.textContent = '‚è≥ Instalando...';
            installBtn.disabled = true;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                installBtn.textContent = '‚úÖ Instalada';
                installBtn.style.background = '#27ae60';
                updatePWAStatus('üéâ App Instalada');
                console.log('üéâ App aceptada para instalaci√≥n');
                
                setTimeout(() => {
                    installBtn.style.display = 'none';
                }, 3000);
            } else {
                installBtn.textContent = 'üì≤ Instalar App';
                installBtn.disabled = false;
                console.log('‚ùå App rechazada para instalaci√≥n');
                updatePWAStatus('üì± Instalaci√≥n cancelada');
                
                setTimeout(() => {
                    installBtn.style.display = 'none';
                }, 5000);
            }
            deferredPrompt = null;
        }
    });

    window.addEventListener('appinstalled', (evt) => {
        installBtn.style.display = 'none';
        deferredPrompt = null;
        updatePWAStatus('üéâ App Instalada');
        console.log('üéâ App instalada exitosamente');
    });
    
    // Verificar si ya est√° instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
        installBtn.style.display = 'none';
        updatePWAStatus('üì± Ejecutando como App');
        console.log('üì± Ejecut√°ndose en modo standalone');
    }
    
    // Tambi√©n verificar usando navigator.standalone (iOS)
    if (navigator.standalone) {
        installBtn.style.display = 'none';
        updatePWAStatus('üì± Ejecutando como App (iOS)');
        console.log('üì± Ejecut√°ndose en modo standalone (iOS)');
    }
}

// Detecci√≥n de conexi√≥n MEJORADA
function setupConnectionDetection() {
    const offlineWarning = document.getElementById('offlineWarning');

    function updateOnlineStatus() {
        if (navigator.onLine) {
            offlineWarning.style.display = 'none';
            updatePWAStatus(document.getElementById('pwaStatus').textContent.replace('‚ö†Ô∏è Offline - ', ''));
            console.log('üåê Conexi√≥n restaurada');
        } else {
            offlineWarning.style.display = 'block';
            const currentStatus = document.getElementById('pwaStatus').textContent;
            if (!currentStatus.includes('Offline')) {
                updatePWAStatus('‚ö†Ô∏è Offline - ' + currentStatus);
            }
            console.log('üåê Sin conexi√≥n - Modo offline activado');
            
            // Mostrar notificaci√≥n de offline
            showOfflineNotification();
        }
    }

    function showOfflineNotification() {
        // Crear notificaci√≥n visual temporal
        const offlineMsg = document.createElement('div');
        offlineMsg.style.cssText = `
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        `;
        offlineMsg.textContent = '‚ö†Ô∏è Modo offline - Los datos se guardan localmente';
        document.body.appendChild(offlineMsg);
        
        setTimeout(() => {
            if (document.body.contains(offlineMsg)) {
                document.body.removeChild(offlineMsg);
            }
        }, 3000);
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Estado inicial
    updateOnlineStatus();
}

// Actualizar estado PWA MEJORADO
function updatePWAStatus(message) {
    const statusElement = document.getElementById('pwaStatus');
    if (statusElement) {
        statusElement.textContent = message;
        
        // Cambiar color seg√∫n estado
        if (message.includes('‚úÖ') || message.includes('üéâ')) {
            statusElement.style.background = '#27ae60';
        } else if (message.includes('‚ö†Ô∏è') || message.includes('üì±') || message.includes('üîÑ')) {
            statusElement.style.background = '#f39c12';
        } else if (message.includes('‚ùå')) {
            statusElement.style.background = '#e74c3c';
        } else {
            statusElement.style.background = '#34495e';
        }
    }
}

// Funci√≥n para simular funcionalidad offline
function setupOfflineFunctionality() {
    console.log('üîß Configurando funcionalidad offline...');
    
    // Tu base de datos IndexedDB ya proporciona almacenamiento offline
    // Aqu√≠ podr√≠as agregar l√≥gica adicional para manejo offline
    
    // Ejemplo: Guardar operaciones pendientes cuando hay conexi√≥n
    let pendingOperations = JSON.parse(localStorage.getItem('pendingOperations') || '[]');
    
    // Intentar procesar operaciones pendientes cuando hay conexi√≥n
    window.addEventListener('online', () => {
        if (pendingOperations.length > 0) {
            console.log('üîÑ Procesando operaciones pendientes:', pendingOperations.length);
            // Aqu√≠ procesar√≠as las operaciones pendientes
            pendingOperations = [];
            localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations));
        }
    });
}

// Configurar notificaciones
function setupNotifications() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            console.log('‚ÑπÔ∏è Permisos de notificaci√≥n disponibles');
        } else if (Notification.permission === 'granted') {
            console.log('üîî Notificaciones permitidas');
        }
    }
}

// Funci√≥n para mostrar notificaci√≥n
function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: body,
            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMmMzZTUwIi8+Cjx0ZXh0IHg9IjMyIiB5PSIzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SU5WPC90ZXh0Pgo8L3N2Zz4='
        });
    }
}

// =============================================
// CONFIGURACI√ìN DE LA BASE DE DATOS
// =============================================
// Base de datos IndexedDB let db; const DB_NAME = 'InventarioDB'; const DB_VERSION = 

/**
 * Inicializa la base de datos IndexedDB.
 * @returns {Promise} - Promesa que resuelve cuando la base de datos est√° lista.
 */
function initDatabase() {
    return new Promise((resolve, reject) => {
        // La inicializaci√≥n ha sido comentada o eliminada para la migraci√≥n a Supabase.
        // Aqu√≠ se debe colocar la inicializaci√≥n de Supabase.
        resolve(); // Resuelve inmediatamente para permitir que el resto del c√≥digo contin√∫e.
    });
}

// === FUNCIONES DE USUARIO (IndexedDB) ===

/**
 * Agrega un nuevo usuario a la base de datos
 * @param {Object} user - Objeto usuario
 * @returns {IDBRequest} - Solicitud de la base de datos
 */
function addUser(user) {
    // Retorna un objeto simulado o un error si es necesario.
    console.error('Llamada a funci√≥n IndexedDB (addUser). Debe usar Supabase.');
    return { result: null, onsuccess: () => {}, onerror: () => {} };
}

/**
 * Actualiza un usuario existente en la base de datos
 * @param {Object} user - Objeto usuario con id_usuario y propiedades actualizadas
 * @returns {IDBRequest} - Solicitud de la base de datos
 */
function updateUser(user) {
    console.error('Llamada a funci√≥n IndexedDB (updateUser). Debe usar Supabase.');
    return { result: null, onsuccess: () => {}, onerror: () => {} };
}

/**
 * Elimina un usuario de la base de datos
 * @param {number} id - ID del usuario a eliminar
 * @returns {IDBRequest} - Solicitud de la base de datos
 */
function deleteUser(id) {
    console.error('Llamada a funci√≥n IndexedDB (deleteUser). Debe usar Supabase.');
    return { result: null, onsuccess: () => {}, onerror: () => {} };
}

/**
 * Obtiene un usuario espec√≠fico por su ID
 * @param {number} id - ID del usuario a buscar
 * @returns {Promise} - Promesa que resuelve con el usuario encontrado
 */
function getUser(id) {
    console.error('Llamada a funci√≥n IndexedDB (getUser). Debe usar Supabase.');
    return new Promise((resolve) => resolve(null));
}

/**
 * Obtiene todos los usuarios de la base de datos
 * @returns {Promise} - Promesa que resuelve con array de usuarios
 */
function getAllUsers() {
    console.error('Llamada a funci√≥n IndexedDB (getAllUsers). Debe usar Supabase.');
    return new Promise((resolve) => resolve([]));
}

/*
// BLOQUE IndexedDB ELIMINADO: Funciones addEquipment, updateEquipment, deleteEquipment, getEquipment, getEquipmentBySerial, getAllEquipments, addAssignment, updateAssignment, deleteAssignment, getAssignmentByEquipment, getAllAssignmentsByUser, getAllAssignments
// El usuario debe implementar la l√≥gica de Supabase para estas funciones.
*/

// =============================================
// FUNCIONES DE MANEJO DE DATOS Y L√ìGICA
// =============================================

/**
 * Carga todos los datos de la base de datos y los renderiza
 */
async function loadAllData() {
    try {
        // Las funciones de IndexedDB ahora deben ser reemplazadas por llamadas a Supabase.
        // Mientras tanto, se usar√°n arrays vac√≠os para evitar errores.
        const [usuarios, equipos, asignaciones] = await Promise.all([
            getAllUsers(), // Esto a√∫n es una funci√≥n simulada de IndexedDB
            getAllEquipments ? getAllEquipments() : Promise.resolve([]), // Esta funci√≥n fue eliminada
            getAllAssignments ? getAllAssignments() : Promise.resolve([]) // Esta funci√≥n fue eliminada
        ]);

        renderUsers(usuarios, equipos, asignaciones);
        renderEquipments(equipos, asignaciones);
        renderAssignments(asignaciones, usuarios, equipos);
        updateStats(usuarios, equipos, asignaciones);

    } catch (error) {
        console.error('Error cargando todos los datos:', error);
        alert('Error al cargar datos. Verifique la conexi√≥n a Supabase si IndexedDB fue eliminado.');
    }
}

/**
 * Inicializa la base de datos con datos de prueba si es necesario.
 */
async function initializeData() {
    await initDatabase(); // La base de datos es ahora Supabase.
    
    // Se ha eliminado la l√≥gica de IndexedDB para la inserci√≥n inicial.
    // Aqu√≠ se deben realizar las inserciones iniciales con Supabase.
    
    // Crear datos iniciales (ejemplo)
    const initialUsers = [
        {RESPONSABLE: "RIVERO JOSE", CEDULA: "10210157", CARGO: "CHOFER ESPECIAL 30 TONELADAS", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "TORRES SANCHEZ TEODORO", CEDULA: "10211108", CARGO: "CAPATAZ MOV MATER Y EQUIPOS BACHAQUERO", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "FERMIN RIGOBERTO", CEDULA: "10212721", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "SIBADA ANTONIO", CEDULA: "10213519", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "SANTOS DOUGLAS", CEDULA: "10312037", CARGO: "OBRERO", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "SANCHEZ DOUGLAS RAFAEL", CEDULA: "10350936", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "LANDAETA HENRY ANTONIO", CEDULA: "10398926", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "MEDINA DANIEL ANTONIO", CEDULA: "10420824", CARGO: "CHOFER ESPECIAL 30 TONELADAS", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "NAVARRO EMETERIO ANTONIO", CEDULA: "10601747", CARGO: "INSPECTOR DE CALIDAD OCC/LS", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "GUTIERREZ ENDER JOSE", CEDULA: "10603081", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "PRIETO REINALDO JOSE", CEDULA: "10604330", CARGO: "CHOFER ESPECIAL 30 TONELADAS", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "MEDINA ENDER", CEDULA: "11450196", CARGO: "ANALISTA DE CONTROL DE COMBUSTIBLE", SECTOR: "ADMINISTRACI√ìN DE ACTIVOS"},
        {RESPONSABLE: "MORALES EDGAR EDUARDO", CEDULA: "11453904", CARGO: "CAPATAZ TRANSPORTE DE PERSONAL LL", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "CORDERO JOSE", CEDULA: "11456218", CARGO: "CAPATAZ MANTENIMIENTO TALLER LA SALINA", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "GARCIA DELVIS GREGORIO", CEDULA: "11458480", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "DELGADO HARRISON ALONSO", CEDULA: "11459220", CARGO: "MECANICO AUTOMOTRIZ", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "LOPEZ DICKSON", CEDULA: "11691408", CARGO: "OPERADOR DE GRUA TELESCOPICA", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "CARIELES JUAN CARLOS", CEDULA: "11699144", CARGO: "PROGRAMADOR OPERACIONAL", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "SIVADA ENDER JOSE", CEDULA: "11799508", CARGO: "MECANICO AUTOMOTRIZ", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "PARRA NIXON ANTONIO", CEDULA: "11885513", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "GUTIERREZ MERVIN", CEDULA: "11886598", CARGO: "CAPATAZ TRANSPORTE DE PERSONAL OCC", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "CASTELLANOS MARCO ANTONIO", CEDULA: "11904126", CARGO: "ANALISTA DE MANTENIMIENTO", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "URDANA ENDER JOSE", CEDULA: "11906263", CARGO: "MECANICO AUTOMOTRIZ", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "VALERO ALBERTO", CEDULA: "12327924", CARGO: "OBRERO", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "GUTIERREZ NELSON ENRIQUE", CEDULA: "12328709", CARGO: "MECANICO AUTOMOTRIZ", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "PEREZ ROBERTO CARLOS", CEDULA: "12329160", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "BRITO MANUEL ENRIQUE", CEDULA: "12329216", CARGO: "SUPERVISOR DE PRESUPUESTO", SECTOR: "PLANIFICACI√ìN PRESUPUESTO Y GESTI√ìN"},
        {RESPONSABLE: "GUARUCANO PEDRO LUIS", CEDULA: "12372165", CARGO: "CHOFER ESPECIAL 30 TONELADAS", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "GARCIA FRANK", CEDULA: "18217250", CARGO: "SUPERVISOR LIQUIDO Y ACHIQUE LAGUNILLAS", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "ALMAO MARTIN", CEDULA: "18260617", CARGO: "CAPATAZ TRANSPORTE DE PERSONAL BACH", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "ADRIANZA FREDDY DE JESUS", CEDULA: "18341019", CARGO: "ANALISTA TALLER EXTERNO FLOTA LIVIANA", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "URRIBARRI WILLIAM EDUARDO", CEDULA: "18370278", CARGO: "ANALISTA DE PROGRAMACION OCC/LS", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "OCANDO ALVARO JOSE", CEDULA: "18371089", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "BASALO OMAR ANTONIO", CEDULA: "18484687", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "URRIBARRI CARLOS ENRIQUE", CEDULA: "18633295", CARGO: "MECANICO AUTOMOTRIZ", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "SALAZAR JOSE", CEDULA: "18695682", CARGO: "SUPERVISOR MOV MATER Y EQUIPOS BACHAQ", SECTOR: "ADMINISTRACI√ìN DE ACTIVOS"},
        {RESPONSABLE: "OCANDO WILLIAMS JOSE", CEDULA: "18794884", CARGO: "CHOFER", SECTOR: "OPERACIONES"},
        {RESPONSABLE: "AGUSTIN FERNANDO JOSE", CEDULA: "18795357", CARGO: "SUPERVISOR DE FLOTAS Y PLANES DE MTTO", SECTOR: "MANTENIMIENTO"},
        {RESPONSABLE: "GARCIA ARGENIS", CEDULA: "18821946", CARGO: "ANALISTA DE MANTENIMIENTO", SECTOR: "MANTENIMIENTO"},
    ];
    
    // Datos iniciales de equipos (comentados para evitar errores)
    const initialEquipments = [];

    // Esta l√≥gica ahora est√° rota porque las funciones de IndexedDB fueron eliminadas
    /*
    for (const user of initialUsers) {
        await addUser(user);
    }
    for (const equipment of initialEquipments) {
        await addEquipment(equipment);
    }
    // Crear asignaciones iniciales entre usuarios y equipos
    const usuarios = await getAllUsers();
    const equipos = await getAllEquipments();
    if (usuarios.length > 0 && equipos.length > 0) {
        // Asignar el primer equipo al primer usuario
        await addAssignment({ id_usuario: usuarios[0].id_usuario, id_equipo: equipos[0].id_equipo, fecha_asignacion: new Date().toISOString().split('T')[0], estado_asignacion: "Asignado" });
        // Asignar el segundo equipo al segundo usuario
        await addAssignment({ id_usuario: usuarios[1].id_usuario, id_equipo: equipos[1].id_equipo, fecha_asignacion: new Date().toISOString().split('T')[0], estado_asignacion: "Asignado" });
    }
    */
    
    // Recargar todos los datos para mostrar en la interfaz
    loadAllData();
}

/**
 * Renderiza la lista de usuarios en la tabla correspondiente
 * @param {Array} usuarios - Array de objetos usuario
 * @param {Array} equipos - Array de objetos equipo
 * @param {Array} asignaciones - Array de objetos asignaci√≥n
 */
function renderUsers(usuarios, equipos, asignaciones) {
    const tbody = document.getElementById('tbodyUsuarios');
    tbody.innerHTML = usuarios.map(usuario => {
        // Encontrar asignaciones activas del usuario
        const userAssignments = asignaciones.filter(a => a.id_usuario === usuario.id_usuario && a.estado_asignacion === "Asignado");
        const assignedEquipments = userAssignments.map(a => {
            // Nota: getEquipment ha sido eliminado, asumiendo que equipos es un array completo
            const equipo = equipos.find(e => e.id_equipo === a.id_equipo);
            return equipo ? `${equipo.DESCRIPCION} (${equipo.SERIAL})` : 'N/A';
        });
        return `
            <tr>
                <td>${usuario.id_usuario}</td>
                <td>${usuario.RESPONSABLE}</td>
                <td>${usuario.CEDULA}</td>
                <td>${usuario.CARGO}</td>
                <td>${usuario.SECTOR}</td>
                <td>
                    ${userAssignments.length > 0 ? `<span class="assigned-badge">${userAssignments.length}</span>` : '0'}
                    ${assignedEquipments.map(e => `<br><small>${e}</small>`).join('')}
                </td>
                <td>
                    <button class="btn btn-edit" onclick="editUser(${usuario.id_usuario})">‚úèÔ∏è</button>
                    <button class="btn btn-delete" onclick="deleteUserConfirm(${usuario.id_usuario})">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * Renderiza la lista de equipos en la tabla correspondiente
 * @param {Array} equipos - Array de objetos equipo
 * @param {Array} asignaciones - Array de objetos asignaci√≥n
 */
function renderEquipments(equipos, asignaciones) {
    const tbody = document.getElementById('tbodyEquipos');
    tbody.innerHTML = equipos.map(equipo => {
        // Encontrar asignaci√≥n activa del equipo
        const activeAssignment = asignaciones.find(a => a.id_equipo === equipo.id_equipo && a.estado_asignacion === "Asignado");
        
        // Esta l√≥gica de busqueda del usuario ha sido rota.
        // const assignedUser = activeAssignment ? usuarios.find(u => u.id_usuario === activeAssignment.id_usuario) : null;
        const assignedUser = null; // Se simula que no se encuentra por falta de la funci√≥n de IndexedDB

        const statusClass = equipo.STATUS === 'OPERATIVO' ? 'status-operativo' : 'status-inoperativo';
        const assignedBadge = assignedUser ? `<span class="assigned-badge">Asignado a ${assignedUser.RESPONSABLE}</span>` : `<span class="unassigned-badge">Libre</span>`;

        return `
            <tr>
                <td>${equipo.id_equipo}</td>
                <td>${equipo.DESCRIPCION}</td>
                <td>${equipo.MARCA}</td>
                <td>${equipo.MODELO}</td>
                <td>${equipo.SERIAL}</td>
                <td><span class="${statusClass}">${equipo.STATUS}</span></td>
                <td>${assignedBadge}</td>
                <td>
                    <button class="btn btn-edit" onclick="editEquipment(${equipo.id_equipo})">‚úèÔ∏è</button>
                    <button class="btn btn-delete" onclick="deleteEquipmentConfirm(${equipo.id_equipo})">üóëÔ∏è</button>
                    ${!assignedUser ? `<button class="btn btn-add" onclick="assignEquipment(${equipo.id_equipo})" style="padding: 4px 8px; font-size: 10px;">üîó Asignar</button>` : ''}
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * Renderiza la lista de asignaciones en la tabla correspondiente
 * @param {Array} asignaciones - Array de objetos asignaci√≥n
 * @param {Array} usuarios - Array de objetos usuario
 * @param {Array} equipos - Array de objetos equipo
 */
function renderAssignments(asignaciones, usuarios, equipos) {
    const tbody = document.getElementById('tbodyAsignaciones');
    tbody.innerHTML = asignaciones.map(asignacion => {
        // Nota: getUser y getEquipment han sido eliminados/simulados, se usa el array completo
        const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
        const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);
        return `
            <tr>
                <td>${asignacion.id_asignacion}</td>
                <td>${usuario ? `<strong>${usuario.RESPONSABLE}</strong><br><small>${usuario.SECTOR}</small>` : 'N/A'}</td>
                <td>${equipo ? `<strong>${equipo.DESCRIPCION}</strong><br>${equipo.MARCA} ${equipo.MODELO}` : 'N/A'}</td>
                <td><strong>${equipo ? equipo.SERIAL : 'N/A'}</strong></td>
                <td>${asignacion.fecha_asignacion || 'N/A'}</td>
                <td>
                    <span class="${asignacion.estado_asignacion === 'Asignado' ? 'assigned-badge' : 'unassigned-badge'}">
                        ${asignacion.estado_asignacion}
                    </span>
                </td>
                <td>
                    <button class="btn btn-edit" onclick="editAssignment(${asignacion.id_asignacion})">‚úèÔ∏è</button>
                    <button class="btn btn-delete" onclick="deleteAssignmentConfirm(${asignacion.id_asignacion})">üóëÔ∏è</button>
                </td>
            </tr>
        `;
    }).join('');
}

// =============================================
// FUNCIONES DE INTERFAZ Y NAVEGACI√ìN
// =============================================
/**
 * Muestra una pesta√±a espec√≠fica y oculta las dem√°s
 * @param {string} tabName - Nombre de la pesta√±a a mostrar
 */
function showTab(tabName) {
    // Ocultar todas las pesta√±as
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });

    // Desactivar todos los botones de navegaci√≥n
    document.querySelectorAll('.nav button').forEach(button => {
        button.classList.remove('active');
    });

    // Mostrar la pesta√±a seleccionada
    document.getElementById(tabName).classList.add('active');

    // Activar el bot√≥n de navegaci√≥n correspondiente
    document.querySelector(`.nav button[onclick="showTab('${tabName}')"]`).classList.add('active');
}

// =============================================
// MANEJO DE MODALES
// =============================================

// Modales de usuario
async function openUserModal(id) {
    document.getElementById('userModalTitle').textContent = id ? 'Editar Usuario' : 'Agregar Usuario';
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';

    if (id) {
        try {
            const user = await getUser(id); // Funci√≥n simulada de IndexedDB
            if (user) {
                document.getElementById('userId').value = user.id_usuario;
                document.getElementById('responsable').value = user.RESPONSABLE;
                document.getElementById('cedula').value = user.CEDULA;
                document.getElementById('cargo').value = user.CARGO;
                document.getElementById('sector').value = user.SECTOR;
            }
        } catch (error) {
            console.error('Error editando usuario:', error);
            alert('Error al cargar datos del usuario');
        }
    }
    document.getElementById('userModal').style.display = 'block';
}

function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
}

async function deleteUserConfirm(id) {
    if (confirm('¬øEst√° seguro de que desea eliminar este usuario? Todas sus asignaciones ser√°n marcadas como Retiradas.')) {
        try {
            // Nota: deleteUser y getAllAssignmentsByUser son ahora simuladas/eliminadas.
            // Esta l√≥gica DEBE ser implementada con Supabase.
            // Simulamos la eliminaci√≥n (que fallar√° si no hay implementaci√≥n de Supabase)
            await deleteUser(id); 
            // await deleteAssignmentsByUserId(id); // Funci√≥n IndexedDB eliminada
            
            loadAllData();
        } catch (error) {
            console.error('Error eliminando usuario:', error);
            alert('Error al eliminar el usuario');
        }
    }
}

// Modales de equipo
async function openEquipmentModal(id) {
    document.getElementById('equipmentModalTitle').textContent = id ? 'Editar Equipo' : 'Agregar Equipo';
    document.getElementById('equipmentForm').reset();
    document.getElementById('equipmentId').value = '';

    if (id) {
        try {
            // Nota: getEquipment fue eliminado
            // Reemplazar con: const equipo = await getEquipment(id);
            alert('La funci√≥n getEquipment ha sido eliminada. Implemente Supabase para editar.');
            return;
        } catch (error) {
            console.error('Error editando equipo:', error);
            alert('Error al cargar datos del equipo');
        }
    }
    document.getElementById('equipmentModal').style.display = 'block';
}

function closeEquipmentModal() {
    document.getElementById('equipmentModal').style.display = 'none';
}

async function editEquipment(id) {
    try {
        // Nota: getEquipment fue eliminado.
        // const equipo = await getEquipment(id);
        alert('La funci√≥n getEquipment ha sido eliminada. Implemente Supabase para editar.');
        return;
    } catch (error) {
        console.error('Error editando equipo:', error);
        alert('Error al cargar datos del equipo');
    }
}

async function deleteEquipmentConfirm(id) {
    if (confirm('¬øEst√° seguro de que desea eliminar este equipo? Tambi√©n se eliminar√°n sus asignaciones.')) {
        try {
            // Nota: deleteAssignment, getAssignmentByEquipment y deleteEquipment fueron eliminados.
            alert('Las funciones de eliminaci√≥n de equipos/asignaciones han sido eliminadas. Implemente Supabase para eliminar.');
            // await deleteEquipment(id);
            // loadAllData();
        } catch (error) {
            console.error('Error eliminando equipo:', error);
            alert('Error al eliminar el equipo');
        }
    }
}


// Modales de asignaci√≥n
async function openAssignmentModal(equipmentId = null) {
    try {
        // Nota: getAllUsers y getAllAssignments fueron simulados/eliminados
        // Reemplazar con llamadas a Supabase.
        const [usuarios, equipos] = await Promise.all([
            getAllUsers(), // Funci√≥n simulada de IndexedDB
            getAllEquipments ? getAllEquipments() : Promise.resolve([]) // Funci√≥n eliminada
        ]);

        const usuarioSelect = document.getElementById('assignmentUsuario');
        const equipoSelect = document.getElementById('assignmentEquipo');
        usuarioSelect.innerHTML = '<option value="">Seleccionar usuario</option>';
        equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';

        usuarios.forEach(usuario => {
            usuarioSelect.innerHTML += `<option value="${usuario.id_usuario}">${usuario.RESPONSABLE} - ${usuario.SECTOR}</option>`;
        });
        
        // La l√≥gica de equipos disponibles est√° rota porque getAllAssignments fue eliminado
        /*
        const asignaciones = await getAllAssignments();
        const equiposAsignados = new Set(asignaciones.filter(a => a.estado_asignacion === "Asignado").map(a => a.id_equipo));
        equipos.filter(equipo => !equiposAsignados.has(equipo.id_equipo)).forEach(equipo => {
            equipoSelect.innerHTML += `<option value="${equipo.id_equipo}">${equipo.DESCRIPCION} - ${equipo.MARCA} (${equipo.SERIAL})</option>`;
        });
        */
        
        // Temporalmente llenamos con todos los equipos (si equipos no es nulo)
        if (equipos) {
            equipos.forEach(equipo => {
                 equipoSelect.innerHTML += `<option value="${equipo.id_equipo}">${equipo.DESCRIPCION} - ${equipo.MARCA} (${equipo.SERIAL})</option>`;
            });
        }


        // Si se pasa un equipmentId, seleccionarlo autom√°ticamente
        if (equipmentId) {
            equipoSelect.value = equipmentId;
            updateEquipmentDetails();
        }

        document.getElementById('assignmentModalTitle').textContent = 'Nueva Asignaci√≥n';
        document.getElementById('assignmentForm').reset();
        document.getElementById('assignmentId').value = '';
        document.getElementById('assignmentEstado').value = 'Asignado';
        document.getElementById('assignmentModal').style.display = 'block';
    } catch (error) {
        console.error('Error abriendo modal de asignaci√≥n:', error);
        alert('Error al cargar datos para la asignaci√≥n');
    }
}

/**
 * Cierra el modal de asignaci√≥n
 */
function closeAssignmentModal() {
    document.getElementById('assignmentModal').style.display = 'none';
    document.getElementById('equipmentDetails').style.display = 'none';
}

/**
 * Actualiza la lista de equipos disponibles seg√∫n el usuario seleccionado
 */
async function updateAvailableEquipments() {
    const usuarioId = document.getElementById('assignmentUsuario').value;
    const equipoSelect = document.getElementById('assignmentEquipo');

    if (!usuarioId) {
        equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';
        return;
    }

    try {
        // La l√≥gica de equipos disponibles est√° rota porque getAllEquipments y getAllAssignments fueron eliminados.
        alert('La l√≥gica de equipos disponibles ha sido eliminada. Implemente Supabase para la selecci√≥n.');
        equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';
        return;

    } catch (error) {
        console.error('Error actualizando equipos disponibles:', error);
    }
}

/**
 * Muestra los detalles del equipo seleccionado en el modal de asignaci√≥n
 */
async function updateEquipmentDetails() {
    const equipoId = document.getElementById('assignmentEquipo').value;
    const detailsDiv = document.getElementById('equipmentDetails');
    detailsDiv.style.display = 'none';
    detailsDiv.innerHTML = '';

    if (equipoId) {
        try {
            // Nota: getEquipment fue eliminado
            // Reemplazar con: const equipo = await getEquipment(parseInt(equipoId));
            alert('La funci√≥n getEquipment ha sido eliminada. Implemente Supabase para ver detalles.');
            return;
        } catch (error) {
            console.error('Error obteniendo detalles del equipo:', error);
        }
    }
}

async function editAssignment(id) {
    try {
        // Nota: getAllAssignments, getAllUsers, getAllEquipments fueron simulados/eliminados
        alert('Las funciones de edici√≥n de asignaci√≥n han sido eliminadas. Implemente Supabase.');
        return;
    } catch (error) {
        console.error('Error editando asignaci√≥n:', error);
        alert('Error al cargar datos de la asignaci√≥n');
    }
}

async function deleteAssignmentConfirm(id) {
    if (confirm('¬øEst√° seguro de que desea eliminar esta asignaci√≥n?')) {
        try {
            // Nota: deleteAssignment fue eliminado.
            alert('La funci√≥n deleteAssignment ha sido eliminada. Implemente Supabase para eliminar.');
            // await deleteAssignment(id);
            // loadAllData();
        } catch (error) {
            console.error('Error eliminando asignaci√≥n:', error);
            alert('Error al eliminar la asignaci√≥n');
        }
    }
}

/**
 * Actualiza las estad√≠sticas del dashboard
 * @param {Array} usuarios - Array de objetos usuario
 * @param {Array} equipos - Array de objetos equipo
 * @param {Array} asignaciones - Array de objetos asignaci√≥n
 */
async function updateStats(usuarios = [], equipos = [], asignaciones = []) {
    try {
        // Los datos se pasan directamente desde loadAllData (que ahora tiene arrays vac√≠os)
        document.getElementById('totalUsuarios').textContent = usuarios.length;
        document.getElementById('totalEquipos').textContent = equipos.length;
        
        const operativos = equipos.filter(e => e.STATUS === 'OPERATIVO').length;
        document.getElementById('equiposOperativos').textContent = operativos;
        
        const asignados = asignaciones.filter(a => a.estado_asignacion === 'Asignado').length;
        document.getElementById('equiposAsignados').textContent = asignados;

        // Renderizar √∫ltimas asignaciones (ejemplo: las 5 m√°s recientes)
        const ultimasAsignaciones = asignaciones
            .sort((a, b) => new Date(b.fecha_asignacion) - new Date(a.fecha_asignacion))
            .slice(0, 5);

        const ultimasAsignacionesDiv = document.getElementById('ultimasAsignaciones');
        if (ultimasAsignaciones.length === 0) {
            ultimasAsignacionesDiv.innerHTML = '<p style="text-align: center; padding: 20px;">No hay asignaciones recientes.</p>';
            return;
        }

        ultimasAsignacionesDiv.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Usuario</th>
                        <th>Equipo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    ${ultimasAsignaciones.map(asignacion => {
                        const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
                        const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);
                        return `
                            <tr>
                                <td>${asignacion.fecha_asignacion || 'N/A'}</td>
                                <td>${usuario ? usuario.RESPONSABLE : 'N/A'}</td>
                                <td>${equipo ? `${equipo.DESCRIPCION} (${equipo.SERIAL})` : 'N/A'}</td>
                                <td>
                                    <span class="${asignacion.estado_asignacion === 'Asignado' ? 'assigned-badge' : 'unassigned-badge'}">
                                        ${asignacion.estado_asignacion}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        console.error('Error actualizando estad√≠sticas:', error);
    }
}

// Filtrar tablas
function filterTable(tableType) {
    const input = document.getElementById(`search${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
    const filter = input.value.toLowerCase();
    const table = document.getElementById(`tabla${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td');
        let found = false;
        for (let j = 0; j < td.length; j++) {
            if (td[j]) {
                if (td[j].textContent.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }
        tr[i].style.display = found ? '' : 'none';
    }
}

// B√∫squeda global
async function globalSearch() {
    const filter = document.getElementById('globalSearch').value.toLowerCase();
    if (!filter) {
        updateStats();
        return;
    }

    try {
        // Los datos se obtienen de funciones simuladas (deben ser Supabase)
        const [usuarios, equipos, asignaciones] = await Promise.all([
            getAllUsers(), // Funci√≥n simulada de IndexedDB
            getAllEquipments ? getAllEquipments() : Promise.resolve([]), // Funci√≥n eliminada
            getAllAssignments ? getAllAssignments() : Promise.resolve([]) // Funci√≥n eliminada
        ]);

        const usuariosFiltrados = usuarios.filter(usuario => 
            Object.values(usuario).some(val => val.toString().toLowerCase().includes(filter)
        ));

        const equiposFiltrados = equipos.filter(equipo => 
            Object.values(equipo).some(val => val.toString().toLowerCase().includes(filter)
        ));

        const asignacionesFiltradas = asignaciones.filter(asignacion => {
            const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
            const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);
            
            const matchesUsuario = usuario && Object.values(usuario).some(val => val.toString().toLowerCase().includes(filter));
            const matchesEquipo = equipo && Object.values(equipo).some(val => val.toString().toLowerCase().includes(filter));
            
            return matchesUsuario || matchesEquipo || Object.values(asignacion).some(val => val.toString().toLowerCase().includes(filter));
        });

        // Simplemente renderizamos lo filtrado
        renderUsers(usuariosFiltrados, equipos, asignaciones);
        renderEquipments(equiposFiltrados, asignaciones);
        renderAssignments(asignacionesFiltradas, usuarios, equipos);
        
        // Actualizar estad√≠sticas basadas en el filtro (simulaci√≥n)
        document.getElementById('totalUsuarios').textContent = usuariosFiltrados.length;
        document.getElementById('totalEquipos').textContent = equiposFiltrados.length;
        document.getElementById('equiposOperativos').textContent = equiposFiltrados.filter(e => e.STATUS === 'OPERATIVO').length;
        document.getElementById('equiposAsignados').textContent = asignacionesFiltradas.length;

    } catch (error) {
        console.error('Error en b√∫squeda global:', error);
    }
}

// Exportar a Excel
async function exportToExcel() {
    try {
        // Nota: Las funciones de obtenci√≥n de datos han sido eliminadas/simuladas
        const [usuarios, equipos, asignaciones] = await Promise.all([
            getAllUsers(), // Funci√≥n simulada de IndexedDB
            getAllEquipments ? getAllEquipments() : Promise.resolve([]), // Funci√≥n eliminada
            getAllAssignments ? getAllAssignments() : Promise.resolve([]) // Funci√≥n eliminada
        ]);

        const wb = XLSX.utils.book_new();

        // Hoja de usuarios
        const wsUsuarios = XLSX.utils.json_to_sheet(usuarios.map(u => ({
            ID_USUARIO: u.id_usuario,
            RESPONSABLE: u.RESPONSABLE,
            CEDULA: u.CEDULA,
            CARGO: u.CARGO,
            SECTOR: u.SECTOR
        })));
        XLSX.utils.book_append_sheet(wb, wsUsuarios, "Usuarios");

        // Hoja de equipos
        const wsEquipos = XLSX.utils.json_to_sheet(equipos.map(e => ({
            ID_EQUIPO: e.id_equipo,
            DESCRIPCION: e.DESCRIPCION,
            MARCA: e.MARCA,
            MODELO: e.MODELO,
            SERIAL: e.SERIAL,
            ETIQUETA: e.ETIQUETA,
            STATUS: e.STATUS,
            OBSERVACIONES: e.OBSERVACIONES
        })));
        XLSX.utils.book_append_sheet(wb, wsEquipos, "Equipos");

        // Hoja de asignaciones
        const wsAsignaciones = XLSX.utils.json_to_sheet(asignaciones.map(a => {
            const usuario = usuarios.find(u => u.id_usuario === a.id_usuario);
            const equipo = equipos.find(e => e.id_equipo === a.id_equipo);
            return {
                ID_ASIGNACION: a.id_asignacion,
                ID_USUARIO: a.id_usuario,
                USUARIO: usuario ? usuario.RESPONSABLE : 'N/A',
                ID_EQUIPO: a.id_equipo,
                EQUIPO: equipo ? `${equipo.DESCRIPCION} - ${equipo.MARCA}` : 'N/A',
                SERIAL_EQUIPO: equipo ? equipo.SERIAL : 'N/A',
                FECHA_ASIGNACION: a.fecha_asignacion,
                ESTADO_ASIGNACION: a.estado_asignacion
            };
        }));
        XLSX.utils.book_append_sheet(wb, wsAsignaciones, "Asignaciones");

        // Descargar archivo
        XLSX.writeFile(wb, `inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
    } catch (error) {
        console.error('Error exportando a Excel:', error);
        alert('Error al exportar los datos a Excel');
    }
}

// Descargar plantilla MEJORADA
function downloadTemplate() {
    const wb = XLSX.utils.book_new();

    // Plantilla de usuarios CON ENCABEZADOS CORRECTOS
    const usuariosData = [{ "RESPONSABLE": "EJEMPLO: MARIA GONZALEZ", "CEDULA": "EJEMPLO: 12345678", "CARGO": "EJEMPLO: Supervisor", "SECTOR": "EJEMPLO: MANTENIMIENTO" }];
    const wsUsuarios = XLSX.utils.json_to_sheet(usuariosData, { header: ["RESPONSABLE", "CEDULA", "CARGO", "SECTOR"] });
    XLSX.utils.book_append_sheet(wb, wsUsuarios, "Usuarios");

    // Plantilla de equipos
    const equiposData = [{ "DESCRIPCION": "EJEMPLO: LAPTOP", "MARCA": "EJEMPLO: DELL", "MODELO": "EJEMPLO: Latitude E7470", "SERIAL": "EJEMPLO: ABC123456", "ETIQUETA": "EJEMPLO: INV-001", "STATUS": "OPERATIVO", "OBSERVACIONES": "EJEMPLO: En buen estado" }];
    const wsEquipos = XLSX.utils.json_to_sheet(equiposData, { header: ["DESCRIPCION", "MARCA", "MODELO", "SERIAL", "ETIQUETA", "STATUS", "OBSERVACIONES"] });
    XLSX.utils.book_append_sheet(wb, wsEquipos, "Equipos");

    // Plantilla de asignaciones (para re-asignaciones o hist√≥rico)
    const asignacionesData = [{ "ID_USUARIO": "EJEMPLO: 1 (ID que exista)", "ID_EQUIPO": "EJEMPLO: 1 (ID que exista)", "ESTADO_ASIGNACION": "Asignado", "FECHA_ASIGNACION": "YYYY-MM-DD" }];
    const wsAsignaciones = XLSX.utils.json_to_sheet(asignacionesData, { header: ["ID_USUARIO", "ID_EQUIPO", "ESTADO_ASIGNACION", "FECHA_ASIGNACION"] });
    XLSX.utils.book_append_sheet(wb, wsAsignaciones, "Asignaciones");

    XLSX.writeFile(wb, "inventario_plantilla.xlsx");
}

// Importar desde Excel MEJORADA
async function importFromExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            let importedCount = 0;
            const errors = [];

            // IMPORTAR USUARIOS
            if (workbook.Sheets["Usuarios"]) {
                const usuariosData = XLSX.utils.sheet_to_json(workbook.Sheets["Usuarios"]);
                for (const user of usuariosData) {
                    // Verificar que no sea la fila de ejemplo
                    if (user.RESPONSABLE && !user.RESPONSABLE.includes("EJEMPLO:")) {
                        try {
                            // Nota: addUser fue simulado
                            await addUser({
                                RESPONSABLE: user.RESPONSABLE || "",
                                CEDULA: user.CEDULA || "",
                                CARGO: user.CARGO || "",
                                SECTOR: user.SECTOR || ""
                            });
                            importedCount++;
                        } catch (error) {
                            errors.push(`Error en usuario ${user.RESPONSABLE}: ${error.message}`);
                        }
                    }
                }
            } else {
                errors.push("No se encontr√≥ la hoja 'Usuarios'");
            }

            // IMPORTAR EQUIPOS
            if (workbook.Sheets["Equipos"]) {
                const equiposData = XLSX.utils.sheet_to_json(workbook.Sheets["Equipos"]);
                for (const equipo of equiposData) {
                    // Verificar que no sea la fila de ejemplo
                    if (equipo.DESCRIPCION && !equipo.DESCRIPCION.includes("EJEMPLO:") && !equipo.DESCRIPCION.includes("LAPTOP")) {
                        try {
                            // Nota: addEquipment y getEquipmentBySerial fueron eliminados
                            alert('Las funciones de equipos (addEquipment/getEquipmentBySerial) han sido eliminadas. Implemente Supabase para importar.');
                            // Aqu√≠ ir√≠a la l√≥gica de Supabase
                        } catch (error) {
                            errors.push(`Error en equipo ${equipo.DESCRIPCION}: ${error.message}`);
                        }
                    }
                }
            } else {
                errors.push("No se encontr√≥ la hoja 'Equipos'");
            }
            
            // IMPORTAR ASIGNACIONES - CORREGIDO (despu√©s de usuarios y equipos)
            if (workbook.Sheets["Asignaciones"]) {
                // Esperar a que se importen usuarios y equipos primero
                const [usuarios, equipos] = await Promise.all([
                    getAllUsers(), // Funci√≥n simulada de IndexedDB
                    getAllEquipments ? getAllEquipments() : Promise.resolve([]) // Funci√≥n eliminada
                ]);
                
                const asignacionesData = XLSX.utils.sheet_to_json(workbook.Sheets["Asignaciones"]);
                for (const asignacion of asignacionesData) {
                    if (asignacion.ID_USUARIO && !asignacion.ID_USUARIO.includes("EJEMPLO:")) {
                        try {
                            // Nota: addAssignment fue eliminado
                            alert('La funci√≥n addAssignment ha sido eliminada. Implemente Supabase para importar asignaciones.');
                             // Aqu√≠ ir√≠a la l√≥gica de Supabase
                        } catch (error) {
                            errors.push(`Error en asignaci√≥n de usuario ${asignacion.ID_USUARIO}: ${error.message}`);
                        }
                    }
                }
            } else {
                errors.push("No se encontr√≥ la hoja 'Asignaciones'");
            }


            loadAllData();
            
            let message = `Importaci√≥n finalizada. ${importedCount} registros de usuarios procesados.`;
            if (errors.length > 0) {
                message += ` ${errors.length} errores encontrados. Verifique la consola para detalles.`;
                console.error('Errores durante la importaci√≥n:', errors);
            }
            alert(message);
        } catch (error) {
            console.error('Error al importar desde Excel:', error);
            alert('Error al importar los datos desde Excel: ' + error.message);
        }
    };
    reader.readAsArrayBuffer(file);
    // Limpiar el input file para permitir la re-selecci√≥n del mismo archivo
    event.target.value = null; 
}


// MANEJO DE FORMULARIOS

// Manejo del formulario de usuario
document.getElementById('userForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const user = {
        RESPONSABLE: document.getElementById('responsable').value,
        CEDULA: document.getElementById('cedula').value,
        CARGO: document.getElementById('cargo').value,
        SECTOR: document.getElementById('sector').value
    };
    const userId = document.getElementById('userId').value;

    try {
        if (userId) {
            user.id_usuario = parseInt(userId);
            await updateUser(user); // Funci√≥n simulada de IndexedDB
        } else {
            await addUser(user); // Funci√≥n simulada de IndexedDB
        }
        closeUserModal();
        loadAllData();
    } catch (error) {
        console.error('Error guardando usuario:', error);
        alert('Error al guardar el usuario');
    }
});

// Manejo del formulario de equipo
document.getElementById('equipmentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const equipment = {
        DESCRIPCION: document.getElementById('descripcion').value,
        MARCA: document.getElementById('marca').value,
        MODELO: document.getElementById('modelo').value,
        SERIAL: document.getElementById('serial').value,
        ETIQUETA: document.getElementById('etiqueta').value,
        STATUS: document.getElementById('status').value,
        OBSERVACIONES: document.getElementById('observaciones').value
    };
    const equipmentId = document.getElementById('equipmentId').value;

    try {
        // Nota: addEquipment, updateEquipment y getEquipmentBySerial fueron eliminados
        alert('Las funciones de equipos (addEquipment/updateEquipment/getEquipmentBySerial) han sido eliminadas. Implemente Supabase para guardar.');
        // Aqu√≠ ir√≠a la l√≥gica de Supabase
        closeEquipmentModal();
        // loadAllData();
    } catch (error) {
        console.error('Error guardando equipo:', error);
        alert('Error al guardar el equipo');
    }
});

// Manejo del formulario de asignaci√≥n
document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const assignment = {
        id_usuario: parseInt(document.getElementById('assignmentUsuario').value),
        id_equipo: parseInt(document.getElementById('assignmentEquipo').value),
        fecha_asignacion: new Date().toISOString().split('T')[0],
        estado_asignacion: document.getElementById('assignmentEstado').value
    };
    const assignmentId = document.getElementById('assignmentId').value;

    try {
        // Nota: addAssignment, updateAssignment y getAssignmentByEquipment fueron eliminados
        alert('Las funciones de asignaci√≥n (addAssignment/updateAssignment/getAssignmentByEquipment) han sido eliminadas. Implemente Supabase para guardar.');
        // Aqu√≠ ir√≠a la l√≥gica de Supabase
        closeAssignmentModal();
        // loadAllData();
    } catch (error) {
        console.error('Error guardando asignaci√≥n:', error);
        alert('Error al guardar la asignaci√≥n');
    }
});

// Event listener para mostrar detalles del equipo
document.getElementById('assignmentEquipo').addEventListener('change', updateEquipmentDetails);


// Cerrar modales al hacer clic fuera
window.onclick = function(event) {
    const modals = document.getElementsByClassName('modal');
    for (let modal of modals) {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    }
}

// =============================================
// INICIALIZACI√ìN COMBINADA
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM cargado. Inicializando Sistema de Inventario PWA...');
    
    // Solucionar el "flash" de contenido sin estilo
    document.body.style.visibility = 'visible';
    
    // Inicializar PWA primero (modo b√°sico para GitHub Pages)
    try {
        setupPWA();
        console.log('‚úÖ PWA inicializada (modo b√°sico)');
    } catch (pwaError) {
        console.error('‚ùå Error inicializando PWA:', pwaError);
        updatePWAStatus('‚ùå Error PWA');
    }
    
    // Inicializar base de datos
    try {
        initDatabase(); // Esta es una funci√≥n simulada de IndexedDB, debe ser reemplazada por la inicializaci√≥n de Supabase
        console.log('‚úÖ Base de datos inicializada');
    } catch (dbError) {
        console.error('‚ùå Error inicializando base de datos:', dbError);
    }
    
    // Configurar funcionalidad offline
    setupOfflineFunctionality();
    
    // Configurar notificaciones
    setupNotifications();
    
    console.log('üéâ Sistema de Inventario PWA completamente inicializado');
    
    // Intentar Service Worker b√°sico despu√©s de la carga inicial
    setTimeout(tryRegisterServiceWorker, 1000);
});

// Manejar el evento antes de descargar la p√°gina
window.addEventListener('beforeunload', function() {
    console.log('üíæ Guardando estado de la aplicaci√≥n...');
    // Aqu√≠ podr√≠as guardar el estado actual si es necesario
});

// Manejar el evento de carga completa
window.addEventListener('load', function() {
    console.log('üìÑ Ventana completamente cargada. Iniciando carga de datos...');
    initializeData();
});
</script>
</body>
</html>
