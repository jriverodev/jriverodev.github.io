<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario</title>

    <meta name="theme-color" content="#2c3e50"/>
    <meta name="description" content="Sistema de Gesti√≥n de Inventario - PWA">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMmMzZTUwIi8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPklOVjwvdGV4dD4KPC9zdmc+">
    <meta name="apple-mobile-web-app-status-bar" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos CSS para la interfaz del sistema */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav {
            display: flex;
            background: #34495e;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .nav button {
            flex: 1;
            padding: 15px;
            border: none;
            background: #34495e;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
            min-width: 120px;
        }

        .nav button:hover {
            background: #2c3e50;
        }

        .nav button.active {
            background: #3498db;
            font-weight: bold;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #34495e;
            color: white;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-add {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            margin-bottom: 15px;
        }

        .btn-export {
            background: #9b59b6;
            color: white;
        }

        .btn-import {
            background: #e67e22;
            color: white;
        }

        .btn-download-template {
            background: #34495e;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-actions {
            text-align: right;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .btn-save {
            background: #3498db;
            color: white;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #e67e22;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .import-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .equipment-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
            }
            
            .nav button {
                padding: 12px;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            th, td {
                padding: 8px;
                font-size: 14px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .header-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
            border-top: 1px solid #e9ecef;
        }

        .status-operativo {
            color: #27ae60;
            font-weight: bold;
        }

        .status-inoperativo {
            color: #e74c3c;
            font-weight: bold;
        }

        .assigned-badge {
            background: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .unassigned-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* ... (TODOS TUS ESTILOS ACTUALES SE MANTIENEN) ... */

        /* === ESTILOS PWA ADICIONALES === */
        .pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 14px;
        }

        .pwa-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }

        .offline-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #e74c3c;
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 1001;
            display: none;
        }

        @media (max-width: 768px) {
            .pwa-install-btn {
                bottom: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="offline-warning" id="offlineWarning">
        ‚ö†Ô∏è Est√°s trabajando sin conexi√≥n
    </div>
    
    <div class="pwa-status" id="pwaStatus">
        üì± PWA Lista
    </div>
    
    <button class="pwa-install-btn" id="pwaInstallBtn">
        üì≤ Instalar App
    </button>
    
    <div class="container">
        <div class="header">
            <h1>üì± Sistema de Inventario</h1>
            <p>Gesti√≥n completa de inventario</p>
            <div class="header-actions">
                <button class="btn btn-export" onclick="exportToExcel()">üìä Exportar a Excel</button>
                </div>
        </div>

        <div class="nav">
            <button onclick="showTab('dashboard')" class="active">üìä Dashboard</button>
            <button onclick="showTab('usuarios')">üë• Usuarios</button>
            <button onclick="showTab('equipos')">üíª Equipos</button>
            <button onclick="showTab('asignaciones')">üîó Asignaciones</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsuarios">0</div>
                        <div class="stat-label">Total Usuarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEquipos">0</div>
                        <div class="stat-label">Total Equipos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="equiposOperativos">0</div>
                        <div class="stat-label">Equipos Operativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="equiposAsignados">0</div>
                        <div class="stat-label">Equipos Asignados</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="globalSearch" placeholder="üîç Buscar en todo el inventario..." onkeyup="globalSearch()">
                </div>

                <h3>√öltimas Asignaciones</h3>
                <div id="ultimasAsignaciones" class="table-container">
                    </div>
            </div>

            <div id="usuarios" class="tab-content">
                <button class="btn btn-add" onclick="openUserModal()">‚ûï Agregar Usuario</button>
                <div class="search-box">
                    <input type="text" id="searchUsuarios" placeholder="üîç Buscar usuarios..." onkeyup="filterTable('usuarios')">
                </div>
                <div class="table-container">
                    <table id="tablaUsuarios">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Responsable</th>
                                <th>C√©dula</th>
                                <th>Cargo</th>
                                <th>Sector</th>
                                <th>Equipos Asignados</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyUsuarios">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="equipos" class="tab-content">
                <button class="btn btn-add" onclick="openEquipmentModal()">‚ûï Agregar Equipo</button>
                <div class="search-box">
                    <input type="text" id="searchEquipos" placeholder="üîç Buscar equipos..." onkeyup="filterTable('equipos')">
                </div>
                <div class="table-container">
                    <table id="tablaEquipos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descripci√≥n</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Serial</th>
                                <th>Status</th>
                                <th>Asignado a</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyEquipos">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="asignaciones" class="tab-content">
                <button class="btn btn-add" onclick="openAssignmentModal()">‚ûï Nueva Asignaci√≥n</button>
                <div class="search-box">
                    <input type="text" id="searchAsignaciones" placeholder="üîç Buscar asignaciones..." onkeyup="filterTable('asignaciones')">
                </div>
                <div class="table-container">
                    <table id="tablaAsignaciones">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Equipo</th>
                                <th>Serial Equipo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyAsignaciones">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Sistema de Inventario - RIVEROJDU</p>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <h3 id="userModalTitle">Agregar Usuario</h3>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Responsable:</label>
                    <input type="text" id="responsable" required>
                </div>
                <div class="form-group">
                    <label>C√©dula:</label>
                    <input type="text" id="cedula">
                </div>
                <div class="form-group">
                    <label>Cargo:</label>
                    <input type="text" id="cargo">
                </div>
                <div class="form-group">
                    <label>Sector:</label>
                    <input type="text" id="sector" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeUserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="equipmentModal" class="modal">
        <div class="modal-content">
            <h3 id="equipmentModalTitle">Agregar Equipo</h3>
            <form id="equipmentForm">
                <input type="hidden" id="equipmentId">
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <input type="text" id="descripcion" required>
                </div>
                <div class="form-group">
                    <label>Marca:</label>
                    <input type="text" id="marca" required>
                </div>
                <div class="form-group">
                    <label>Modelo:</label>
                    <input type="text" id="modelo" required>
                </div>
                <div class="form-group">
                    <label>Serial: <small>(√önico, identifica el equipo)</small></label>
                    <input type="text" id="serial" required>
                </div>
                <div class="form-group">
                    <label>Etiqueta:</label>
                    <input type="text" id="etiqueta">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="status" required>
                        <option value="OPERATIVO">OPERATIVO</option>
                        <option value="INOPERATIVO">INOPERATIVO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="observaciones" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeEquipmentModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <h3 id="assignmentModalTitle">Nueva Asignaci√≥n</h3>
            <form id="assignmentForm">
                <input type="hidden" id="assignmentId">
                <div class="form-group">
                    <label>Usuario:</label>
                    <select id="assignmentUsuario" required onchange="updateAvailableEquipments()">
                        <option value="">Seleccionar usuario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Equipo:</label>
                    <select id="assignmentEquipo" required onchange="updateEquipmentDetails()">
                        <option value="">Seleccionar equipo</option>
                    </select>
                    <div id="equipmentDetails" class="equipment-info" style="display: none;">
                        </div>
                </div>
                <div class="form-group">
                    <label>Estado:</label>
                    <select id="assignmentEstado" required>
                        <option value="Asignado">Asignado</option>
                        <option value="Retirado">Retirado</option>
                        <option value="En Reparaci√≥n">En Reparaci√≥n</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeAssignmentModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
  // =============================================
// CONFIGURACI√ìN PWA PARA GITHUB PAGES
// =============================================

// Manifest din√°mico para PWA
// =============================================
// CONFIGURACI√ìN PWA CON TUS ICONOS PNG
// =============================================

const manifest = {
    "name": "Sistema de Inventario",
    "short_name": "InventarioPWA", 
    "description": "Sistema de gesti√≥n de inventario completo con usuarios, equipos y asignaciones",
    "start_url": ".",
    "scope": "/",
    "display": "standalone",
    "background_color": "#ffffff",
    "theme_color": "#2c3e50",
    "orientation": "any",
    "categories": ["business", "productivity", "utilities"],
    "icons": [
        {
            "src": "content/icons/android/android-launchericon-192-192.png",
            "sizes": "192x192",
            "type": "image/png",
            "purpose": "any"
        },
        {
            "src": "content/icons/android/android-launchericon-512-512.png",
            "sizes": "512x512",
            "type": "image/png",
            "purpose": "any"
        }
    ],
    "screenshots": [
        {
            "src": "content/icons/windows11/Wide310x150Logo.scale-400.png",
            "sizes": "1240x600",
            "type": "image/png",
            "form_factor": "wide",
            "label": "Dashboard del Sistema de Inventario"
        }
    ]
};

// Crear y agregar manifest din√°mico
function setupPWA() {
    // Crear link del manifest
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(manifestBlob);
    
    const manifestLink = document.createElement('link');
    manifestLink.rel = 'manifest';
    manifestLink.href = manifestURL;
    document.head.appendChild(manifestLink);

    console.log('‚úÖ Manifest PWA configurado');

    // En GitHub Pages usamos un enfoque simplificado sin Service Worker
    setupPWAInstall();
    setupConnectionDetection();
    
    // Marcar como PWA b√°sica (sin Service Worker)
    updatePWAStatus('‚úÖ PWA B√°sica');
}

// Service Worker ALTERNATIVO - Solo para HTTPS tradicional
function tryRegisterServiceWorker() {
    // Solo intentar en entornos que soporten Service Workers correctamente
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
        try {
            // Intentar registrar un Service Worker muy b√°sico
            const swContent = `
                self.addEventListener('install', (event) => {
                    console.log('üì¶ PWA Installado');
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', (event) => {
                    console.log('‚úÖ PWA Activado');
                    event.waitUntil(self.clients.claim());
                });
                
                // Cache b√°sico para recursos cr√≠ticos
                self.addEventListener('fetch', (event) => {
                    // Estrategia de cache b√°sica
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => response || fetch(event.request))
                    );
                });
            `;
            
            const swBlob = new Blob([swContent], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);
            
            navigator.serviceWorker.register(swURL, { scope: './' })
                .then(registration => {
                    console.log('‚úÖ Service Worker registrado (b√°sico)');
                    updatePWAStatus('‚úÖ PWA Completa');
                })
                .catch(error => {
                    console.log('‚ö†Ô∏è Service Worker no disponible en este entorno');
                    // No es cr√≠tico - continuar sin SW
                });
                
        } catch (error) {
            console.log('‚ö†Ô∏è Entorno no compatible con Service Worker');
        }
    } else {
        console.log('üåê Modo PWA B√°sica (sin Service Worker)');
    }
}

// Instalaci√≥n de PWA MEJORADA
function setupPWAInstall() {
    let deferredPrompt;
    const installBtn = document.getElementById('pwaInstallBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
        updatePWAStatus('üì± Lista para instalar');
        console.log('üì± App lista para instalaci√≥n');
        
        // Mostrar por 30 segundos
        setTimeout(() => {
            if (installBtn.style.display !== 'none') {
                installBtn.style.display = 'none';
                console.log('‚è∞ Bot√≥n de instalaci√≥n ocultado');
            }
        }, 30000);
    });

    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            installBtn.textContent = '‚è≥ Instalando...';
            installBtn.disabled = true;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                installBtn.textContent = '‚úÖ Instalada';
                installBtn.style.background = '#27ae60';
                updatePWAStatus('üéâ App Instalada');
                console.log('üéâ App aceptada para instalaci√≥n');
                
                setTimeout(() => {
                    installBtn.style.display = 'none';
                }, 3000);
            } else {
                installBtn.textContent = 'üì≤ Instalar App';
                installBtn.disabled = false;
                console.log('‚ùå App rechazada para instalaci√≥n');
                updatePWAStatus('üì± Instalaci√≥n cancelada');
                
                setTimeout(() => {
                    installBtn.style.display = 'none';
                }, 5000);
            }
            deferredPrompt = null;
        }
    });

    window.addEventListener('appinstalled', (evt) => {
        installBtn.style.display = 'none';
        deferredPrompt = null;
        updatePWAStatus('üéâ App Instalada');
        console.log('üéâ App instalada exitosamente');
    });
    
    // Verificar si ya est√° instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
        installBtn.style.display = 'none';
        updatePWAStatus('üì± Ejecutando como App');
        console.log('üì± Ejecut√°ndose en modo standalone');
    }
    
    // Tambi√©n verificar usando navigator.standalone (iOS)
    if (navigator.standalone) {
        installBtn.style.display = 'none';
        updatePWAStatus('üì± Ejecutando como App (iOS)');
        console.log('üì± Ejecut√°ndose en modo standalone (iOS)');
    }
}

// Detecci√≥n de conexi√≥n MEJORADA
function setupConnectionDetection() {
    const offlineWarning = document.getElementById('offlineWarning');

    function updateOnlineStatus() {
        if (navigator.onLine) {
            offlineWarning.style.display = 'none';
            updatePWAStatus(document.getElementById('pwaStatus').textContent.replace('‚ö†Ô∏è Offline - ', ''));
            console.log('üåê Conexi√≥n restaurada');
        } else {
            offlineWarning.style.display = 'block';
            const currentStatus = document.getElementById('pwaStatus').textContent;
            if (!currentStatus.includes('Offline')) {
                updatePWAStatus('‚ö†Ô∏è Offline - ' + currentStatus);
            }
            console.log('üåê Sin conexi√≥n - Modo offline activado');
            
            // Mostrar notificaci√≥n de offline
            showOfflineNotification();
        }
    }

    function showOfflineNotification() {
        // Crear notificaci√≥n visual temporal
        const offlineMsg = document.createElement('div');
        offlineMsg.style.cssText = `
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        `;
        offlineMsg.textContent = '‚ö†Ô∏è Modo offline - Los datos se guardan localmente';
        document.body.appendChild(offlineMsg);
        
        setTimeout(() => {
            if (document.body.contains(offlineMsg)) {
                document.body.removeChild(offlineMsg);
            }
        }, 3000);
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Estado inicial
    updateOnlineStatus();
}

// Actualizar estado PWA MEJORADO
function updatePWAStatus(message) {
    const statusElement = document.getElementById('pwaStatus');
    if (statusElement) {
        statusElement.textContent = message;
        
        // Cambiar color seg√∫n estado
        if (message.includes('‚úÖ') || message.includes('üéâ')) {
            statusElement.style.background = '#27ae60';
        } else if (message.includes('‚ö†Ô∏è') || message.includes('üì±') || message.includes('üîÑ')) {
            statusElement.style.background = '#f39c12';
        } else if (message.includes('‚ùå')) {
            statusElement.style.background = '#e74c3c';
        } else {
            statusElement.style.background = '#34495e';
        }
    }
}

// Funci√≥n para simular funcionalidad offline
function setupOfflineFunctionality() {
    console.log('üîß Configurando funcionalidad offline...');
    
    // Tu base de datos IndexedDB ya proporciona almacenamiento offline
    // Aqu√≠ podr√≠as agregar l√≥gica adicional para manejo offline
    
    // Ejemplo: Guardar operaciones pendientes cuando hay conexi√≥n
    let pendingOperations = JSON.parse(localStorage.getItem('pendingOperations') || '[]');
    
    // Intentar procesar operaciones pendientes cuando hay conexi√≥n
    window.addEventListener('online', () => {
        if (pendingOperations.length > 0) {
            console.log('üîÑ Procesando operaciones pendientes:', pendingOperations.length);
            // Aqu√≠ procesar√≠as las operaciones pendientes
            pendingOperations = [];
            localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations));
        }
    });
}

// Configurar notificaciones
function setupNotifications() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            console.log('‚ÑπÔ∏è Permisos de notificaci√≥n disponibles');
        } else if (Notification.permission === 'granted') {
            console.log('üîî Notificaciones permitidas');
        }
    }
}

// Funci√≥n para mostrar notificaci√≥n
function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: body,
            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMmMzZTUwIi8+Cjx0ZXh0IHg9IjMyIiB5PSIzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SU5WPC90ZXh0Pgo8L3N2Zz4='
        });
    }
}
        
        // =============================================
        // C√ìDIGO DE PERSISTENCIA ANTERIOR (IndexedDB) ELIMINADO
        // (Incluye initDatabase, getUser, getAllUsers, y todas las funciones CRUD)
        // =============================================
        
        // =============================================
        // FUNCI√ìN DE CARGA Y RENDERIZADO (loadAllData - MODIFICADA)
        // =============================================
        
        /**
         * Carga todos los datos (usuarios, equipos, asignaciones) y actualiza la interfaz.
         * NOTA: Esta funci√≥n ha sido modificada para usar arrays vac√≠os o para llamar
         * a las nuevas funciones de persistencia que debes implementar.
         */
        async function loadAllData() {
            try {
                console.log('üîÑ loadAllData: El c√≥digo de IndexedDB fue eliminado. Implemente aqu√≠ su nueva l√≥gica de carga de datos.');
                
                // ******************************************************************
                // REEMPLAZAR ESTAS L√çNEAS con la llamada a su nuevo sistema de persistencia
                // (ej: obtener los datos de Google Sheets o el almacenamiento JSON).
                // ******************************************************************
                const usuarios = []; 
                const equipos = []; 
                const asignaciones = []; 

                // Renderizar y actualizar la interfaz
                renderUsers(usuarios, equipos, asignaciones);
                renderEquipments(equipos, usuarios, asignaciones);
                renderAssignments(asignaciones, usuarios, equipos);
                updateStats(usuarios, equipos, asignaciones);
                renderLastAssignments(asignaciones, usuarios, equipos);
                // NOTA: updateAssignmentModals fue deshabilitada temporalmente porque depende
                // de getAllEquipments y getAllAssignments en su l√≥gica interna (dentro de openAssignmentModal).

            } catch (error) {
                console.error('Error cargando todos los datos:', error);
                alert('Error al cargar los datos. Por favor, implemente el nuevo sistema de persistencia en loadAllData.');
            }
        }

        // =============================================
        // FUNCI√ìN DE POBLACI√ìN DE DATOS INICIALES (ELIMINADA)
        // =============================================

        // Se elimin√≥ la funci√≥n populateInitialData() y su l√≥gica.
        // La nueva l√≥gica de inicializaci√≥n/carga debe ir en loadAllData().


        // =============================================
        // FUNCIONES DE INTERFAZ Y NAVEGACI√ìN
        // =============================================

        /**
         * Muestra una pesta√±a espec√≠fica y oculta las dem√°s
         * @param {string} tabName - Nombre de la pesta√±a a mostrar
         */
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Remover clase active de todos los botones
            document.querySelectorAll('.nav button').forEach(button => {
                button.classList.remove('active');
            });
            // Mostrar pesta√±a seleccionada y activar bot√≥n
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Recargar datos al cambiar de pesta√±a (en caso de que la persistencia sea as√≠ncrona)
            // loadAllData(); 
        }

        /**
         * Renderiza la lista de usuarios en la tabla correspondiente
         * @param {Array} usuarios - Array de objetos usuario
         * @param {Array} equipos - Array de objetos equipo
         * @param {Array} asignaciones - Array de objetos asignaci√≥n
         */
        function renderUsers(usuarios, equipos, asignaciones) {
            const tbody = document.getElementById('tbodyUsuarios');
            tbody.innerHTML = usuarios.map(usuario => {
                // Encontrar asignaciones activas del usuario
                const userAssignments = asignaciones.filter(a => a.id_usuario === usuario.id_usuario && a.estado_asignacion === "Asignado");
                const assignedEquipments = userAssignments.map(a => {
                    const equipo = equipos.find(e => e.id_equipo === a.id_equipo);
                    return equipo ? `${equipo.DESCRIPCION} (${equipo.SERIAL})` : 'N/A';
                });
                return `
                    <tr>
                        <td>${usuario.id_usuario}</td>
                        <td>${usuario.RESPONSABLE}</td>
                        <td>${usuario.CEDULA}</td>
                        <td>${usuario.CARGO}</td>
                        <td>${usuario.SECTOR}</td>
                        <td>
                            ${userAssignments.length > 0 ? `<span class="assigned-badge">${userAssignments.length} equipo(s)</span><br> <small>${assignedEquipments.join(', ')}</small>` : '<span class="unassigned-badge">Sin equipo</span>'}
                        </td>
                        <td>
                            <button class="btn btn-edit" onclick="editUser(${usuario.id_usuario})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="deleteUserConfirm(${usuario.id_usuario})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Renderiza la lista de equipos en la tabla correspondiente
         * @param {Array} equipos - Array de objetos equipo
         * @param {Array} usuarios - Array de objetos usuario
         * @param {Array} asignaciones - Array de objetos asignaci√≥n
         */
        function renderEquipments(equipos, usuarios, asignaciones) {
            const tbody = document.getElementById('tbodyEquipos');
            tbody.innerHTML = equipos.map(equipo => {
                // Buscar la asignaci√≥n activa para el equipo
                const activeAssignment = asignaciones.find(a => a.id_equipo === equipo.id_equipo && a.estado_asignacion === "Asignado");
                const assignedUser = activeAssignment ? usuarios.find(u => u.id_usuario === activeAssignment.id_usuario) : null;
                const statusClass = equipo.STATUS === 'OPERATIVO' ? 'status-operativo' : 'status-inoperativo';
                
                return `
                    <tr>
                        <td>${equipo.id_equipo}</td>
                        <td><strong>${equipo.DESCRIPCION}</strong><br><small>${equipo.MARCA} ${equipo.MODELO}</small></td>
                        <td>${equipo.MARCA}</td>
                        <td>${equipo.MODELO}</td>
                        <td><strong>${equipo.SERIAL}</strong></td>
                        <td class="${statusClass}">${equipo.STATUS}</td>
                        <td>
                            ${assignedUser ? `
                                <span class="assigned-badge">${assignedUser.RESPONSABLE}</span>
                                <br><small>${assignedUser.SECTOR}</small>
                            ` : '<span class="unassigned-badge">Sin Asignar</span>'}
                        </td>
                        <td>
                            <button class="btn btn-edit" onclick="editEquipment(${equipo.id_equipo})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="deleteEquipmentConfirm(${equipo.id_equipo})">üóëÔ∏è</button>
                            ${!assignedUser ? `<button class="btn btn-add" onclick="assignEquipment(${equipo.id_equipo})" style="padding: 4px 8px; font-size: 10px;">üîó Asignar</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Renderiza la lista de asignaciones en la tabla correspondiente
         * @param {Array} asignaciones - Array de objetos asignaci√≥n
         * @param {Array} usuarios - Array de objetos usuario
         * @param {Array} equipos - Array de objetos equipo
         */
        function renderAssignments(asignaciones, usuarios, equipos) {
            const tbody = document.getElementById('tbodyAsignaciones');
            tbody.innerHTML = asignaciones.map(asignacion => {
                const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
                const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);
                return `
                    <tr>
                        <td>${asignacion.id_asignacion}</td>
                        <td>${usuario ? `<strong>${usuario.RESPONSABLE}</strong><br><small>${usuario.SECTOR}</small>` : 'N/A'}</td>
                        <td>${equipo ? `<strong>${equipo.DESCRIPCION}</strong><br>${equipo.MARCA} ${equipo.MODELO}` : 'N/A'}</td>
                        <td><strong>${equipo ? equipo.SERIAL : 'N/A'}</strong></td>
                        <td>${asignacion.fecha_asignacion || 'N/A'}</td>
                        <td>
                            <span class="${asignacion.estado_asignacion === 'Asignado' ? 'assigned-badge' : 'unassigned-badge'}">
                                ${asignacion.estado_asignacion}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-edit" onclick="editAssignment(${asignacion.id_asignacion})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="deleteAssignmentConfirm(${asignacion.id_asignacion})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // =============================================
        // MODALES Y FORMS (Requieren re-implementar las funciones CRUD)
        // =============================================

        /**
         * Abre el modal para agregar/editar usuario
         * @param {number} [id=null] - ID del usuario a editar
         */
        function openUserModal(id = null) {
            document.getElementById('userModalTitle').textContent = id ? 'Editar Usuario' : 'Agregar Usuario';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = id || '';
            
            if (id) {
                // NOTA: editUser llama a getUser, que fue eliminada. La funcionalidad de edici√≥n
                // estar√° rota hasta que se re-implemente getUser.
                editUser(id); 
            }
            document.getElementById('userModal').style.display = 'block';
        }

        /**
         * Cierra el modal de usuario
         */
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        /**
         * Abre el modal para agregar/editar equipo
         * @param {number} [id=null] - ID del equipo a editar
         */
        function openEquipmentModal(id = null) {
            document.getElementById('equipmentModalTitle').textContent = id ? 'Editar Equipo' : 'Agregar Equipo';
            document.getElementById('equipmentForm').reset();
            document.getElementById('equipmentId').value = id || '';
            
            if (id) {
                // NOTA: editEquipment llama a getEquipment, que fue eliminada.
                editEquipment(id);
            }
            document.getElementById('equipmentModal').style.display = 'block';
        }

        /**
         * Cierra el modal de equipo
         */
        function closeEquipmentModal() {
            document.getElementById('equipmentModal').style.display = 'none';
        }

        /**
         * Abre el modal para nueva asignaci√≥n
         * @param {number} [equipmentId=null] - ID de un equipo para precargar
         * @param {number} [assignmentId=null] - ID de la asignaci√≥n para editar
         */
        async function openAssignmentModal(equipmentId = null, assignmentId = null) {
            // NOTA: Esta funci√≥n y las que llama (updateAvailableEquipments, editAssignment)
            // dependen de las funciones getAllUsers/Equipments/Assignments eliminadas y fallar√°n
            // hasta que se re-implemente la persistencia.
            try {
                // Usar una implementaci√≥n temporal para evitar errores
                const usuarios = []; // await getAllUsers();
                const equipos = []; // await getAllEquipments();
                
                const usuarioSelect = document.getElementById('assignmentUsuario');
                const equipoSelect = document.getElementById('assignmentEquipo');
                
                usuarioSelect.innerHTML = '<option value="">Seleccionar usuario</option>';
                equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';
                
                usuarios.forEach(usuario => {
                    usuarioSelect.innerHTML += `<option value="${usuario.id_usuario}">${usuario.RESPONSABLE} - ${usuario.SECTOR}</option>`;
                });
                
                // Llenar select de equipos (solo equipos no asignados)
                // Implementaci√≥n temporal, ya que se elimin√≥ getAllAssignments()
                const equiposAsignados = new Set([]); 
                
                equipos.filter(equipo => !equiposAsignados.has(equipo.id_equipo)).forEach(equipo => {
                    equipoSelect.innerHTML += `<option value="${equipo.id_equipo}">${equipo.DESCRIPCION} - ${equipo.MARCA} (${equipo.SERIAL})</option>`;
                });

                // Si se pasa un equipmentId, seleccionarlo autom√°ticamente
                if (equipmentId) {
                    equipoSelect.value = equipmentId;
                    updateEquipmentDetails();
                }
                
                if (assignmentId) {
                    document.getElementById('assignmentModalTitle').textContent = 'Editar Asignaci√≥n';
                    // NOTA: editAssignment llama a getAllAssignments/Users/Equipments eliminadas.
                    editAssignment(assignmentId);
                } else {
                    document.getElementById('assignmentModalTitle').textContent = 'Nueva Asignaci√≥n';
                    document.getElementById('assignmentForm').reset();
                    document.getElementById('assignmentId').value = '';
                    document.getElementById('assignmentEstado').value = 'Asignado';
                }

                document.getElementById('assignmentModal').style.display = 'block';
            } catch (error) {
                console.error('Error abriendo modal de asignaci√≥n (Faltan funciones CRUD):', error);
                alert('Error al cargar datos para la asignaci√≥n. Faltan las funciones CRUD.');
            }
        }

        /**
         * Cierra el modal de asignaci√≥n
         */
        function closeAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'none';
            document.getElementById('equipmentDetails').style.display = 'none';
        }

        /**
         * Actualiza la lista de equipos disponibles seg√∫n el usuario seleccionado
         */
        async function updateAvailableEquipments() {
            const usuarioId = document.getElementById('assignmentUsuario').value;
            const equipoSelect = document.getElementById('assignmentEquipo');
            if (!usuarioId) {
                equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';
                return;
            }
            try {
                // NOTA: Depende de getAllEquipments y getAllAssignments eliminadas
                // const [equipos, asignaciones] = await Promise.all([ getAllEquipments(), getAllAssignments() ]);
                const equipos = []; 
                const asignaciones = [];

                // Filtrar equipos no asignados
                const equiposAsignados = new Set(asignaciones.filter(a => a.estado_asignacion === "Asignado").map(a => a.id_equipo));
                equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';
                equipos.filter(equipo => !equiposAsignados.has(equipo.id_equipo)).forEach(equipo => {
                    equipoSelect.innerHTML += `<option value="${equipo.id_equipo}">${equipo.DESCRIPCION} - ${equipo.MARCA} (${equipo.SERIAL})</option>`;
                });
            } catch (error) {
                console.error('Error actualizando equipos disponibles (Faltan funciones CRUD):', error);
            }
        }

        /**
         * Actualiza los detalles del equipo seleccionado en el modal de asignaci√≥n
         */
        async function updateEquipmentDetails() {
            const equipmentId = document.getElementById('assignmentEquipo').value;
            const detailsDiv = document.getElementById('equipmentDetails');
            detailsDiv.style.display = 'none';
            detailsDiv.innerHTML = '';

            if (equipmentId) {
                try {
                    // NOTA: Depende de getEquipment (eliminada)
                    // const equipo = await getEquipment(parseInt(equipmentId));
                    const equipo = null;
                    
                    if (equipo) {
                        detailsDiv.innerHTML = `
                            <p><strong>Marca:</strong> ${equipo.MARCA}</p>
                            <p><strong>Modelo:</strong> ${equipo.MODELO}</p>
                            <p><strong>Serial:</strong> ${equipo.SERIAL}</p>
                            <p><strong>Etiqueta:</strong> ${equipo.ETIQUETA || 'N/A'}</p>
                            <p><strong>Status:</strong> <span class="${equipo.STATUS === 'OPERATIVO' ? 'status-operativo' : 'status-inoperativo'}">${equipo.STATUS}</span></p>
                            ${equipo.OBSERVACIONES ? `<p><strong>Obs:</strong> ${equipo.OBSERVACIONES}</p>` : ''}
                        `;
                        detailsDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error obteniendo detalles del equipo (Falta getEquipment):', error);
                }
            }
        }

        // =============================================
        // EVENT LISTENERS PARA FORMULARIOS
        // NOTA: Estas funciones deben ser actualizadas para usar su nueva l√≥gica CRUD (add/update)
        // =============================================

        // Manejo del formulario de usuario
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.warn('‚ö†Ô∏è Guardar usuario (userForm) - Se necesita re-implementar addUser/updateUser.');
            // Aqu√≠ ir√≠a la nueva l√≥gica para guardar o actualizar el usuario.
            closeUserModal();
            loadAllData();
        });

        // Manejo del formulario de equipo
        document.getElementById('equipmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.warn('‚ö†Ô∏è Guardar equipo (equipmentForm) - Se necesita re-implementar addEquipment/updateEquipment.');
            // Aqu√≠ ir√≠a la nueva l√≥gica para guardar o actualizar el equipo.
            closeEquipmentModal();
            loadAllData();
        });

        // Manejo del formulario de asignaci√≥n
        document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.warn('‚ö†Ô∏è Guardar asignaci√≥n (assignmentForm) - Se necesita re-implementar addAssignment/updateAssignment.');
            // Aqu√≠ ir√≠a la nueva l√≥gica para guardar o actualizar la asignaci√≥n.
            closeAssignmentModal();
            loadAllData();
        });

        // Event listener para mostrar detalles del equipo
        document.getElementById('assignmentEquipo').addEventListener('change', updateEquipmentDetails);

        // =============================================
        // FUNCIONES DE ACCI√ìN (Requieren re-implementar las funciones CRUD)
        // =============================================

        // FUNCIONES CRUD COMPLETAS
        async function editUser(id) {
            console.warn('‚ö†Ô∏è editUser - Se necesita re-implementar getUser.');
            try {
                // const usuario = await getUser(id);
                // Aqu√≠ actualizar el modal con el objeto usuario
            } catch (error) {
                console.error('Error editando usuario (Falta getUser):', error);
                alert('Error al cargar datos del usuario. Falta la funci√≥n getUser.');
            }
        }

        async function deleteUserConfirm(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este usuario? Tambi√©n se eliminar√°n sus asignaciones.')) {
                console.warn('‚ö†Ô∏è deleteUserConfirm - Se necesita re-implementar deleteUser y getAssignmentsByUser.');
                // Aqu√≠ ir√≠a la nueva l√≥gica para eliminar al usuario.
                loadAllData();
            }
        }

        async function editEquipment(id) {
            console.warn('‚ö†Ô∏è editEquipment - Se necesita re-implementar getEquipment.');
            try {
                // const equipo = await getEquipment(id);
                // Aqu√≠ actualizar el modal con el objeto equipo
            } catch (error) {
                console.error('Error editando equipo (Falta getEquipment):', error);
                alert('Error al cargar datos del equipo. Falta la funci√≥n getEquipment.');
            }
        }

        async function deleteEquipmentConfirm(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este equipo? Tambi√©n se eliminar√°n sus asignaciones.')) {
                console.warn('‚ö†Ô∏è deleteEquipmentConfirm - Se necesita re-implementar deleteEquipment y getAssignmentByEquipment.');
                // Aqu√≠ ir√≠a la nueva l√≥gica para eliminar el equipo.
                loadAllData();
            }
        }

        async function editAssignment(id) {
            console.warn('‚ö†Ô∏è editAssignment - Se necesita re-implementar todas las funciones CRUD/GET.');
            // Aqu√≠ ir√≠a la nueva l√≥gica para cargar la asignaci√≥n al modal.
        }

        async function deleteAssignmentConfirm(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta asignaci√≥n?')) {
                console.warn('‚ö†Ô∏è deleteAssignmentConfirm - Se necesita re-implementar deleteAssignment.');
                // Aqu√≠ ir√≠a la nueva l√≥gica para eliminar la asignaci√≥n.
                loadAllData();
            }
        }

        function assignEquipment(equipmentId) {
            openAssignmentModal(equipmentId);
        }

        // =============================================
        // FUNCIONES DE ESTAD√çSTICAS Y B√öSQUEDA
        // =============================================

        /**
         * Actualiza el dashboard de estad√≠sticas
         * @param {Array} usuarios - Array de objetos usuario
         * @param {Array} equipos - Array de objetos equipo
         * @param {Array} asignaciones - Array de objetos asignaci√≥n
         */
        function updateStats(usuarios, equipos, asignaciones) {
            try {
                const equiposOperativos = equipos.filter(e => e.STATUS === 'OPERATIVO').length;
                const equiposAsignados = asignaciones.filter(a => a.estado_asignacion === 'Asignado').length;

                document.getElementById('totalUsuarios').textContent = usuarios.length;
                document.getElementById('totalEquipos').textContent = equipos.length;
                document.getElementById('equiposOperativos').textContent = equiposOperativos;
                document.getElementById('equiposAsignados').textContent = equiposAsignados;

            } catch (error) {
                console.error('Error actualizando estad√≠sticas:', error);
            }
        }

        /**
         * Renderiza las √∫ltimas 5 asignaciones en el dashboard
         * @param {Array} asignaciones - Array de objetos asignaci√≥n
         * @param {Array} usuarios - Array de objetos usuario
         * @param {Array} equipos - Array de objetos equipo
         */
        function renderLastAssignments(asignaciones, usuarios, equipos) {
            const container = document.getElementById('ultimasAsignaciones');
            const lastAssignments = asignaciones
                                        .slice() // Copiar el array
                                        .sort((a, b) => b.id_asignacion - a.id_asignacion) // Asumiendo que el ID mayor es el m√°s reciente
                                        .slice(0, 5); // Obtener las √∫ltimas 5

            if (lastAssignments.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: #777;">No hay asignaciones registradas.</p>';
                return;
            }

            container.innerHTML = `
                <table id="tablaUltimasAsignaciones">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Usuario</th>
                            <th>Equipo</th>
                            <th>Serial Equipo</th>
                            <th>Fecha</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lastAssignments.map(asignacion => {
                            const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
                            const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);
                            return `
                                <tr>
                                    <td>${asignacion.id_asignacion}</td>
                                    <td>${usuario ? `<strong>${usuario.RESPONSABLE}</strong><br><small>${usuario.SECTOR}</small>` : 'N/A'}</td>
                                    <td>${equipo ? `<strong>${equipo.DESCRIPCION}</strong><br>${equipo.MARCA}` : 'N/A'}</td>
                                    <td><strong>${equipo ? equipo.SERIAL : 'N/A'}</strong></td>
                                    <td>${asignacion.fecha_asignacion || 'N/A'}</td>
                                    <td>
                                        <span class="${asignacion.estado_asignacion === 'Asignado' ? 'assigned-badge' : 'unassigned-badge'}">
                                            ${asignacion.estado_asignacion}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            console.error('Error actualizando estad√≠sticas:', error);
        } }

        // Filtrar tablas
        function filterTable(tableType) {
            const input = document.getElementById(`search${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
            const filter = input.value.toLowerCase();
            const table = document.getElementById(`tabla${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
            const tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td');
                let found = false;
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        if (td[j].textContent.toLowerCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                tr[i].style.display = found ? '' : 'none';
            }
        }

        // B√∫squeda global
        async function globalSearch() {
            const filter = document.getElementById('globalSearch').value.toLowerCase();
            if (!filter) {
                updateStats();
                return;
            }
            
            // NOTA: Esta funci√≥n requiere re-implementar getAllUsers, getAllEquipments, getAllAssignments.
            console.warn('‚ö†Ô∏è B√∫squeda global - Se necesita re-implementar getAllUsers/Equipments/Assignments para esta funci√≥n.');
        }

        // =============================================
        // EXPORTACI√ìN E IMPORTACI√ìN (Requieren re-implementar los getters)
        // =============================================

        /**
         * Exporta todos los datos a un archivo Excel
         */
        async function exportToExcel() {
            try {
                // NOTA: Depende de getAllUsers, getAllEquipments, getAllAssignments eliminadas
                // const [usuarios, equipos, asignaciones] = await Promise.all([
                //     getAllUsers(),
                //     getAllEquipments(),
                //     getAllAssignments()
                // ]);
                
                const usuarios = []; 
                const equipos = []; 
                const asignaciones = []; 

                if (usuarios.length === 0 && equipos.length === 0 && asignaciones.length === 0) {
                    alert('No hay datos para exportar.');
                    return;
                }

                const wb = XLSX.utils.book_new();

                // Hoja de usuarios
                const wsUsuarios = XLSX.utils.json_to_sheet(usuarios.map(u => ({
                    ID_USUARIO: u.id_usuario,
                    RESPONSABLE: u.RESPONSABLE,
                    CEDULA: u.CEDULA,
                    CARGO: u.CARGO,
                    SECTOR: u.SECTOR
                })));
                XLSX.utils.book_append_sheet(wb, wsUsuarios, "Usuarios");

                // Hoja de equipos
                const wsEquipos = XLSX.utils.json_to_sheet(equipos.map(e => ({
                    ID_EQUIPO: e.id_equipo,
                    DESCRIPCION: e.DESCRIPCION,
                    MARCA: e.MARCA,
                    MODELO: e.MODELO,
                    SERIAL: e.SERIAL,
                    ETIQUETA: e.ETIQUETA,
                    STATUS: e.STATUS,
                    OBSERVACIONES: e.OBSERVACIONES
                })));
                XLSX.utils.book_append_sheet(wb, wsEquipos, "Equipos");

                // Hoja de asignaciones
                const wsAsignaciones = XLSX.utils.json_to_sheet(asignaciones.map(a => {
                    const usuario = usuarios.find(u => u.id_usuario === a.id_usuario);
                    const equipo = equipos.find(e => e.id_equipo === a.id_equipo);
                    return {
                        ID_ASIGNACION: a.id_asignacion,
                        ID_USUARIO: a.id_usuario,
                        USUARIO: usuario ? usuario.RESPONSABLE : 'N/A',
                        ID_EQUIPO: a.id_equipo,
                        EQUIPO: equipo ? `${equipo.DESCRIPCION} - ${equipo.MARCA}` : 'N/A',
                        SERIAL_EQUIPO: equipo ? equipo.SERIAL : 'N/A',
                        FECHA_ASIGNACION: a.fecha_asignacion,
                        ESTADO_ASIGNACION: a.estado_asignacion
                    };
                }));
                XLSX.utils.book_append_sheet(wb, wsAsignaciones, "Asignaciones");

                // Descargar archivo
                XLSX.writeFile(wb, `inventario_${new Date().toISOString().split('T')[0]}.xlsx`);

            } catch (error) {
                console.error('Error exportando a Excel:', error);
                alert('Error al exportar los datos a Excel');
            }
        }

        // Descargar plantilla MEJORADA
        function downloadTemplate() {
            const wb = XLSX.utils.book_new();

            // Plantilla de usuarios CON ENCABEZADOS CORRECTOS
            const usuariosData = [{ "RESPONSABLE": "EJEMPLO: MARIA GONZALEZ", "CEDULA": "EJEMPLO: 12345678", "CARGO": "EJEMPLO: ANALISTA", "SECTOR": "EJEMPLO: SIGAL" }];
            const wsUsuarios = XLSX.utils.json_to_sheet(usuariosData, { header: ["RESPONSABLE", "CEDULA", "CARGO", "SECTOR"] });
            XLSX.utils.book_append_sheet(wb, wsUsuarios, "Usuarios");

            // Plantilla de equipos
            const equiposData = [{ "DESCRIPCION": "EJEMPLO: LAPTOP", "MARCA": "EJEMPLO: DELL", "MODELO": "EJEMPLO: E7470", "SERIAL": "EJEMPLO: SERIE12345", "ETIQUETA": "EJEMPLO: INV-001", "STATUS": "EJEMPLO: OPERATIVO", "OBSERVACIONES": "EJEMPLO: Buen estado" }];
            const wsEquipos = XLSX.utils.json_to_sheet(equiposData, { header: ["DESCRIPCION", "MARCA", "MODELO", "SERIAL", "ETIQUETA", "STATUS", "OBSERVACIONES"] });
            XLSX.utils.book_append_sheet(wb, wsEquipos, "Equipos");

            // Plantilla de asignaciones
            const asignacionesData = [{ "USUARIO_CEDULA": "EJEMPLO: 12345678", "EQUIPO_SERIAL": "EJEMPLO: SERIE12345", "FECHA_ASIGNACION": "EJEMPLO: 2024-01-01", "ESTADO_ASIGNACION": "EJEMPLO: Asignado" }];
            const wsAsignaciones = XLSX.utils.json_to_sheet(asignacionesData, { header: ["USUARIO_CEDULA", "EQUIPO_SERIAL", "FECHA_ASIGNACION", "ESTADO_ASIGNACION"] });
            XLSX.utils.book_append_sheet(wb, wsAsignaciones, "Asignaciones");

            // Descargar archivo
            XLSX.writeFile(wb, "plantilla_inventario.xlsx");
        }


        /**
         * Importa datos desde un archivo Excel
         * @param {Event} event - Evento de cambio del input file
         */
        async function importFromExcel(event) {
            console.warn('‚ö†Ô∏è Importaci√≥n desde Excel - Se necesita re-implementar todas las funciones CRUD/GET para esta funci√≥n.');
            alert('Funcionalidad de importaci√≥n temporalmente deshabilitada. Re-implemente las funciones CRUD para Usuarios, Equipos y Asignaciones.');
        }


        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // =============================================
        // INICIALIZACI√ìN COMBINADA
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando Sistema de Inventario PWA...');
            
            // Solucionar el "flash" de contenido sin estilo
            document.body.style.visibility = 'visible';
            
            // Inicializar PWA primero (modo b√°sico para GitHub Pages)
            try {
                setupPWA();
                console.log('‚úÖ PWA inicializada (modo b√°sico)');
            } catch (pwaError) {
                console.error('‚ùå Error inicializando PWA:', pwaError);
                updatePWAStatus('‚ùå Error PWA');
            }
            
            // Inicializar la carga de datos con la nueva persistencia (implementar loadAllData)
            loadAllData(); 
            console.log('‚úÖ Base de datos (nueva persistencia) inicializada/cargada');
            
            // Configurar funcionalidad offline
            setupOfflineFunctionality();
            
            // Configurar notificaciones
            setupNotifications();
            
            console.log('üéâ Sistema de Inventario PWA completamente inicializado');
            
            // Intentar Service Worker b√°sico despu√©s de la carga inicial
            setTimeout(tryRegisterServiceWorker, 1000);
        });

        // Manejar el evento antes de descargar la p√°gina
        window.addEventListener('beforeunload', function() {
            console.log('üíæ Guardando estado de la aplicaci√≥n...');
            // Aqu√≠ podr√≠as guardar el estado actual si es necesario
        });

        // Manejar el evento de carga completa
        window.addEventListener('load', function() {
            console.log('üìÑ Contenido de la p√°gina cargado completamente.');
        });
    </script>
</body>
</html>
