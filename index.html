<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Inventario</title>

    <!-- === PWA META TAGS === -->
    <meta name="theme-color" content="#2c3e50"/>
    <meta name="description" content="Sistema de Gesti√≥n de Inventario - PWA">

    <!-- iOS support -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMmMzZTUwIi8+Cjx0ZXh0IHg9Ijk2IiB5PSIxMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaGyPSJtaWRkbGUiPklOVjwvdGV4dD4KPC9zdmc+">
    <meta name="apple-mobile-web-app-status-bar" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="inventario/js/supabase-config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos CSS para la interfaz del sistema */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .nav {
            display: flex;
            background: #34495e;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .nav button {
            flex: 1;
            padding: 15px;
            border: none;
            background: #34495e;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 14px;
            min-width: 120px;
        }

        .nav button:hover {
            background: #2c3e50;
        }

        .nav button.active {
            background: #3498db;
            font-weight: bold;
        }

        .content {
            padding: 20px;
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #34495e;
            color: white;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #f39c12;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-add {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            margin-bottom: 15px;
        }

        .btn-export {
            background: #9b59b6;
            color: white;
        }

        .btn-import {
            background: #e67e22;
            color: white;
        }

        .btn-download-template {
            background: #34495e;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-actions {
            text-align: right;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .btn-save {
            background: #3498db;
            color: white;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 10px 20px;
            background: #e67e22;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .import-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .equipment-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }

        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
            }

            .nav button {
                padding: 12px;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 8px;
                font-size: 14px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 11px;
            }

            .header-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
            border-top: 1px solid #e9ecef;
        }

        .status-operativo {
            color: #27ae60;
            font-weight: bold;
        }

        .status-inoperativo {
            color: #e74c3c;
            font-weight: bold;
        }

        .assigned-badge {
            background: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        .unassigned-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* ... (TODOS TUS ESTILOS ACTUALES SE MANTIENEN) ... */

        /* === ESTILOS PWA ADICIONALES === */
        .pwa-install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            font-size: 14px;
        }

        .pwa-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }

        .offline-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #e74c3c;
            color: white;
            text-align: center;
            padding: 10px;
            z-index: 1001;
            display: none;
        }

        @media (max-width: 768px) {
            .pwa-install-btn {
                bottom: 10px;
                right: 10px;
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- === ELEMENTOS PWA === -->
    <div class="offline-warning" id="offlineWarning">
        ‚ö†Ô∏è Est√°s trabajando sin conexi√≥n
    </div>

    <div class="pwa-status" id="pwaStatus">
        üì± PWA Lista
    </div>

    <button class="pwa-install-btn" id="pwaInstallBtn">
        üì≤ Instalar App
    </button>

    <div class="container">
        <div class="header">
            <h1>üì± Sistema de Inventario</h1>
            <p>Gesti√≥n completa de inventario</p>
            <div class="header-actions">
                <button class="btn btn-export" onclick="exportToExcel()">üìä Exportar a Excel</button>
                <!--button class="btn btn-download-template" onclick="downloadTemplate()">üì• Descargar Plantilla</button-->
                <!--label class="file-label">
                    üì§ Importar Excel
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx, .xls" onchange="importFromExcel(event)">
                </label-->
            </div>
        </div>

        <div class="nav">
            <button onclick="showTab('dashboard')" class="active">üìä Dashboard</button>
            <!--button onclick="showTab('usuarios')">üë• Usuarios</button-->
            <button onclick="showTab('equipos')">üíª Equipos</button>
            <button onclick="showTab('asignaciones')">üîó Asignaciones</button>
        </div>

        <div class="content">
            <!-- Contenido de las pesta√±as -->
            <div id="dashboard" class="tab-content active">
                <!-- Dashboard con estad√≠sticas -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsuarios">0</div>
                        <div class="stat-label">Total Usuarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEquipos">0</div>
                        <div class="stat-label">Total Equipos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="equiposOperativos">0</div>
                        <div class="stat-label">Equipos Operativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="equiposAsignados">0</div>
                        <div class="stat-label">Equipos Asignados</div>
                    </div>
                </div>

                <div class="search-box">
                    <input type="text" id="globalSearch" placeholder="üîç Buscar en todo el inventario..." onkeyup="globalSearch()">
                </div>

                <h3>√öltimas Asignaciones</h3>
                <div id="ultimasAsignaciones" class="table-container">
                    <!-- Las √∫ltimas asignaciones se cargar√°n aqu√≠ -->
                </div>
            </div>

            <!-- Usuarios -->
            <div id="usuarios" class="tab-content">
                <button class="btn btn-add" onclick="openUserModal()">‚ûï Agregar Usuario</button>
                <div class="search-box">
                    <input type="text" id="searchUsuarios" placeholder="üîç Buscar usuarios..." onkeyup="filterTable('usuarios')">
                </div>
                <div class="table-container">
                    <table id="tablaUsuarios">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Responsable</th>
                                <th>C√©dula</th>
                                <th>Cargo</th>
                                <th>Sector</th>
                                <th>Equipos Asignados</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyUsuarios">
                            <!-- Los usuarios se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="equipos" class="tab-content">
                <!-- Gesti√≥n de equipos -->
                <button class="btn btn-add" onclick="openEquipmentModal()">‚ûï Agregar Equipo</button>
                <div class="search-box">
                    <input type="text" id="searchEquipos" placeholder="üîç Buscar equipos..." onkeyup="filterTable('equipos')">
                </div>
                <div class="table-container">
                    <table id="tablaEquipos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Descripci√≥n</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Serial</th>
                                <th>Status</th>
                                <th>Asignado a</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyEquipos">
                            <!-- Los equipos se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="asignaciones" class="tab-content">
                <!-- Gesti√≥n de asignaciones -->
                <button class="btn btn-add" onclick="openAssignmentModal()">‚ûï Nueva Asignaci√≥n</button>
                <div class="search-box">
                    <input type="text" id="searchAsignaciones" placeholder="üîç Buscar asignaciones..." onkeyup="filterTable('asignaciones')">
                </div>
                <div class="table-container">
                    <table id="tablaAsignaciones">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Equipo</th>
                                <th>Serial Equipo</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyAsignaciones">
                            <!-- Las asignaciones se cargar√°n aqu√≠ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Sistema de Inventario - RIVEROJDU</p>
        </div>
    </div>

    <!-- Modales para formularios -->
    <div id="userModal" class="modal">
        <!-- Modal para usuarios -->
        <div class="modal-content">
            <h3 id="userModalTitle">Agregar Usuario</h3>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>Responsable:</label>
                    <input type="text" id="responsable" required>
                </div>
                <div class="form-group">
                    <label>C√©dula:</label>
                    <input type="text" id="cedula">
                </div>
                <div class="form-group">
                    <label>Cargo:</label>
                    <input type="text" id="cargo">
                </div>
                <div class="form-group">
                    <label>Sector:</label>
                    <input type="text" id="sector" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeUserModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="equipmentModal" class="modal">
        <!-- Modal para equipos -->
        <div class="modal-content">
            <h3 id="equipmentModalTitle">Agregar Equipo</h3>
            <form id="equipmentForm">
                <input type="hidden" id="equipmentId">
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <input type="text" id="descripcion" required>
                </div>
                <div class="form-group">
                    <label>Marca:</label>
                    <input type="text" id="marca" required>
                </div>
                <div class="form-group">
                    <label>Modelo:</label>
                    <input type="text" id="modelo" required>
                </div>
                <div class="form-group">
                    <label>Serial: <small>(√önico, identifica el equipo)</small></label>
                    <input type="text" id="serial" required>
                </div>
                <div class="form-group">
                    <label>Etiqueta:</label>
                    <input type="text" id="etiqueta">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="status" required>
                        <option value="OPERATIVO">OPERATIVO</option>
                        <option value="INOPERATIVO">INOPERATIVO</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="observaciones" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeEquipmentModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="assignmentModal" class="modal">
        <!-- Modal para asignaciones -->
        <div class="modal-content">
            <h3 id="assignmentModalTitle">Nueva Asignaci√≥n</h3>
            <form id="assignmentForm">
                <input type="hidden" id="assignmentId">
                <div class="form-group">
                    <label>Usuario:</label>
                    <select id="assignmentUsuario" required onchange="updateAvailableEquipments()">
                        <option value="">Seleccionar usuario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Equipo:</label>
                    <select id="assignmentEquipo" required onchange="updateEquipmentDetails()">
                        <option value="">Seleccionar equipo</option>
                    </select>
                    <div id="equipmentDetails" class="equipment-info" style="display: none;">
                        <!-- Detalles del equipo se mostrar√°n aqu√≠ -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Estado:</label>
                    <select id="assignmentEstado" required>
                        <option value="Asignado">Asignado</option>
                        <option value="Retirado">Retirado</option>
                        <option value="En Reparaci√≥n">En Reparaci√≥n</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeAssignmentModal()">Cancelar</button>
                    <button type="submit" class="btn btn-save">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
  // =============================================
// CONFIGURACI√ìN PWA PARA GITHUB PAGES
// =============================================

// Manifest din√°mico para PWA
// =============================================
// CONFIGURACI√ìN PWA CON TUS ICONOS PNG
// =============================================

const manifest = {
    "name": "Sistema de Inventario",
    "short_name": "InventarioPWA",
    "description": "Sistema de gesti√≥n de inventario completo con usuarios, equipos y asignaciones",
    "start_url": ".",
    "scope": "/",
    "display": "standalone",
    "background_color": "#ffffff",
    "theme_color": "#2c3e50",
    "orientation": "any",
    "categories": ["business", "productivity", "utilities"],
    "icons": [
        {
            "src": "content/icons/android-launchericon-192-192.png",
            "sizes": "192x192",
            "type": "image/png",
            "purpose": "any"
        },
        {
            "src": "content/icons/android-launchericon-512-512.png",
            "sizes": "512x512",
            "type": "image/png",
            "purpose": "any"
        }
    ],
    "screenshots": [
        {
            "src": "content/icons/Wide310x150Logo.scale-400.png",
            "sizes": "1240x600",
            "type": "image/png",
            "form_factor": "wide",
            "label": "Dashboard del Sistema de Inventario"
        }
    ]
};

// Crear y agregar manifest din√°mico
function setupPWA() {
    // Crear link del manifest
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(manifestBlob);

    const manifestLink = document.createElement('link');
    manifestLink.rel = 'manifest';
    manifestLink.href = manifestURL;
    document.head.appendChild(manifestLink);

    console.log('‚úÖ Manifest PWA configurado');

    // En GitHub Pages usamos un enfoque simplificado sin Service Worker
    setupPWAInstall();
    setupConnectionDetection();

    // Marcar como PWA b√°sica (sin Service Worker)
    updatePWAStatus('‚úÖ PWA B√°sica');
}

// Service Worker ALTERNATIVO - Solo para HTTPS tradicional
function tryRegisterServiceWorker() {
    // Solo intentar en entornos que soporten Service Workers correctamente
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
        try {
            // Intentar registrar un Service Worker muy b√°sico
            const swContent = `
                self.addEventListener('install', (event) => {
                    console.log('üì¶ PWA Installado');
                    self.skipWaiting();
                });

                self.addEventListener('activate', (event) => {
                    console.log('‚úÖ PWA Activado');
                    event.waitUntil(self.clients.claim());
                });

                // Cache b√°sico para recursos cr√≠ticos
                self.addEventListener('fetch', (event) => {
                    // Estrategia de cache b√°sica
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => response || fetch(event.request))
                    );
                });
            `;

            const swBlob = new Blob([swContent], {type: 'application/javascript'});
            const swURL = URL.createObjectURL(swBlob);

            navigator.serviceWorker.register(swURL, { scope: './' })
                .then(registration => {
                    console.log('‚úÖ Service Worker registrado (b√°sico)');
                    updatePWAStatus('‚úÖ PWA Completa');
                })
                .catch(error => {
                    console.log('‚ö†Ô∏è Service Worker no disponible en este entorno');
                    // No es cr√≠tico - continuar sin SW
                });

        } catch (error) {
            console.log('‚ö†Ô∏è Entorno no compatible con Service Worker');
        }
    } else {
        console.log('üåê Modo PWA B√°sica (sin Service Worker)');
    }
}

// Instalaci√≥n de PWA MEJORADA
function setupPWAInstall() {
    let deferredPrompt;
    const installBtn = document.getElementById('pwaInstallBtn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
        updatePWAStatus('üì± Lista para instalar');
        console.log('üì± App lista para instalaci√≥n');

        // Mostrar por 30 segundos
        setTimeout(() => {
            if (installBtn.style.display !== 'none') {
                installBtn.style.display = 'none';
                console.log('‚è∞ Bot√≥n de instalaci√≥n ocultado');
            }
        }, 30000);
    });

    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            installBtn.textContent = '‚è≥ Instalando...';
            installBtn.disabled = true;

            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;

            if (outcome === 'accepted') {
                installBtn.textContent = '‚úÖ Instalada';
                installBtn.style.background = '#27ae60';
                updatePWAStatus('üéâ App Instalada');
                console.log('üéâ App aceptada para instalaci√≥n');

                setTimeout(() => {
                    installBtn.style.display = 'none';
                }, 3000);
            } else {
                installBtn.textContent = 'üì≤ Instalar App';
                installBtn.disabled = false;
                console.log('‚ùå App rechazada para instalaci√≥n');
                updatePWAStatus('üì± Instalaci√≥n cancelada');

                setTimeout(() => {
                    installBtn.style.display = 'none';
                }, 5000);
            }
            deferredPrompt = null;
        }
    });

    window.addEventListener('appinstalled', (evt) => {
        installBtn.style.display = 'none';
        deferredPrompt = null;
        updatePWAStatus('üéâ App Instalada');
        console.log('üéâ App instalada exitosamente');
    });

    // Verificar si ya est√° instalado
    if (window.matchMedia('(display-mode: standalone)').matches) {
        installBtn.style.display = 'none';
        updatePWAStatus('üì± Ejecutando como App');
        console.log('üì± Ejecut√°ndose en modo standalone');
    }

    // Tambi√©n verificar usando navigator.standalone (iOS)
    if (navigator.standalone) {
        installBtn.style.display = 'none';
        updatePWAStatus('üì± Ejecutando como App (iOS)');
        console.log('üì± Ejecut√°ndose en modo standalone (iOS)');
    }
}

// Detecci√≥n de conexi√≥n MEJORADA
function setupConnectionDetection() {
    const offlineWarning = document.getElementById('offlineWarning');

    function updateOnlineStatus() {
        if (navigator.onLine) {
            offlineWarning.style.display = 'none';
            updatePWAStatus(document.getElementById('pwaStatus').textContent.replace('‚ö†Ô∏è Offline - ', ''));
            console.log('üåê Conexi√≥n restaurada');
        } else {
            offlineWarning.style.display = 'block';
            const currentStatus = document.getElementById('pwaStatus').textContent;
            if (!currentStatus.includes('Offline')) {
                updatePWAStatus('‚ö†Ô∏è Offline - ' + currentStatus);
            }
            console.log('üåê Sin conexi√≥n - Modo offline activado');

            // Mostrar notificaci√≥n de offline
            showOfflineNotification();
        }
    }

    function showOfflineNotification() {
        // Crear notificaci√≥n visual temporal
        const offlineMsg = document.createElement('div');
        offlineMsg.style.cssText = `
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        `;
        offlineMsg.textContent = '‚ö†Ô∏è Modo offline - Los datos se guardan localmente';
        document.body.appendChild(offlineMsg);

        setTimeout(() => {
            if (document.body.contains(offlineMsg)) {
                document.body.removeChild(offlineMsg);
            }
        }, 3000);
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    // Estado inicial
    updateOnlineStatus();
}

// Actualizar estado PWA MEJORADO
function updatePWAStatus(message) {
    const statusElement = document.getElementById('pwaStatus');
    if (statusElement) {
        statusElement.textContent = message;

        // Cambiar color seg√∫n estado
        if (message.includes('‚úÖ') || message.includes('üéâ')) {
            statusElement.style.background = '#27ae60';
        } else if (message.includes('‚ö†Ô∏è') || message.includes('üì±') || message.includes('üîÑ')) {
            statusElement.style.background = '#f39c12';
        } else if (message.includes('‚ùå')) {
            statusElement.style.background = '#e74c3c';
        } else {
            statusElement.style.background = '#34495e';
        }
    }
}

// Funci√≥n para simular funcionalidad offline
function setupOfflineFunctionality() {
    console.log('üîß Configurando funcionalidad offline...');

    // Tu base de datos IndexedDB ya proporciona almacenamiento offline
    // Aqu√≠ podr√≠as agregar l√≥gica adicional para manejo offline

    // Ejemplo: Guardar operaciones pendientes cuando hay conexi√≥n
    let pendingOperations = JSON.parse(localStorage.getItem('pendingOperations') || '[]');

    // Intentar procesar operaciones pendientes cuando hay conexi√≥n
    window.addEventListener('online', () => {
        if (pendingOperations.length > 0) {
            console.log('üîÑ Procesando operaciones pendientes:', pendingOperations.length);
            // Aqu√≠ procesar√≠as las operaciones pendientes
            pendingOperations = [];
            localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations));
        }
    });
}

// Configurar notificaciones
function setupNotifications() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            console.log('‚ÑπÔ∏è Permisos de notificaci√≥n disponibles');
        } else if (Notification.permission === 'granted') {
            console.log('üîî Notificaciones permitidas');
        }
    }
}

// Funci√≥n para mostrar notificaci√≥n
function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: body,
            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMmMzZTUwIi8+Cjx0ZXh0IHg9IjMyIiB5PSIzNSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SU5WPC90ZXh0Pgo8L3N2Zz4='
        });
    }
}

        // =============================================
        // CONFIGURACI√ìN DE LA BASE DE DATOS (SUPABASE)
        // =============================================

        /**
         * Inicializa la conexi√≥n con Supabase.
         * La configuraci√≥n del cliente Supabase ya est√° cargada desde supabase-config.js.
         * Esta funci√≥n principalmente inicia la carga de datos.
         */
        function initDatabase() {
            console.log('Cliente Supabase listo. Cargando datos...');
            loadAllData();
        }

        // =============================================
        // FUNCIONES CRUD PARA USUARIOS (SUPABASE)
        // =============================================

        async function addUser(user) {
            const { data, error } = await supabase.from('usuarios').insert([user]);
            if (error) throw error;
            return data;
        }

        async function updateUser(user) {
            const { data, error } = await supabase.from('usuarios').update(user).eq('id_usuario', user.id_usuario);
            if (error) throw error;
            return data;
        }

        async function deleteUser(id) {
            const { data, error } = await supabase.from('usuarios').delete().eq('id_usuario', id);
            if (error) throw error;
            return data;
        }

        async function getUser(id) {
            const { data, error } = await supabase.from('usuarios').select('*').eq('id_usuario', id).single();
            if (error) throw error;
            return data;
        }

        async function getAllUsers() {
            const { data, error } = await supabase.from('usuarios').select('*');
            if (error) throw error;
            return data;
        }

        // =============================================
        // FUNCIONES CRUD PARA EQUIPOS (SUPABASE)
        // =============================================

        async function addEquipment(equipment) {
            const { data, error } = await supabase.from('equipos').insert([equipment]);
            if (error) throw error;
            return data;
        }

        async function updateEquipment(equipment) {
            const { data, error } = await supabase.from('equipos').update(equipment).eq('id_equipo', equipment.id_equipo);
            if (error) throw error;
            return data;
        }

        async function deleteEquipment(id) {
            const { data, error } = await supabase.from('equipos').delete().eq('id_equipo', id);
            if (error) throw error;
            return data;
        }

        async function getEquipment(id) {
            const { data, error } = await supabase.from('equipos').select('*').eq('id_equipo', id).single();
            if (error) throw error;
            return data;
        }

        async function getEquipmentBySerial(serial) {
            const { data, error } = await supabase.from('equipos').select('*').eq('serial', serial).single();
            if (error && error.code !== 'PGRST116') { // Ignorar error si no se encuentra (single)
                throw error;
            }
            return data;
        }

        async function getAllEquipments() {
            const { data, error } = await supabase.from('equipos').select('*');
            if (error) throw error;
            return data;
        }

        // =============================================
        // FUNCIONES CRUD PARA ASIGNACIONES (SUPABASE)
        // =============================================

        async function addAssignment(assignment) {
            const { data, error } = await supabase.from('asignaciones').insert([assignment]);
            if (error) throw error;
            return data;
        }

        async function updateAssignment(assignment) {
            const { data, error } = await supabase.from('asignaciones').update(assignment).eq('id_asignacion', assignment.id_asignacion);
            if (error) throw error;
            return data;
        }

        async function deleteAssignment(id) {
            const { data, error } = await supabase.from('asignaciones').delete().eq('id_asignacion', id);
            if (error) throw error;
            return data;
        }

        async function getAssignmentByEquipment(equipmentId) {
            const { data, error } = await supabase
                .from('asignaciones')
                .select('*')
                .eq('id_equipo', equipmentId)
                .eq('estado_asignacion', 'Asignado')
                .single();

            if (error && error.code !== 'PGRST116') { // Ignorar si no se encuentra
                throw error;
            }
            return data;
        }

        async function getAssignmentsByUser(userId) {
            const { data, error } = await supabase.from('asignaciones').select('*').eq('id_usuario', userId);
            if (error) throw error;
            return data;
        }

        async function getAllAssignments() {
            const { data, error } = await supabase.from('asignaciones').select('*');
            if (error) throw error;
            return data;
        }

        // =============================================
        // FUNCIONES DE CARGA Y RENDERIZADO DE DATOS
        // =============================================

        /**
         * Carga todos los datos de la base de datos y los renderiza en las tablas
         * Si no hay datos, carga datos iniciales
         */
        async function loadAllData() {
            try {
                const [usuarios, equipos, asignaciones] = await Promise.all([
                    getAllUsers(),
                    getAllEquipments(),
                    getAllAssignments()
                ]);

                renderUsers(usuarios, equipos, asignaciones);
                renderEquipments(equipos, usuarios, asignaciones);
                renderAssignments(asignaciones, usuarios, equipos);
                updateStats(usuarios, equipos, asignaciones);
            } catch (error) {
                console.error('Error cargando datos:', error);
            }
        }

        /**
         * Carga datos iniciales en la base de datos (usuarios y equipos de ejemplo)
         * Crea asignaciones iniciales entre usuarios y equipos
         */
        async function loadInitialData() {
            // This function is now empty as we are not loading initial data anymore.
        }

        /**
         * Renderiza la lista de usuarios en la tabla correspondiente
         * @param {Array} usuarios - Array de objetos usuario
         * @param {Array} equipos - Array de objetos equipo
         * @param {Array} asignaciones - Array de objetos asignaci√≥n
         */
        function renderUsers(usuarios, equipos, asignaciones) {
            const tbody = document.getElementById('tbodyUsuarios');
            tbody.innerHTML = usuarios.map(usuario => {
                // Encontrar asignaciones activas del usuario
                const userAssignments = asignaciones.filter(a => a.id_usuario === usuario.id_usuario && a.estado_asignacion === "Asignado");
                const assignedEquipments = userAssignments.map(a => {
                    const equipo = equipos.find(e => e.id_equipo === a.id_equipo);
                    return equipo ? `${equipo.descripcion} (${equipo.serial})` : 'N/A';
                });

                return `
                    <tr>
                        <td>${usuario.id_usuario}</td>
                        <td>${usuario.responsable}</td>
                        <td>${usuario.cedula}</td>
                        <td>${usuario.cargo}</td>
                        <td>${usuario.sector}</td>
                        <td>
                            ${userAssignments.length > 0 ?
                                `<span class="assigned-badge">${userAssignments.length} equipo(s)</span><br>
                                 <small>${assignedEquipments.join(', ')}</small>` :
                                '<span class="unassigned-badge">Sin equipos</span>'}
                        </td>
                        <td>
                            <button class="btn btn-edit" onclick="editUser(${usuario.id_usuario})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="deleteUserConfirm(${usuario.id_usuario})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Renderiza la lista de equipos en la tabla correspondiente
         * @param {Array} equipos - Array de objetos equipo
         * @param {Array} usuarios - Array de objetos usuario
         * @param {Array} asignaciones - Array de objetos asignaci√≥n
         */
        function renderEquipments(equipos, usuarios, asignaciones) {
            const tbody = document.getElementById('tbodyEquipos');
            tbody.innerHTML = equipos.map(equipo => {
                // Encontrar asignaci√≥n activa del equipo
                const assignment = asignaciones.find(a => a.id_equipo === equipo.id_equipo && a.estado_asignacion === "Asignado");
                const assignedUser = assignment ? usuarios.find(u => u.id_usuario === assignment.id_usuario) : null;

                return `
                    <tr>
                        <td>${equipo.id_equipo}</td>
                        <td>${equipo.descripcion}</td>
                        <td>${equipo.marca}</td>
                        <td>${equipo.modelo}</td>
                        <td><strong>${equipo.serial}</strong></td>
                        <td class="${equipo.status === 'OPERATIVO' ? 'status-operativo' : 'status-inoperativo'}">
                            ${equipo.status}
                        </td>
                        <td>
                            ${assignedUser ?
                                `<span class="assigned-badge">${assignedUser.responsable}</span>` :
                                '<span class="unassigned-badge">No asignado</span>'}
                        </td>
                        <td>
                            <button class="btn btn-edit" onclick="editEquipment(${equipo.id_equipo})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="deleteEquipmentConfirm(${equipo.id_equipo})">üóëÔ∏è</button>
                            ${!assignedUser ?
                                `<button class="btn btn-add" onclick="assignEquipment(${equipo.id_equipo})" style="padding: 4px 8px; font-size: 10px;">üîó Asignar</button>` :
                                ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Renderiza la lista de asignaciones en la tabla correspondiente
         * @param {Array} asignaciones - Array de objetos asignaci√≥n
         * @param {Array} usuarios - Array de objetos usuario
         * @param {Array} equipos - Array de objetos equipo
         */
        function renderAssignments(asignaciones, usuarios, equipos) {
            const tbody = document.getElementById('tbodyAsignaciones');
            tbody.innerHTML = asignaciones.map(asignacion => {
                const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
                const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);
                return `
                    <tr>
                        <td>${asignacion.id_asignacion}</td>
                        <td>${usuario ? `<strong>${usuario.responsable}</strong><br><small>${usuario.sector}</small>` : 'N/A'}</td>
                        <td>${equipo ? `<strong>${equipo.descripcion}</strong><br>${equipo.marca} ${equipo.modelo}` : 'N/A'}</td>
                        <td><strong>${equipo ? equipo.serial : 'N/A'}</strong></td>
                        <td>${asignacion.fecha_asignacion || 'N/A'}</td>
                        <td>
                            <span class="${asignacion.estado_asignacion === 'Asignado' ? 'assigned-badge' : 'unassigned-badge'}">
                                ${asignacion.estado_asignacion}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-edit" onclick="editAssignment(${asignacion.id_asignacion})">‚úèÔ∏è</button>
                            <button class="btn btn-delete" onclick="deleteAssignmentConfirm(${asignacion.id_asignacion})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // =============================================
        // FUNCIONES DE INTERFAZ Y NAVEGACI√ìN
        // =============================================

        /**
         * Muestra una pesta√±a espec√≠fica y oculta las dem√°s
         * @param {string} tabName - Nombre de la pesta√±a a mostrar
         */
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remover clase active de todos los botones
            document.querySelectorAll('.nav button').forEach(button => {
                button.classList.remove('active');
            });

            // Mostrar pesta√±a seleccionada y activar bot√≥n
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Si es el dashboard, actualizar estad√≠sticas
            if (tabName === 'dashboard') {
                updateStats();
            }
        }

        // =============================================
        // FUNCIONES DE MODALES
        // =============================================

        /**
         * Abre el modal para agregar/editar usuario
         */
        function openUserModal() {
            document.getElementById('userModalTitle').textContent = 'Agregar Usuario';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userModal').style.display = 'block';
        }

        /**
         * Cierra el modal de usuario
         */
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        /**
         * Abre el modal para agregar/editar equipo
         */
        function openEquipmentModal() {
            document.getElementById('equipmentModalTitle').textContent = 'Agregar Equipo';
            document.getElementById('equipmentForm').reset();
            document.getElementById('equipmentId').value = '';
            document.getElementById('status').value = 'OPERATIVO';
            document.getElementById('equipmentModal').style.display = 'block';
        }

        /**
         * Cierra el modal de equipo
         */
        function closeEquipmentModal() {
            document.getElementById('equipmentModal').style.display = 'none';
        }

        /**
         * Abre el modal para crear/editar asignaci√≥n
         * @param {number} equipmentId - ID del equipo a asignar (opcional)
         */
        async function openAssignmentModal(equipmentId = null) {
            try {
                const [usuarios, equipos] = await Promise.all([
                    getAllUsers(),
                    getAllEquipments()
                ]);

                const usuarioSelect = document.getElementById('assignmentUsuario');
                const equipoSelect = document.getElementById('assignmentEquipo');

                // Llenar select de usuarios
                usuarioSelect.innerHTML = '<option value="">Seleccionar usuario</option>';
                equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';

                usuarios.forEach(usuario => {
                    usuarioSelect.innerHTML += `<option value="${usuario.id_usuario}">${usuario.responsable} - ${usuario.sector}</option>`;
                });

                // Llenar select de equipos (solo equipos no asignados)
                const asignaciones = await getAllAssignments();
                const equiposAsignados = new Set(asignaciones.filter(a => a.estado_asignacion === "Asignado").map(a => a.id_equipo));

                equipos.filter(equipo => !equiposAsignados.has(equipo.id_equipo)).forEach(equipo => {
                    equipoSelect.innerHTML += `<option value="${equipo.id_equipo}">${equipo.descripcion} - ${equipo.marca} (${equipo.serial})</option>`;
                });

                // Si se pasa un equipmentId, seleccionarlo autom√°ticamente
                if (equipmentId) {
                    equipoSelect.value = equipmentId;
                    updateEquipmentDetails();
                }

                document.getElementById('assignmentModalTitle').textContent = 'Nueva Asignaci√≥n';
                document.getElementById('assignmentForm').reset();
                document.getElementById('assignmentId').value = '';
                document.getElementById('assignmentEstado').value = 'Asignado';
                document.getElementById('assignmentModal').style.display = 'block';
            } catch (error) {
                console.error('Error abriendo modal de asignaci√≥n:', error);
                alert('Error al cargar datos para la asignaci√≥n');
            }
        }

        /**
         * Cierra el modal de asignaci√≥n
         */
        function closeAssignmentModal() {
            document.getElementById('assignmentModal').style.display = 'none';
            document.getElementById('equipmentDetails').style.display = 'none';
        }

        /**
         * Actualiza la lista de equipos disponibles seg√∫n el usuario seleccionado
         */
        async function updateAvailableEquipments() {
            const usuarioId = document.getElementById('assignmentUsuario').value;
            const equipoSelect = document.getElementById('assignmentEquipo');

            if (!usuarioId) {
                equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';
                return;
            }

            try {
                const [equipos, asignaciones] = await Promise.all([
                    getAllEquipments(),
                    getAllAssignments()
                ]);

                // Filtrar equipos no asignados
                const equiposAsignados = new Set(asignaciones.filter(a => a.estado_asignacion === "Asignado").map(a => a.id_equipo));

                equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';
                equipos.filter(equipo => !equiposAsignados.has(equipo.id_equipo)).forEach(equipo => {
                    equipoSelect.innerHTML += `<option value="${equipo.id_equipo}">${equipo.descripcion} - ${equipo.marca} (${equipo.serial})</option>`;
                });
            } catch (error) {
                console.error('Error actualizando equipos disponibles:', error);
            }
        }

        /**
         * Actualiza los detalles del equipo seleccionado en el modal de asignaci√≥n
         */
        async function updateEquipmentDetails() {
            const equipoId = document.getElementById('assignmentEquipo').value;
            const equipmentDetails = document.getElementById('equipmentDetails');

            if (!equipoId) {
                equipmentDetails.style.display = 'none';
                return;
            }

            try {
                const equipo = await getEquipment(parseInt(equipoId));
                if (equipo) {
                    equipmentDetails.innerHTML = `
                        <strong>Detalles del Equipo:</strong><br>
                        <strong>Descripci√≥n:</strong> ${equipo.descripcion}<br>
                        <strong>Marca/Modelo:</strong> ${equipo.marca} ${equipo.modelo}<br>
                        <strong>Serial:</strong> ${equipo.serial}<br>
                        <strong>Status:</strong> <span class="${equipo.status === 'OPERATIVO' ? 'status-operativo' : 'status-inoperativo'}">${equipo.status}</span>
                    `;
                    equipmentDetails.style.display = 'block';
                }
            } catch (error) {
                console.error('Error cargando detalles del equipo:', error);
            }
        }

        // Asignar equipo espec√≠fico
        async function assignEquipment(equipmentId) {
            await openAssignmentModal(equipmentId);
        }

        // Manejo del formulario de usuario
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const user = {
                responsable: document.getElementById('responsable').value,
                cedula: document.getElementById('cedula').value,
                cargo: document.getElementById('cargo').value,
                sector: document.getElementById('sector').value
            };

            const userId = document.getElementById('userId').value;

            try {
                if (userId) {
                    user.id_usuario = parseInt(userId);
                    await updateUser(user);
                } else {
                    await addUser(user);
                }

                closeUserModal();
                loadAllData();
            } catch (error) {
                console.error('Error guardando usuario:', error);
                alert('Error al guardar el usuario');
            }
        });

        // Manejo del formulario de equipo
        document.getElementById('equipmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const equipment = {
                descripcion: document.getElementById('descripcion').value,
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value,
                serial: document.getElementById('serial').value,
                etiqueta: document.getElementById('etiqueta').value,
                status: document.getElementById('status').value,
                observaciones: document.getElementById('observaciones').value
            };

            const equipmentId = document.getElementById('equipmentId').value;

            try {
                // Verificar si el serial ya existe (excepto para edici√≥n)
                if (!equipmentId) {
                    const existingEquipment = await getEquipmentBySerial(equipment.serial);
                    if (existingEquipment) {
                        alert('Error: Ya existe un equipo con este n√∫mero de serial. El serial debe ser √∫nico.');
                        return;
                    }
                }

                if (equipmentId) {
                    equipment.id_equipo = parseInt(equipmentId);
                    await updateEquipment(equipment);
                } else {
                    await addEquipment(equipment);
                }

                closeEquipmentModal();
                loadAllData();
            } catch (error) {
                console.error('Error guardando equipo:', error);
                alert('Error al guardar el equipo');
            }
        });

        // Manejo del formulario de asignaci√≥n
        document.getElementById('assignmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const assignment = {
                id_usuario: parseInt(document.getElementById('assignmentUsuario').value),
                id_equipo: parseInt(document.getElementById('assignmentEquipo').value),
                fecha_asignacion: new Date().toISOString().split('T')[0],
                estado_asignacion: document.getElementById('assignmentEstado').value
            };

            const assignmentId = document.getElementById('assignmentId').value;

            try {
                // Verificar si el equipo ya est√° asignado
                if (!assignmentId) {
                    const existingAssignment = await getAssignmentByEquipment(assignment.id_equipo);
                    if (existingAssignment && existingAssignment.estado_asignacion === "Asignado") {
                        alert('Error: Este equipo ya est√° asignado a otro usuario.');
                        return;
                    }
                }

                if (assignmentId) {
                    assignment.id_asignacion = parseInt(assignmentId);
                    await updateAssignment(assignment);
                } else {
                    await addAssignment(assignment);
                }

                closeAssignmentModal();
                loadAllData();
            } catch (error) {
                console.error('Error guardando asignaci√≥n:', error);
                alert('Error al guardar la asignaci√≥n');
            }
        });

        // Event listener para mostrar detalles del equipo
        document.getElementById('assignmentEquipo').addEventListener('change', updateEquipmentDetails);

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initDatabase();
        });

        // FUNCIONES CRUD COMPLETAS
        async function editUser(id) {
            try {
                const usuario = await getUser(id);
                if (usuario) {
                    document.getElementById('userModalTitle').textContent = 'Editar Usuario';
                    document.getElementById('userId').value = usuario.id_usuario;
                    document.getElementById('responsable').value = usuario.responsable;
                    document.getElementById('cedula').value = usuario.cedula;
                    document.getElementById('cargo').value = usuario.cargo;
                    document.getElementById('sector').value = usuario.sector;
                    document.getElementById('userModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error editando usuario:', error);
                alert('Error al cargar datos del usuario');
            }
        }

        async function deleteUserConfirm(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este usuario? Tambi√©n se eliminar√°n sus asignaciones.')) {
                try {
                    // Eliminar asignaciones del usuario primero
                    const userAssignments = await getAssignmentsByUser(id);
                    for (const assignment of userAssignments) {
                        await deleteAssignment(assignment.id_asignacion);
                    }

                    await deleteUser(id);
                    loadAllData();
                } catch (error) {
                    console.error('Error eliminando usuario:', error);
                    alert('Error al eliminar el usuario');
                }
            }
        }

        async function editEquipment(id) {
            try {
                const equipo = await getEquipment(id);
                if (equipo) {
                    document.getElementById('equipmentModalTitle').textContent = 'Editar Equipo';
                    document.getElementById('equipmentId').value = equipo.id_equipo;
                    document.getElementById('descripcion').value = equipo.descripcion;
                    document.getElementById('marca').value = equipo.marca;
                    document.getElementById('modelo').value = equipo.modelo;
                    document.getElementById('serial').value = equipo.serial;
                    document.getElementById('etiqueta').value = equipo.etiqueta;
                    document.getElementById('status').value = equipo.status;
                    document.getElementById('observaciones').value = equipo.observaciones;
                    document.getElementById('equipmentModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error editando equipo:', error);
                alert('Error al cargar datos del equipo');
            }
        }

        async function deleteEquipmentConfirm(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este equipo? Tambi√©n se eliminar√°n sus asignaciones.')) {
                try {
                    // Eliminar asignaciones del equipo primero
                    const equipmentAssignment = await getAssignmentByEquipment(id);
                    if (equipmentAssignment) {
                        await deleteAssignment(equipmentAssignment.id_asignacion);
                    }

                    await deleteEquipment(id);
                    loadAllData();
                } catch (error) {
                    console.error('Error eliminando equipo:', error);
                    alert('Error al eliminar el equipo');
                }
            }
        }

        async function editAssignment(id) {
            try {
                const [asignaciones, usuarios, equipos] = await Promise.all([
                    getAllAssignments(),
                    getAllUsers(),
                    getAllEquipments()
                ]);

                const asignacion = asignaciones.find(a => a.id_asignacion === id);

                if (asignacion) {
                    const usuarioSelect = document.getElementById('assignmentUsuario');
                    const equipoSelect = document.getElementById('assignmentEquipo');

                    usuarioSelect.innerHTML = '<option value="">Seleccionar usuario</option>';
                    equipoSelect.innerHTML = '<option value="">Seleccionar equipo</option>';

                    usuarios.forEach(usuario => {
                        usuarioSelect.innerHTML += `<option value="${usuario.id_usuario}">${usuario.responsable} - ${usuario.sector}</option>`;
                    });

                    equipos.forEach(equipo => {
                        equipoSelect.innerHTML += `<option value="${equipo.id_equipo}">${equipo.descripcion} - ${equipo.marca} (${equipo.serial})</option>`;
                    });

                    document.getElementById('assignmentModalTitle').textContent = 'Editar Asignaci√≥n';
                    document.getElementById('assignmentId').value = asignacion.id_asignacion;
                    document.getElementById('assignmentUsuario').value = asignacion.id_usuario;
                    document.getElementById('assignmentEquipo').value = asignacion.id_equipo;
                    document.getElementById('assignmentEstado').value = asignacion.estado_asignacion;
                    document.getElementById('assignmentModal').style.display = 'block';

                    updateEquipmentDetails();
                }
            } catch (error) {
                console.error('Error editando asignaci√≥n:', error);
                alert('Error al cargar datos de la asignaci√≥n');
            }
        }

        async function deleteAssignmentConfirm(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar esta asignaci√≥n?')) {
                try {
                    await deleteAssignment(id);
                    loadAllData();
                } catch (error) {
                    console.error('Error eliminando asignaci√≥n:', error);
                    alert('Error al eliminar la asignaci√≥n');
                }
            }
        }

        // Actualizar estad√≠sticas
        async function updateStats() {
            try {
                const [usuarios, equipos, asignaciones] = await Promise.all([
                    getAllUsers(),
                    getAllEquipments(),
                    getAllAssignments()
                ]);

                const equiposAsignados = asignaciones.filter(a => a.estado_asignacion === "Asignado").length;
                const equiposOperativos = equipos.filter(e => e.status === "OPERATIVO").length;

                document.getElementById('totalUsuarios').textContent = usuarios.length;
                document.getElementById('totalEquipos').textContent = equipos.length;
                document.getElementById('equiposOperativos').textContent = equiposOperativos;
                document.getElementById('equiposAsignados').textContent = equiposAsignados;

                // Mostrar √∫ltimas asignaciones
                const ultimasAsignaciones = document.getElementById('ultimasAsignaciones');
                const ultimas = asignaciones.slice(-5).reverse();

                ultimasAsignaciones.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Equipo</th>
                                <th>Serial</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ultimas.map(asignacion => {
                                const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
                                const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);
                                return `
                                    <tr>
                                        <td>${usuario ? usuario.responsable : 'N/A'}</td>
                                        <td>${equipo ? `${equipo.descripcion} - ${equipo.marca}` : 'N/A'}</td>
                                        <td>${equipo ? equipo.serial : 'N/A'}</td>
                                        <td>${asignacion.fecha_asignacion || 'N/A'}</td>
                                        <td>
                                            <span class="${asignacion.estado_asignacion === 'Asignado' ? 'assigned-badge' : 'unassigned-badge'}">
                                                ${asignacion.estado_asignacion}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error actualizando estad√≠sticas:', error);
            }
        }

        // Filtrar tablas
        function filterTable(tableType) {
            const input = document.getElementById(`search${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
            const filter = input.value.toLowerCase();
            const table = document.getElementById(`tabla${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                const td = tr[i].getElementsByTagName('td');
                let found = false;
                for (let j = 0; j < td.length; j++) {
                    if (td[j]) {
                        if (td[j].textContent.toLowerCase().indexOf(filter) > -1) {
                            found = true;
                            break;
                        }
                    }
                }
                tr[i].style.display = found ? '' : 'none';
            }
        }

        // B√∫squeda global
        async function globalSearch() {
            const filter = document.getElementById('globalSearch').value.toLowerCase();

            if (!filter) {
                updateStats();
                return;
            }

            try {
                const [usuarios, equipos, asignaciones] = await Promise.all([
                    getAllUsers(),
                    getAllEquipments(),
                    getAllAssignments()
                ]);

                const usuariosFiltrados = usuarios.filter(usuario =>
                    Object.values(usuario).some(val =>
                        val.toString().toLowerCase().includes(filter)
                    )
                );

                const equiposFiltrados = equipos.filter(equipo =>
                    Object.values(equipo).some(val =>
                        val.toString().toLowerCase().includes(filter)
                    )
                );

                const asignacionesFiltradas = asignaciones.filter(asignacion => {
                    const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
                    const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);

                    return (usuario && Object.values(usuario).some(val =>
                        val.toString().toLowerCase().includes(filter)
                    )) || (equipo && Object.values(equipo).some(val =>
                        val.toString().toLowerCase().includes(filter)
                    ));
                });

                document.getElementById('totalUsuarios').textContent = usuariosFiltrados.length;
                document.getElementById('totalEquipos').textContent = equiposFiltrados.length;
                document.getElementById('equiposOperativos').textContent =
                    equiposFiltrados.filter(e => e.status === 'OPERATIVO').length;
                document.getElementById('equiposAsignados').textContent =
                    asignacionesFiltradas.filter(a => a.estado_asignacion === 'Asignado').length;

                const ultimasAsignaciones = document.getElementById('ultimasAsignaciones');
                ultimasAsignaciones.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Equipo</th>
                                <th>Serial</th>
                                <th>Fecha</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${asignacionesFiltradas.slice(0, 5).map(asignacion => {
                                const usuario = usuarios.find(u => u.id_usuario === asignacion.id_usuario);
                                const equipo = equipos.find(e => e.id_equipo === asignacion.id_equipo);
                                return `
                                    <tr>
                                        <td>${usuario ? usuario.responsable : 'N/A'}</td>
                                        <td>${equipo ? `${equipo.descripcion} - ${equipo.marca}` : 'N/A'}</td>
                                        <td>${equipo ? equipo.serial : 'N/A'}</td>
                                        <td>${asignacion.fecha_asignacion || 'N/A'}</td>
                                        <td>${asignacion.estado_asignacion}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error en b√∫squeda global:', error);
            }
        }

        // Exportar a Excel
        async function exportToExcel() {
            try {
                const [usuarios, equipos, asignaciones] = await Promise.all([
                    getAllUsers(),
                    getAllEquipments(),
                    getAllAssignments()
                ]);

                // Crear workbook
                const wb = XLSX.utils.book_new();

                // Hoja de usuarios
                const wsUsuarios = XLSX.utils.json_to_sheet(usuarios.map(u => ({
                    ID_USUARIO: u.id_usuario,
                    RESPONSABLE: u.responsable,
                    CEDULA: u.cedula,
                    CARGO: u.cargo,
                    SECTOR: u.sector
                })));
                XLSX.utils.book_append_sheet(wb, wsUsuarios, "Usuarios");

                // Hoja de equipos
                const wsEquipos = XLSX.utils.json_to_sheet(equipos.map(e => ({
                    ID_EQUIPO: e.id_equipo,
                    DESCRIPCION: e.descripcion,
                    MARCA: e.marca,
                    MODELO: e.modelo,
                    SERIAL: e.serial,
                    ETIQUETA: e.etiqueta,
                    STATUS: e.status,
                    OBSERVACIONES: e.observaciones
                })));
                XLSX.utils.book_append_sheet(wb, wsEquipos, "Equipos");

                // Hoja de asignaciones
                const wsAsignaciones = XLSX.utils.json_to_sheet(asignaciones.map(a => {
                    const usuario = usuarios.find(u => u.id_usuario === a.id_usuario);
                    const equipo = equipos.find(e => e.id_equipo === a.id_equipo);
                    return {
                        ID_ASIGNACION: a.id_asignacion,
                        ID_USUARIO: a.id_usuario,
                        USUARIO: usuario ? usuario.responsable : 'N/A',
                        ID_EQUIPO: a.id_equipo,
                        EQUIPO: equipo ? `${equipo.descripcion} - ${equipo.marca}` : 'N/A',
                        SERIAL_EQUIPO: equipo ? equipo.serial : 'N/A',
                        FECHA_ASIGNACION: a.fecha_asignacion,
                        ESTADO_ASIGNACION: a.estado_asignacion
                    };
                }));
                XLSX.utils.book_append_sheet(wb, wsAsignaciones, "Asignaciones");

                // Descargar archivo
                XLSX.writeFile(wb, `inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (error) {
                console.error('Error exportando a Excel:', error);
                alert('Error al exportar los datos a Excel');
            }
        }

        // Descargar plantilla
        // Descargar plantilla MEJORADA
        function downloadTemplate() {
            const wb = XLSX.utils.book_new();

            // Plantilla de usuarios CON ENCABEZADOS CORRECTOS
            const usuariosData = [{
                "responsable": "EJEMPLO: MARIA GONZALEZ",
                "cedula": "EJEMPLO: 12345678",
                "cargo": "EJEMPLO: ANALISTA",
                "sector": "EJEMPLO: SIGAL"
            }];
            const wsUsuarios = XLSX.utils.json_to_sheet(usuariosData);
            XLSX.utils.book_append_sheet(wb, wsUsuarios, "Usuarios");

            // Plantilla de equipos CON ENCABEZADOS CORRECTOS
            const equiposData = [{
                "descripcion": "EJEMPLO: LAPTOP",
                "marca": "EJEMPLO: DELL",
                "modelo": "EJEMPLO: LATITUDE 5420",
                "serial": "EJEMPLO: ABC123XYZ",
                "etiqueta": "EJEMPLO: 28010001",
                "status": "OPERATIVO",
                "observaciones": "EJEMPLO: EQUIPO NUEVO"
            }];
            const wsEquipos = XLSX.utils.json_to_sheet(equiposData);
            XLSX.utils.book_append_sheet(wb, wsEquipos, "Equipos");

            // Plantilla de asignaciones CON ENCABEZADOS CORRECTOS
            const asignacionesData = [{
                "id_usuario": "1",
                "id_equipo": "1",
                "fecha_asignacion": "2024-01-15",
                "estado_asignacion": "EJEMPLO: Asignado"
            }];
            const wsAsignaciones = XLSX.utils.json_to_sheet(asignacionesData);
            XLSX.utils.book_append_sheet(wb, wsAsignaciones, "Asignaciones");

            XLSX.writeFile(wb, "plantilla_inventario.xlsx");
        }

        // Importar desde Excel CORREGIDO
        async function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);

                let importedCount = 0;
                const errors = [];

                // IMPORTAR USUARIOS - CORREGIDO
                if (workbook.Sheets["Usuarios"]) {
                    const usuariosData = XLSX.utils.sheet_to_json(workbook.Sheets["Usuarios"]);
                    console.log("Datos de usuarios le√≠dos:", usuariosData);

                    for (const usuario of usuariosData) {
                        // Verificar que no sea la fila de ejemplo
                        if (usuario.responsable &&
                            !usuario.responsable.includes("EJEMPLO:") &&
                            !usuario.responsable.includes("MARIA GONZALEZ")) {

                            try {
                                await addUser({
                                    responsable: usuario.responsable || "",
                                    cedula: usuario.cedula || "",
                                    cargo: usuario.cargo || "",
                                    sector: usuario.sector || ""
                                });
                                importedCount++;
                                console.log("Usuario importado:", usuario.responsable);
                            } catch (error) {
                                errors.push(`Error en usuario ${usuario.responsable}: ${error.message}`);
                            }
                        }
                    }
                } else {
                    errors.push("No se encontr√≥ la hoja 'Usuarios'");
                }

                // IMPORTAR EQUIPOS - CORREGIDO
                if (workbook.Sheets["Equipos"]) {
                    const equiposData = XLSX.utils.sheet_to_json(workbook.Sheets["Equipos"]);
                    console.log("Datos de equipos le√≠dos:", equiposData);

                    for (const equipo of equiposData) {
                        // Verificar que no sea la fila de ejemplo
                        if (equipo.descripcion &&
                            !equipo.descripcion.includes("EJEMPLO:") &&
                            !equipo.descripcion.includes("LAPTOP")) {

                            try {
                                // Verificar si el serial ya existe
                                const existingEquipment = await getEquipmentBySerial(equipo.serial);
                                if (existingEquipment) {
                                    errors.push(`Serial duplicado: ${equipo.serial}`);
                                    continue;
                                }

                                await addEquipment({
                                    descripcion: equipo.descripcion || "",
                                    marca: equipo.marca || "",
                                    modelo: equipo.modelo || "",
                                    serial: equipo.serial || "",
                                    etiqueta: equipo.etiqueta || "",
                                    status: equipo.status || "OPERATIVO",
                                    observaciones: equipo.observaciones || ""
                                });
                                importedCount++;
                                console.log("Equipo importado:", equipo.descripcion);
                            } catch (error) {
                                errors.push(`Error en equipo ${equipo.descripcion}: ${error.message}`);
                            }
                        }
                    }
                } else {
                    errors.push("No se encontr√≥ la hoja 'Equipos'");
                }

                // IMPORTAR ASIGNACIONES - CORREGIDO (despu√©s de usuarios y equipos)
                if (workbook.Sheets["Asignaciones"]) {
                    // Esperar a que se importen usuarios y equipos primero
                    const [usuarios, equipos] = await Promise.all([
                        getAllUsers(),
                        getAllEquipments()
                    ]);

                    const asignacionesData = XLSX.utils.sheet_to_json(workbook.Sheets["Asignaciones"]);
                    console.log("Datos de asignaciones le√≠dos:", asignacionesData);

                    for (const asignacion of asignacionesData) {
                        // Verificar que no sea la fila de ejemplo
                        if (asignacion.id_usuario && asignacion.id_equipo &&
                            asignacion.id_usuario !== "1" && asignacion.id_equipo !== "1") {

                            try {
                                const idUsuario = parseInt(asignacion.id_usuario);
                                const idEquipo = parseInt(asignacion.id_equipo);

                                // Verificar que existan el usuario y el equipo
                                const usuarioExiste = usuarios.find(u => u.id_usuario === idUsuario);
                                const equipoExiste = equipos.find(e => e.id_equipo === idEquipo);

                                if (!usuarioExiste) {
                                    errors.push(`Usuario ID ${idUsuario} no existe para asignaci√≥n`);
                                    continue;
                                }

                                if (!equipoExiste) {
                                    errors.push(`Equipo ID ${idEquipo} no existe para asignaci√≥n`);
                                    continue;
                                }

                                // Verificar si el equipo ya est√° asignado
                                const existingAssignment = await getAssignmentByEquipment(idEquipo);
                                if (existingAssignment && existingAssignment.estado_asignacion === "Asignado") {
                                    errors.push(`Equipo ID ${idEquipo} ya est√° asignado`);
                                    continue;
                                }

                                await addAssignment({
                                    id_usuario: idUsuario,
                                    id_equipo: idEquipo,
                                    fecha_asignacion: asignacion.fecha_asignacion || new Date().toISOString().split('T')[0],
                                    estado_asignacion: asignacion.estado_asignacion || "Asignado"
                                });
                                importedCount++;
                                console.log("Asignaci√≥n importada:", idUsuario, "->", idEquipo);
                            } catch (error) {
                                errors.push(`Error en asignaci√≥n ${asignacion.id_usuario}-${asignacion.id_equipo}: ${error.message}`);
                            }
                        }
                    }
                } else {
                    errors.push("No se encontr√≥ la hoja 'Asignaciones'");
                }

                // Limpiar input file
                event.target.value = '';

                // Mostrar resultados
                let message = `Importaci√≥n completada. Se importaron ${importedCount} registros.`;
                if (errors.length > 0) {
                    message += `\n\nErrores encontrados:\n${errors.slice(0, 5).join('\n')}`;
                    if (errors.length > 5) {
                        message += `\n... y ${errors.length - 5} errores m√°s.`;
                    }
                }

                alert(message);
                loadAllData();

            } catch (error) {
                console.error('Error importando desde Excel:', error);
                alert('Error al importar los datos desde Excel: ' + error.message);
            }
        }


        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // =============================================
        // INICIALIZACI√ìN COMBINADA
        // =============================================

    document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando Sistema de Inventario PWA...');

    // Solucionar el "flash" de contenido sin estilo
    document.body.style.visibility = 'visible';

    // Inicializar PWA primero (modo b√°sico para GitHub Pages)
    try {
        setupPWA();
        console.log('‚úÖ PWA inicializada (modo b√°sico)');
    } catch (pwaError) {
        console.error('‚ùå Error inicializando PWA:', pwaError);
        updatePWAStatus('‚ùå Error PWA');
    }

    // Inicializar base de datos
    try {
        initDatabase();
        console.log('‚úÖ Base de datos inicializada');
    } catch (dbError) {
        console.error('‚ùå Error inicializando base de datos:', dbError);
    }

    // Configurar funcionalidad offline
    setupOfflineFunctionality();

    // Configurar notificaciones
    setupNotifications();

    console.log('üéâ Sistema de Inventario PWA completamente inicializado');

    // Intentar Service Worker b√°sico despu√©s de la carga inicial
    setTimeout(tryRegisterServiceWorker, 1000);
});

// Manejar el evento antes de descargar la p√°gina
window.addEventListener('beforeunload', function() {
    console.log('üíæ Guardando estado de la aplicaci√≥n...');
    // Aqu√≠ podr√≠as guardar el estado actual si es necesario
});

// Manejar el evento de carga completa
window.addEventListener('load', function() {
    console.log('üìÑ P√°gina completamente cargada');
    updatePWAStatus('‚úÖ PWA Lista');
});
    </script>
</body>

</html>
