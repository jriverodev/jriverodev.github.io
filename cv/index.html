<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CV Studio Pro v2</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='25' fill='%23007AFF'/><path d='M30 35h40M30 50h40M30 65h25' stroke='white' stroke-width='8' stroke-linecap='round'/></svg>">
    <link rel="manifest" id="pwa-manifest">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #007AFF; --dark: #1C1C1E; --bg: #F2F2F7; --card: #FFFFFF; }
        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background-color: var(--bg); margin: 0; padding: 15px; color: var(--dark); display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 600px; padding-bottom: 120px; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.05); }
        .card h3 { margin-top: 0; font-size: 1.1rem; color: var(--primary); border-bottom: 1px solid #F2F2F7; padding-bottom: 10px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1.5px solid #E5E5EA; border-radius: 10px; font-size: 16px; background: #F9F9FB; }
        .btn-add { background: #F2F2F7; color: var(--primary); border: 2px dashed #D1D1D6; width: 100%; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        .item-row { background: #F9F9FB; padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin: 8px 0; border-left: 4px solid var(--primary); }
        .footer-actions { position: fixed; bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); padding: 15px; border-radius: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); width: calc(100% - 30px); max-width: 570px; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; }
        .btn-pdf { background: var(--dark); }
        .preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 10px; border: 1px solid #ddd; }
        .credits { text-align: center; margin-top: 20px; font-size: 0.8rem; color: #8E8E93; }
        .swal-date-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div style="text-align: center; margin-bottom: 25px;">
        <h1 style="color: var(--primary); margin:0;">CV Studio Pro</h1>
    </div>

    <div class="card">
        <h3>ðŸ‘¤ Datos Personales</h3>
        <input type="text" id="nombre" placeholder="Nombre Completo">
        <input type="text" id="cargo" placeholder="ProfesiÃ³n o TÃ­tulo">
        <input type="text" id="telefono" placeholder="ðŸ“± TelÃ©fono">
        <input type="text" id="ubicacion" placeholder="ðŸ“ Ciudad, PaÃ­s">
        <input type="text" id="email" placeholder="âœ‰ï¸ Correo">
    </div>

    <div class="card">
        <h3>ðŸ’¼ Experiencia Laboral</h3>
        <div id="lista-exp"></div>
        <button class="btn-add" onclick="modalExp()">+ AÃ±adir Cargo</button>
    </div>

    <div class="card">
        <h3>ðŸŽ“ EducaciÃ³n</h3>
        <div id="lista-edu"></div>
        <button class="btn-add" onclick="modalEdu()">+ AÃ±adir EducaciÃ³n</button>
    </div>

    <div class="card">
        <h3>ðŸ“‚ Anexos y Documentos</h3>
        <input type="file" id="input-anexos" accept="image/*" multiple onchange="manejarAnexos(this)" style="display: none;">
        <button class="btn-add" onclick="document.getElementById('input-anexos').click()">ðŸ“· Subir TÃ­tulos o Fotos</button>
        <div id="preview-anexos" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;"></div>
    </div>

     <p style="color: #8E8E93;">Desarrollado por: jesus.rivero86@gmail.com</p>

    <div class="footer-actions">
        <button class="btn-main" onclick="generarWord()">Bajar Word</button>
        <button class="btn-main btn-pdf" onclick="generarPDF()">Bajar PDF</button>
    </div>
</div>

<script>
    let cv = { exp: [], edu: [], anexos: [] };
    const { Document, Packer, Paragraph, TextRun, AlignmentType, HeadingLevel, ImageRun, BorderStyle, PageBreak } = docx;

    // Generador de opciones para el selector de fechas
    const getYears = () => {
        let years = "";
        for(let i = new Date().getFullYear(); i >= 1970; i--) years += `<option value="${i}">${i}</option>`;
        return years;
    };
    const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
    const getMonths = () => months.map((m, i) => `<option value="${m}">${m}</option>`).join('');

    // MODAL EXPERIENCIA CON FECHAS INICIO/FIN
    async function modalExp() {
        const { value: v } = await Swal.fire({
            title: 'Detalles del Puesto',
            html: `
                <input id="sw-emp" class="swal2-input" placeholder="Empresa">
                <input id="sw-car" class="swal2-input" placeholder="Cargo">
                <p style="text-align:left; margin:10px 0 0 5px; font-size:0.8rem">Fecha Inicio:</p>
                <div class="swal-date-grid">
                    <select id="sw-mes-in" class="swal2-input">${getMonths()}</select>
                    <select id="sw-ano-in" class="swal2-input">${getYears()}</select>
                </div>
                <p style="text-align:left; margin:10px 0 0 5px; font-size:0.8rem">Fecha Fin:</p>
                <div class="swal-date-grid">
                    <select id="sw-mes-fi" class="swal2-input"><option value="Act">Actualidad</option>${getMonths()}</select>
                    <select id="sw-ano-fi" class="swal2-input"><option value="">-</option>${getYears()}</select>
                </div>
                <textarea id="sw-tar" class="swal2-textarea" placeholder="DescripciÃ³n..."></textarea>
            `,
            confirmButtonColor: '#007AFF',
            preConfirm: () => {
                const fin = document.getElementById('sw-mes-fi').value === 'Act' ? 'Actualidad' : `${document.getElementById('sw-mes-fi').value} ${document.getElementById('sw-ano-fi').value}`;
                return {
                    emp: document.getElementById('sw-emp').value,
                    car: document.getElementById('sw-car').value,
                    periodo: `${document.getElementById('sw-mes-in').value} ${document.getElementById('sw-ano-in').value} â€“ ${fin}`,
                    tar: document.getElementById('sw-tar').value
                }
            }
        });
        if (v && v.emp) { cv.exp.push(v); updateUI('lista-exp', cv.exp, 'emp'); }
    }

    async function modalEdu() {
        const { value: v } = await Swal.fire({
            title: 'EducaciÃ³n',
            html: `
                <input id="sw-tit" class="swal2-input" placeholder="TÃ­tulo obtenido">
                <input id="sw-uni" class="swal2-input" placeholder="InstituciÃ³n">
                <div class="swal-date-grid">
                    <select id="sw-ano-edu" class="swal2-input">${getYears()}</select>
                </div>
            `,
            preConfirm: () => ({
                tit: document.getElementById('sw-tit').value,
                uni: document.getElementById('sw-uni').value,
                fec: document.getElementById('sw-ano-edu').value
            })
        });
        if (v && v.tit) { cv.edu.push(v); updateUI('lista-edu', cv.edu, 'tit'); }
    }

    function manejarAnexos(input) {
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => { cv.anexos.push(e.target.result); renderAnexos(); };
            reader.readAsDataURL(file);
        });
    }

    function renderAnexos() {
        const div = document.getElementById('preview-anexos');
        div.innerHTML = cv.anexos.map((src, i) => `
            <div style="position: relative;">
                <img src="${src}" class="preview-img">
                <span onclick="cv.anexos.splice(${i},1); renderAnexos()" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:20px; height:20px; font-size:12px; line-height:20px; text-align:center; cursor:pointer;">Ã—</span>
            </div>
        `).join('');
    }

    function updateUI(id, arr, key) {
        document.getElementById(id).innerHTML = arr.map(i => `<div class="item-row"><span>${i[key]}</span></div>`).join('');
    }

    async function generarWord() {
        Swal.fire({ title: 'Creando Documento...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const children = [
            new Paragraph({ children: [new TextRun({ text: document.getElementById('nombre').value.toUpperCase(), bold: true, size: 48, font: "Arial" })], alignment: AlignmentType.CENTER }),
            new Paragraph({ children: [new TextRun({ text: document.getElementById('cargo').value.toUpperCase(), size: 24, font: "Arial", color: "666666" })], alignment: AlignmentType.CENTER, spacing: { after: 200 } }),
            new Paragraph({ children: [new TextRun({ text: `${document.getElementById('telefono').value} | ${document.getElementById('email').value}`, size: 18 })], alignment: AlignmentType.CENTER, spacing: { after: 400 } }),
            
            ...createH("EXPERIENCIA"),
            ...cv.exp.flatMap(e => [
                new Paragraph({ children: [new TextRun({ text: `${e.emp.toUpperCase()} | ${e.car}`, bold: true, size: 22 })], spacing: { before: 200 } }),
                new Paragraph({ children: [new TextRun({ text: e.periodo, italic: true, size: 18 })] }),
                new Paragraph({ children: [new TextRun({ text: e.tar, size: 20 })], spacing: { after: 100 } })
            ]),

            ...createH("EDUCACIÃ“N"),
            ...cv.edu.flatMap(e => [
                new Paragraph({ children: [new TextRun({ text: `${e.tit} â€” ${e.uni} (${e.fec})`, bold: true, size: 21 })], spacing: { after: 150 } })
            ])
        ];

        // AGREGAR ANEXOS: CADA UNO EN UNA PÃGINA COMPLETA
        for (const base64 of cv.anexos) {
            children.push(new Paragraph({ children: [new PageBreak()] })); // Salto de pÃ¡gina
            const resp = await fetch(base64);
            const blob = await resp.blob();
            children.push(new Paragraph({
                children: [
                    new ImageRun({
                        data: blob,
                        transformation: { width: 600, height: 800 }, // TamaÃ±o mÃ¡ximo en A4
                    })
                ],
                alignment: AlignmentType.CENTER
            }));
        }

        const doc = new Document({ sections: [{ children }] });
        Packer.toBlob(doc).then(blob => {
            saveAs(blob, "CV_Final_Profesional.docx");
            Swal.fire('Â¡Ã‰xito!', 'Archivo descargado', 'success');
        });
    }

    function createH(t) {
        return [new Paragraph({ children: [new TextRun({ text: t, bold: true, size: 24, color: "007AFF" })], border: { bottom: { color: "007AFF", style: BorderStyle.SINGLE, size: 6 } }, spacing: { before: 400, after: 150 } })];
    }

    function generarPDF() {
        const element = document.body;
        html2pdf().from(element).set({ margin: 10, filename: 'CV_Curriculum.pdf', html2canvas: { scale: 2 } }).save();
    }

    // Manifest Autoinyectado
    const manifest = { name: "CV Maker Pro", short_name: "CVPro", start_url: ".", display: "standalone", background_color: "#F2F2F7", theme_color: "#007AFF", icons: [{ src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='25' fill='%23007AFF'/><path d='M30 35h40M30 50h40M30 65h25' stroke='white' stroke-width='8' stroke-linecap='round'/></svg>", sizes: "512x512", type: "image/svg+xml" }] };
    document.getElementById('pwa-manifest').setAttribute('href', 'data:application/json;base64,' + btoa(JSON.stringify(manifest)));
</script>

</body>
</html>
