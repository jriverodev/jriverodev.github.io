<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro Transporte de Personal - RJ</title>

    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Icon for iOS / fallback -->
    <link rel="apple-touch-icon" href="icon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Select2 (searchable selects) -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Peque√±os ajustes para Select2 dentro de Tailwind */
        .select2-container--default .select2-selection--single {
            height: 44px;
            border-radius: 0.75rem;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 30px;
        }
        .select2-container { width: 100% !important; }
        /* ocultar por defecto el bot√≥n de instalar hasta recibir beforeinstallprompt */
        #btnInstall { display: none; }

        /* Resalte temporal cuando se muestra "Ver" */
        @keyframes highlight {
            0% { box-shadow: 0 0 0 0 rgba(249,115,22,0.25); transform: translateY(-2px); }
            40% { box-shadow: 0 6px 18px rgba(249,115,22,0.18); transform: translateY(0); }
            100% { box-shadow: none; transform: none; }
        }
        .highlight {
            animation: highlight 900ms ease;
            border-radius: 12px;
        }
    </style>

    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- jQuery y Select2 (para selects din√°micos con buscador) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-slate-100 min-h-screen pb-40 font-sans text-slate-800">

    <nav class="bg-blue-900 text-white p-4 shadow-xl sticky top-0 z-50 flex justify-between items-center">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-200">
            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
        </svg>
        <h1 class="font-bold tracking-tight uppercase text-xs">Registro Transporte de Personal</h1>
        <div class="w-8"></div>
    </nav>

    <main class="max-w-3xl mx-auto p-4 space-y-5">

        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="font-bold text-blue-900 mb-4 flex items-center gap-2 text-xs uppercase italic">
                <i class="bi bi-gear-wide-connected text-blue-600"></i> Configuraci√≥n General
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Centro / Taller Seleccionado</label>
                    <select id="taller_sel" onchange="renderLista()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 focus:ring-blue-300">
                        <option>Central Transporte Norte</option>
                        <option>Central Transporte Sur</option>
                        <option>Base Operativa Este</option>
                        <option>Base Operativa Oeste</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 text-blue-600">Fecha del Reporte</label>
                    <input type="date" id="fecha_rep" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold">
                </div>
            </div>
        </div>

        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <h2 class="font-bold text-orange-600 mb-4 flex items-center gap-2 text-xs uppercase italic">
                <i class="bi bi-plus-square-fill"></i> Registrar Servicio
            </h2>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <select id="servicio" class="p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm">
                        <option value="PROPIO">PROPIO</option>
                        <option value="CONTRATADO">CONTRATADO</option>
                    </select>
                    <select id="tipo_unidad" class="p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-sm">
                        <option value="BUS">BUS</option>
                        <option value="AUTOBUS">AUTOB√öS</option>
                        <option value="VAN">VAN</option>
                        <option value="CARRO">CARRO</option>
                        <option value="CAMIONETA">CAMIONETA</option>
                        <option value="MICROBUS">MICROBUS</option>
                        <option value="OTRO">OTRO</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <!-- Select din√°mico con buscador: Organizaci√≥n -->
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Organizaci√≥n</label>
                        <select id="organizacion" class="buscador"></select>
                    </div>

                    <!-- Gerencia dependiente -->
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Gerencia</label>
                        <select id="gerencia" class="buscador"><option value="">Seleccione primero una organizaci√≥n</option></select>
                    </div>
                </div>

                <input type="text" id="unidad" placeholder="N¬∞ de unidad o Placa" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-orange-200 font-bold">
                <input type="text" id="chofer" placeholder="Chofer (Nombre)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-orange-200 font-bold">

                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="fecha_serv" class="p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold" onchange="rellenarDiaMes()">
                    <input type="number" id="cantidad" placeholder="Cantidad de pasajeros" class="p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="contacto_directo" placeholder="Contacto directo (Nombre)" class="p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold">
                    <input type="tel" id="contacto" placeholder="Tel√©fono de contacto" class="p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold">
                </div>

                <input type="text" id="descripcion" placeholder="Descripci√≥n del servicio" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-orange-200 font-bold">

                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="origen" placeholder="Origen" class="p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                    <input type="text" id="destino" placeholder="Destino" class="p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                </div>

                <textarea id="observacion" placeholder="Observaci√≥n" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none"></textarea>

                <div class="grid grid-cols-3 gap-3">
                    <button onclick="guardarRegistro()" class="bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-600 transition shadow-lg uppercase text-xs py-3">Guardar Registro</button>
                    <button onclick="limpiarDB()" class="text-red-500 border border-red-200 rounded-xl font-bold uppercase text-xs py-3">Limpiar Base</button>
                    <button onclick="migrarDesdeAntiguo()" class="text-slate-700 border border-slate-200 rounded-xl font-bold uppercase text-xs py-3">Migrar desde v5 (opcional)</button>
                </div>
            </div>
        </div>

        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-black text-slate-400 text-[10px] uppercase tracking-widest italic">Registros del Centro</h2>
                <span id="cont_total" class="bg-blue-600 text-white px-3 py-0.5 rounded-full text-[10px] font-bold tracking-tighter uppercase">0 REG.</span>
            </div>
            <div id="lista_unidades" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
        </div>

        <footer class="text-center py-6 border-t border-slate-200">
            <p class="text-[10px] font-black text-slate-400 tracking-[0.2em] uppercase">Desarrollado por RIVEROJDU</p>
        </footer>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/95 backdrop-blur-md border-t border-slate-200 grid grid-cols-5 gap-3 z-50 shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
            <button onclick="exportarExcel(false)" class="flex items-center justify-center gap-2 bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Exportar Excel (Filtro)</button>
            <button onclick="exportarExcel(true)" class="flex items-center justify-center gap-2 bg-sky-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Exportar Excel (Todo)</button>
            <button onclick="enviarWhatsApp(false)" class="flex items-center justify-center gap-2 bg-emerald-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Enviar WhatsApp (Filtro)</button>
            <button onclick="enviarWhatsApp(true)" class="flex items-center justify-center gap-2 bg-sky-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Enviar WhatsApp (Todo)</button>
            <button id="btnInstall" class="flex items-center justify-center gap-2 bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg">Instalar App</button>
        </div>

    </main>

    <script>
        // PWA: beforeinstallprompt
        let deferredPrompt = null;
        const btnInstall = document.getElementById('btnInstall');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            btnInstall.style.display = 'flex';
        });

        btnInstall.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const choice = await deferredPrompt.userChoice;
            deferredPrompt = null;
            btnInstall.style.display = 'none';
        });

        window.addEventListener('appinstalled', () => {
            btnInstall.style.display = 'none';
        });

        // Service Worker registration (sw.js in the same folder)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(reg => {
                console.log('Service worker registrado:', reg.scope);
            }).catch(err => {
                console.warn('No se pudo registrar el service worker:', err);
            });
        }

        // THEME COLORS (ajustables)
        const THEME_ORANGE = '#fb923c'; // soft orange
        const THEME_ORANGE_DARK = '#f97316'; // for confirm buttons
        const THEME_BLUE = '#0369a1'; // deep blue

        // --- SweetAlert2: helpers responsive y tema (m√≥vil/tablet/desktop) ---
        function getToastPosition() {
            // Prefer bottom in portrait (mobile), top-end in landscape/desktop
            try {
                const isPortrait = window.matchMedia && window.matchMedia("(orientation: portrait)").matches;
                if (isPortrait || window.innerWidth <= 480) return 'bottom';
                return 'top-end';
            } catch (e) {
                return window.innerWidth <= 768 ? 'bottom' : 'top-end';
            }
        }

        function ToastInstance() {
            return Swal.mixin({
                toast: true,
                position: getToastPosition(),
                showConfirmButton: false,
                timer: 1800,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
        }

        function confirmDialog(options = {}) {
            // Theme: confirm naranja, cancel azul (coherente con UI)
            return Swal.fire(Object.assign({
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'S√≠',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: THEME_ORANGE_DARK,
                cancelButtonColor: THEME_BLUE,
                reverseButtons: false
            }, options));
        }

        // Escuchar cambios de orientaci√≥n/tama√±o para que el Toast use la nueva posici√≥n
        window.addEventListener('orientationchange', () => { /* no-op: nueva instancia ToastInstance() leer√° getToastPosition() */ });
        window.addEventListener('resize', () => { /* idem */ });

        // --- El resto del script mantiene la funcionalidad previa ---
        const DB_KEY = 'db_transporte_v1';
        let baseDatos = JSON.parse(localStorage.getItem(DB_KEY) || '[]');

        const diasES = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
        const mesesES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

        // dataMaster (organizaci√≥n -> gerencias).
        const dataMaster = {
            "BARIVEN": ["ADMINISTRACION Y SERVICIOS", "ADMON. Y GESTION", "ALMACEN BACHAQUERO", "ALMACEN DISTRIBUCION YAGUA", "ALMACEN DTTO ANACO", "ALMACEN DTTO PUNTA DE MATA", "ALMACEN GAS LA QUIZAN..."],
            "CVP": ["DG INTERNACIONAL", "GERENCIA DE ASUNTOS JURIDICOS", "GERENCIA DE ASUNTOS PUBLICOS", "GERENCIA DE EVALUACION, DESARROLLO Y SEGUIMIENTO D", "GERENCIA DE FINANZAS", "GERENCIA DE INGE..."],
            "DESI": ["BARIVEN", "COMERCIO Y SUMINISTRO", "CONFIABILIDAD OPERACIONAL", "CVP", "DESARROLLO URBANO", "DESPACHO", "DISTRIBUCION", "DIVISION CARABOBO", "EXPLORACION", "EYP FAJA", "EYP LOS L..."],
            "DEPOCC": ["AMBIENTE", "ASUNTOS JURIDICOS", "ASUNTOS PUBLICOS", "CONFIABILIDAD OPERACIONAL", "CONTRATACION", "COORDINACION OPERACIONAL", "COSTA AFUERA", "DESARROLLO SOCIAL", "DIRECCION ADJ..."],
            "DIRECCION EJECUTIVA CYSN": ["ATENCION Y SERVICIOS AL USUARIO", "DESARROLLO SOCIAL", "DIVISION AYACUCHO", "ENFERMERIA", "ESTACIONES DE SERVICIO", "FINANZAS", "GCIA. CORP. LINEA DE GESTION ..."],
            "EM BARIPETROL": ["ASUNTOS PUBLICOS", "CONTRATACIONES", "FINANZAS", "INGENIERIA DE COSTOS", "LEGAL", "OPERACIONES DE PRODUCCION", "PLANIFICACION", "PRESIDENCIA", "PROCURA", "RECURSOS HUMAN..."],
            "EM LAGOPETROL": ["ASUNTOS PUBLICOS", "CONTRATACIONES", "FINANZAS", "GERENCIA GENERAL", "LEGAL", "OPERACIONES DE PRODUCCION", "PLANIFICACION", "PRESIDENCIA", "PROCURA", "RECURSOS HUMANOS", "..."],
            "EM PETROBOSCAN": ["ADMINISTRACION Y FINANZAS", "ASUNTOS PUBLICOS", "CONTRATACIONES", "DESARROLLO SOCIAL", "INGENIERIA DE COSTOS", "INVERSION SOCIAL", "LEGAL", "PLANIFICACION", "PROCURA", "..."],
            "EM PETROPIAR": ["ADMINISTRACION", "ADMINISTRACION Y FINANZAS", "ASUNTOS PUBLICOS", "CONTRATACIONES", "DESARROLLO SOCIAL", "FINANZAS", "GERENCIA GENERAL", "INGENIERIA DE COSTOS", "LEGAL", "..."],
            "EM PETROZAMORA": ["ASUNTOS PUBLICOS", "CONTRATACIONES", "FINANZAS", "GERENCIA GENERAL", "LEGAL", "LOGISTICA", "OPERACIONES", "PLANIFICACION", "PRESIDENCIA", "PROCURA", "RECURSOS HUMANOS", "..."],
            "INTEVEP": ["ADMINISTRACION Y FINANZAS", "ASUNTOS JURIDICOS", "CALIDAD DE GESTION", "CONTROL DE GESTION", "DESARROLLO SOCIAL", "FINANZAS", "GERENCIA DE RECURSOS HUMANOS", "INVESTIGACION", "..."],
            "PDVSA GAS": ["GASIFICACION", "HABILITADORA", "LEGALES", "OPERACIONES Y MTTO DE PLANTAS", "PRESIDENCIA", "PROCESAMIENTO", "PRODUCCION", "PRODUCCION COSTA AFUERA", "TRANSPORTE Y DISTRIBUCIO..."],
            "PETROQUIMICA DE VENEZUELA, S.A": ["ADMINISTRACION", "ADUANA", "AMBIENTE", "ASUNTOS JURIDICOS", "ASUNTOS PUBLICOS", "AUDITORIA", "COMERCIALIZACION", "CONTABILIDAD", "CONTROL DE GESTION", "..."]
        };

        // Inicializaci√≥n cuando carga la p√°gina (espera a que Select2 est√© listo)
        $(document).ready(function() {
            // Inicializar selects con Select2
            $('#organizacion').select2({ placeholder: 'Escriba para buscar organizaci√≥n...' });
            $('#gerencia').select2({ placeholder: 'Seleccione primero una organizaci√≥n' });

            // Cargar Organizaciones en orden alfab√©tico
            const $org = $('#organizacion');
            Object.keys(dataMaster).sort().forEach(org => {
                $org.append(new Option(org, org));
            });

            // Evento: cuando cambie organizaci√≥n, rellenar gerencias
            $org.on('change', function() {
                const seleccion = $(this).val();
                const $ger = $('#gerencia');
                $ger.empty();

                if (!seleccion) {
                    $ger.append(new Option("Seleccione primero una organizaci√≥n", ""));
                } else if (dataMaster[seleccion]) {
                    const gerencias = dataMaster[seleccion].slice().sort();
                    gerencias.forEach(g => $ger.append(new Option(g, g)));
                }

                // Refresh Select2
                $ger.trigger('change.select2');
            });

            // Inicializar fechas y lista
            document.getElementById('fecha_rep').valueAsDate = new Date();
            document.getElementById('fecha_serv').valueAsDate = new Date();
            renderLista();
        });

        function rellenarDiaMes(){
            // No muestra directamente, se utiliza al guardar
        }

        async function guardarRegistro(){
            const servicio = document.getElementById('servicio').value;
            const organizacion = $('#organizacion').val() || '';
            const gerenciaSel = $('#gerencia').val() || '';
            const gerencia = (organizacion ? organizacion + ' - ' : '') + gerenciaSel;
            const descripcion = document.getElementById('descripcion').value;
            const origen = document.getElementById('origen').value.trim();
            const destino = document.getElementById('destino').value.trim();
            const unidad = document.getElementById('unidad').value.trim();
            const chofer = document.getElementById('chofer').value.trim();
            const fecha = document.getElementById('fecha_serv').value;
            const tipo_unidad = document.getElementById('tipo_unidad').value;
            const contacto_directo = document.getElementById('contacto_directo').value.trim();
            const contacto = document.getElementById('contacto').value.trim();
            const cantidad = document.getElementById('cantidad').value || 0;
            const observacion = document.getElementById('observacion').value;

            if(!unidad || !chofer || !fecha) {
                await Swal.fire({
                    icon: 'warning',
                    title: 'Campos incompletos',
                    text: 'Por favor complete: N¬∞ unidad/placa, Chofer y Fecha.',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: THEME_BLUE
                });
                return;
            }

            const d = new Date(fecha + 'T00:00:00');
            const dia = diasES[d.getDay()];
            const mes = mesesES[d.getMonth()];

            const registro = {
                id: Date.now(),
                centro: document.getElementById('taller_sel').value,
                servicio,
                gerencia,
                descripcion,
                origen,
                destino,
                unidad,
                chofer,
                fecha,
                dia,
                mes,
                tipo_unidad,
                contacto_directo,
                contacto,
                cantidad: Number(cantidad),
                observacion
            };
            baseDatos.push(registro);
            localStorage.setItem(DB_KEY, JSON.stringify(baseDatos));

            // Limpiar campos
            document.getElementById('unidad').value = '';
            document.getElementById('chofer').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('origen').value = '';
            document.getElementById('destino').value = '';
            document.getElementById('observacion').value = '';
            document.getElementById('contacto_directo').value = '';
            document.getElementById('contacto').value = '';
            document.getElementById('cantidad').value = '';

            // Renderizar y mostrar toast con acci√≥n "Ver"
            renderLista();

            const toastResult = await Swal.fire({
                title: 'Registro guardado',
                toast: true,
                position: getToastPosition(),
                showConfirmButton: true,
                confirmButtonText: 'Ver',
                timer: 5000,
                timerProgressBar: true,
                confirmButtonColor: THEME_ORANGE_DARK,
                showCloseButton: true,
                didOpen: (el) => {
                    el.addEventListener('mouseenter', Swal.stopTimer);
                    el.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });

            if (toastResult.isConfirmed) {
                // Desplazarse al registro creado y resaltar
                const el = document.getElementById('reg-' + registro.id);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('highlight');
                    setTimeout(() => el.classList.remove('highlight'), 900);
                }
            } else {
                // peque√±o toast de confirmaci√≥n si no se presion√≥ ver
                ToastInstance().fire({ icon: 'success', title: 'Registro guardado' });
            }
        }

        function construirFiltrados(all = false){
            if(all) return baseDatos.slice();
            const centro = document.getElementById('taller_sel').value;
            return baseDatos.filter(r => r.centro === centro);
        }

        function renderLista(){
            const cont = document.getElementById('lista_unidades');
            const filtrados = construirFiltrados(false);
            document.getElementById('cont_total').innerText = filtrados.length + ' REG.';
            if(filtrados.length === 0){
                cont.innerHTML = `<p class="text-slate-400 text-center text-[11px] py-10 italic">No hay registros en este centro.</p>`;
                return;
            }

            cont.innerHTML = filtrados.slice().reverse().map(u => `
                <div id="reg-${u.id}" class="p-4 bg-slate-50 border border-slate-100 rounded-2xl relative">
                    <button onclick="eliminar(${u.id})" class="absolute top-3 right-3 text-slate-400"><i class="bi bi-trash-fill"></i></button>
                    <p class="font-bold text-xs text-blue-900 uppercase">${u.unidad} ‚Äî ${u.tipo_unidad}</p>
                    <p class="text-[11px] text-slate-600 mb-1">${u.descripcion || ''}</p>
                    <p class="text-[11px] text-slate-500 mb-1">Origen: <span class="font-bold text-slate-700">${u.origen || '-'}</span> ‚Üí Destino: <span class="font-bold text-slate-700">${u.destino || '-'}</span></p>
                    <div class="text-[11px] text-slate-600 mb-2">Chofer: <span class="font-bold text-slate-800">${u.chofer}</span> ‚Ä¢ Pasajeros: ${u.cantidad}</div>
                    <div class="flex items-center gap-2 text-[11px]">
                        <span class="px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 text-[10px]">${u.servicio}</span>
                        <span class="px-2 py-1 rounded-full bg-sky-100 text-sky-700 text-[10px]">${u.gerencia}</span>
                        <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 text-[10px]">${u.dia} ‚Ä¢ ${u.fecha}</span>
                    </div>
                    ${u.observacion ? `<p class="mt-2 text-[11px] text-slate-500">Observaci√≥n: ${u.observacion}</p>` : ''}
                </div>
            `).join('');
        }

        async function eliminar(id){
            const res = await confirmDialog({
                title: 'Eliminar registro',
                text: '¬øEliminar este registro?'
            });
            if(!res.isConfirmed) return;
            baseDatos = baseDatos.filter(r => r.id !== id);
            localStorage.setItem(DB_KEY, JSON.stringify(baseDatos));
            ToastInstance().fire({ icon: 'success', title: 'Registro eliminado' });
            renderLista();
        }

        async function limpiarDB(){
            const res = await confirmDialog({
                title: 'Borrar todos los registros',
                text: '¬øBorrar todos los registros?'
            });
            if(res.isConfirmed){
                baseDatos = [];
                localStorage.removeItem(DB_KEY);
                renderLista();
                ToastInstance().fire({ icon: 'success', title: 'Base de datos borrada' });
            }
        }

        function exportarExcel(all = false){
            const data = construirFiltrados(all);
            if(data.length === 0) {
                Swal.fire({ icon: 'info', title: 'Sin datos', text: 'No hay datos para exportar.', confirmButtonColor: THEME_BLUE });
                return;
            }

            const headers = [
                'SERVICIOS',
                'GERENCIA',
                'DESCRIPCION',
                'ORIGEN',
                'DESTINO',
                'N¬∞ DE UNIDAD O PLACA',
                'CHOFER',
                'FECHA',
                'DIA',
                'MES',
                'TIPO DE UNIDAD',
                'CONTACTO DIRECTO',
                'CONTACTO',
                'CANTIDAD DE USUARIOS O PASAJEROS',
                'OBSERVACION'
            ];

            const rows = data.map(r => ({
                'SERVICIOS': r.servicio,
                'GERENCIA': r.gerencia,
                'DESCRIPCION': r.descripcion || '',
                'ORIGEN': r.origen || '',
                'DESTINO': r.destino || '',
                'N¬∞ DE UNIDAD O PLACA': r.unidad,
                'CHOFER': r.chofer,
                'FECHA': r.fecha,
                'DIA': r.dia,
                'MES': r.mes,
                'TIPO DE UNIDAD': r.tipo_unidad,
                'CONTACTO DIRECTO': r.contacto_directo || '',
                'CONTACTO': r.contacto || '',
                'CANTIDAD DE USUARIOS O PASAJEROS': r.cantidad || 0,
                'OBSERVACION': r.observacion || ''
            }));

            const ws = XLSX.utils.json_to_sheet(rows, {header: headers});
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Registros');

            const hoy = new Date();
            const y = hoy.getFullYear();
            const m = String(hoy.getMonth()+1).padStart(2,'0');
            const d = String(hoy.getDate()).padStart(2,'0');
            const nombre = `registros-transporte-${y}${m}${d}.xlsx`;
            XLSX.writeFile(wb, nombre);

            // Toast para confirmar la descarga (√∫til en m√≥viles)
            ToastInstance().fire({ icon: 'success', title: 'Excel descargado' });
        }

        // Construye mensaje estilo plantilla para un registro (formato WhatsApp)
        function construirMensajeWhatsAppRegistro(r) {
            // Fecha dd/mm/yyyy
            const parts = r.fecha.split('-');
            const fechaFmt = parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : r.fecha;
            const contactoUsuario = r.contacto_directo ? `${r.contacto_directo} (${r.contacto || 's/n'})` : (r.contacto ? r.contacto : '');
            const lines = [];
            lines.push('*SERVICIO EVENTUAL*');
            lines.push('Gerencia de Transporte Terrestre.\n');
            lines.push(`*üìÜ Fecha:* ${fechaFmt}`);
            lines.push(`*‚ñ™Ô∏è D√≠a:* ${r.dia}`);
            lines.push(`*‚ñ™Ô∏èTipo de servicio ( Propio o contratado):* ${capitalize(r.servicio)}`);
            lines.push(`*‚ñ™Ô∏èGerencia:* ${r.gerencia}`);
            lines.push(`*‚ñ™Ô∏èTipo de Unidad:* ${r.tipo_unidad}`);
            lines.push(`*‚ñ™Ô∏èN¬∞ de Unidad:* ${r.unidad}`);
            lines.push(`*‚ñ™Ô∏èCh√≥fer:* ${r.chofer}`);
            lines.push(`*‚ñ™Ô∏èContacto:* ${r.contacto || ''}`);
            if (r.origen) lines.push(`*‚ñ™Ô∏èOrigen:* ${r.origen}`);
            if (r.destino) lines.push(`*‚ñ™Ô∏èDestino:* ${r.destino}`);
            if(contactoUsuario) lines.push(`*üìûContacto de usuario:* ${contactoUsuario}`);
            lines.push('\n*üìù Descripci√≥n:* ' + (r.descripcion || ''));
            lines.push('\n*üë•Cantidad de Usuarios:* ' + (r.cantidad || 0));
            lines.push('\n*üîéObservaci√≥n:* ' + (r.observacion || ''));
            return lines.join('\n');
        }

        function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase(); }

        // Enviar por WhatsApp (concatena mensajes si hay varios)
        function enviarWhatsApp(all = false){
            const data = construirFiltrados(all);
            if(data.length === 0) {
                Swal.fire({ icon: 'info', title: 'Sin datos', text: 'No hay datos para enviar.', confirmButtonColor: THEME_BLUE });
                return;
            }
            // Si hay m√∫ltiples registros, los unimos con separador claro
            const mensajes = data.map(r => construirMensajeWhatsAppRegistro(r));
            const mensajeFinal = mensajes.join('\n\n-----------------\n\n');
            const url = `https://wa.me/?text=${encodeURIComponent(mensajeFinal)}`;
            window.open(url, '_blank');

            // Aviso corto (toast) para indicar que se abri√≥ WhatsApp
            ToastInstance().fire({ icon: 'success', title: 'WhatsApp abierto' });
        }

        // Migraci√≥n de datos desde la key antigua db_reportes_v5 (bot√≥n opcional)
        async function migrarDesdeAntiguo(){
            const confirmacion = await confirmDialog({
                title: 'Migrar datos',
                text: '¬øMigrar datos desde la versi√≥n antigua (db_reportes_v5) a la nueva base local?',
                icon: 'question',
                confirmButtonText: 'S√≠, migrar'
            });
            if(!confirmacion.isConfirmed) return;
            const oldKey = 'db_reportes_v5';
            const old = JSON.parse(localStorage.getItem(oldKey) || '[]');
            if (!old.length) {
                Swal.fire({ icon: 'info', title: 'No hay datos', text: 'No se encontraron datos en la versi√≥n antigua.', confirmButtonColor: THEME_BLUE });
                return;
            }

            // Mapear y preparar migraci√≥n, mantener lista de nuevos IDs
            const migrated = old.map(item => {
                const fecha = item.fecha || (new Date(item.id || Date.now())).toISOString().slice(0,10);
                const d = new Date(fecha + 'T00:00:00');
                return {
                    id: item.id || Date.now() + Math.floor(Math.random()*1000),
                    centro: item.taller || item.centro || 'Central Transporte Norte',
                    servicio: item.servicio || 'PROPIO',
                    gerencia: (item.organizacion ? item.organizacion + ' - ' : '') + (item.gerencia || 'Gerencia 1'),
                    descripcion: item.accion || item.descripcion || '',
                    origen: item.origen || item.origin || '',
                    destino: item.destino || '',
                    unidad: item.nombre || item.unidad || '',
                    chofer: item.chofer || '',
                    fecha: fecha,
                    dia: diasES[d.getDay()],
                    mes: mesesES[d.getMonth()],
                    tipo_unidad: item.tipo_unidad || 'OTRO',
                    contacto_directo: item.contacto_directo || '',
                    contacto: item.contacto || '',
                    cantidad: Number(item.cantidad || 0),
                    observacion: item.observacion || ''
                };
            });

            const existing = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            const merged = existing.concat(migrated);
            localStorage.setItem(DB_KEY, JSON.stringify(merged));
            baseDatos = merged;
            renderLista();

            // Mostrar modal con contador y opci√≥n "Ver √∫ltimos n"
            const totalAdded = migrated.length;
            const mostrarMax = Math.min(10, totalAdded);
            const result = await Swal.fire({
                title: 'Migraci√≥n completada',
                html: `<p>Se a√±adieron <strong>${totalAdded}</strong> registros.</p>`,
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: `Ver √∫ltimos ${mostrarMax}`,
                cancelButtonText: 'Cerrar',
                confirmButtonColor: THEME_ORANGE_DARK,
                cancelButtonColor: THEME_BLUE
            });

            if (result.isConfirmed) {
                // Seleccionar √∫ltimos 'mostrarMax' IDs (ya que se a√±adieron al final de merged, y renderLista muestra reverse())
                const lastMigrated = migrated.slice(-mostrarMax);
                // Scroll al primero (m√°s antiguo de los √∫ltimos) para que se vean en contexto
                const firstId = lastMigrated[0] ? lastMigrated[0].id : null;
                if (firstId) {
                    const el = document.getElementById('reg-' + firstId);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                // A√±adir highlight a cada uno de los √∫ltimos
                lastMigrated.forEach(item => {
                    const node = document.getElementById('reg-' + item.id);
                    if (node) {
                        node.classList.add('highlight');
                        setTimeout(() => node.classList.remove('highlight'), 900);
                    }
                });
                ToastInstance().fire({ icon: 'success', title: `Mostrando √∫ltimos ${mostrarMax}` });
            } else {
                ToastInstance().fire({ icon: 'info', title: `${totalAdded} registros a√±adidos` });
            }
        }
    </script>
</body>
</html>
